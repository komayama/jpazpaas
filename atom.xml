<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan PaaS Support Team Blog</title>
  
  <subtitle>日本マイクロソフトの App Service, Service Bus, Service Fabric, Communication Services に関するサポート情報のブログです。サポートエンジニアがもつ知見や経験事例をご紹介していきます。</subtitle>
  <link href="https://komayama.github.io/jpazpaas/atom.xml" rel="self"/>
  
  <link href="https://komayama.github.io/jpazpaas/"/>
  <updated>2026-02-24T04:33:03.154Z</updated>
  <id>https://komayama.github.io/jpazpaas/</id>
  
  <author>
    <name>Web Developer Platform WebApps Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>プライベートエンドポイント経由で Azure ポータルから Azure AI Search にアクセスした際に &quot;Failed to fetch&quot; が表示される場合の対処方法</title>
    <link href="https://komayama.github.io/jpazpaas/2026/02/17/How-to-resolve-failed-to-fetch-on-azure-ai-search-when-using-private-endpoint.html"/>
    <id>https://komayama.github.io/jpazpaas/2026/02/17/How-to-resolve-failed-to-fetch-on-azure-ai-search-when-using-private-endpoint.html</id>
    <published>2026-02-24T04:35:24.425Z</published>
    <updated>2026-02-24T04:33:03.154Z</updated>
    
    <content type="html"><![CDATA[<p>Azure AI Search サービスでパブリック ネットワーク アクセスを無効化し、プライベート エンドポイント経由のみでアクセス可能な構成としています。</p><p>この状態で Azure ポータルの Azure AI Search から</p><ul><li>「インデックス」</li><li>「インデクサー」</li><li>「データソース」</li><li>「スキルセット」</li></ul><p>などの画面で、次のようなエラーが表示されます。</p><ul><li><strong>「インデックスの一覧の読み込み中にエラーが発生しました」</strong></li><li>概要欄のエラーメッセージに <strong>“Failed to fetch”</strong></li></ul><p><img src="/jpazpaas/2026/02/17/How-to-resolve-failed-to-fetch-on-azure-ai-search-when-using-private-endpoint/image-e35b4520-5f43-4e98-98ab-e46b675e9c51.png" alt="インデックスの一覧の読み込み中にエラーが発生"></p><p>ネットワークや DNS は問題なく、VM から <code>curl</code> や SDK 経由で AI Search エンドポイントへは正常に到達できています。<br>このようなケースでは何が原因で、どのように対処すればよいでしょうか？</p><hr><h1 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答</h1><p>この事象はAzure ポータルから Azure AI Search 内部 API を呼び出す際、<strong>ブラウザ側のローカル ネットワーク アクセス制限機能により通信がブロックされる</strong>ことが原因で発生する可能性があります。</p><p>これにより、Azure ポータルのデータ取得 API が実行されず “Failed to fetch” が返る状況が発生します。</p><hr><h2 id="発生しやすいケース"><a href="#発生しやすいケース" class="headerlink" title="発生しやすいケース"></a>発生しやすいケース</h2><ul><li>Azure AI Search へのアクセスが <strong>Private Endpoint 経由のみ許可</strong>されている  </li><li>同一環境でもユーザーによって再現したりしなかったりする（＝ブラウザの個別設定差による）</li></ul><hr><h2 id="対処方法"><a href="#対処方法" class="headerlink" title="対処方法"></a>対処方法</h2><p>Azure ポータル (portal.azure.com) に対して、ブラウザ側のローカル ネットワーク アクセスを許可する。</p><h3 id="Microsoft-Edge-を利用する場合の対応"><a href="#Microsoft-Edge-を利用する場合の対応" class="headerlink" title="Microsoft Edge を利用する場合の対応"></a>Microsoft Edge を利用する場合の対応</h3><p>エラーが発生する画面において、以下の設定を実施する<br>        <img src="/jpazpaas/2026/02/17/How-to-resolve-failed-to-fetch-on-azure-ai-search-when-using-private-endpoint/==image_0==-a8a2a9af-c36e-4545-bf41-d6461f53dcc5.png" alt="Microsoft Edge のローカル ネットワーク アクセスを許可する"> </p><h3 id="Google-Chrome-を利用する場合の対応"><a href="#Google-Chrome-を利用する場合の対応" class="headerlink" title="Google Chrome を利用する場合の対応"></a>Google Chrome を利用する場合の対応</h3><p>エラーが発生する画面において、以下の設定を実施する<br>        <img src="/jpazpaas/2026/02/17/How-to-resolve-failed-to-fetch-on-azure-ai-search-when-using-private-endpoint/==image_0==-cb60a7ca-420f-4a3f-b7ed-3f1c7659d723.png" alt="Google Chrome のローカル ネットワーク アクセスを許可する"> </p><hr><h1 id="参考ドキュメント"><a href="#参考ドキュメント" class="headerlink" title="参考ドキュメント"></a>参考ドキュメント</h1><p><a href="https://learn.microsoft.com/ja-jp/azure/search/service-create-private-endpoint#use-the-azure-portal-to-access-a-private-search-service">安全な接続のためにプライベート エンドポイントを作成する - Azure AI Search | Microsoft Learn</a><br><br><br><br></p><hr><br><br><p>2026 年 02 月 17 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Azure AI Search サービスでパブリック ネットワーク アクセスを無効化し、プライベート エンドポイント経由のみでアクセス可能な構成としています。&lt;/p&gt;
&lt;p&gt;この状態で Azure ポータルの Azure AI Search から&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;</summary>
      
    
    
    
    
    <category term="AI Search" scheme="https://komayama.github.io/jpazpaas/tags/AI-Search/"/>
    
  </entry>
  
  <entry>
    <title>Azure Communication Services Email クォータ緩和について</title>
    <link href="https://komayama.github.io/jpazpaas/2026/01/27/ACS-Email-quota-increase.html"/>
    <id>https://komayama.github.io/jpazpaas/2026/01/27/ACS-Email-quota-increase.html</id>
    <published>2026-01-26T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.153Z</updated>
    
    <content type="html"><![CDATA[<p>お世話になっております。Azure Communication Services サポート担当の押田です。</p><p>Azure Communication Services で Email を送信には規定でクォータが設けられております。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/service-limits#email">Azure Communication Services のサービス制限 - An Azure Communication Services article</a></p><blockquote><p>送信できる電子メール メッセージの数には制限があります。 サブスクリプションに応じた<a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/service-limits#rate-limits-for-email">メールのレート制限</a>を超えた場合、要求が拒否されます。 再試行までの時間が経過した後に、これらの要求をもう一度試すことができるようになります。 必要に応じて、送信ボリュームの制限を引き上げるリクエストを行って、制限に達する前に対処してください。</p></blockquote><p>クォータの緩和はサポートリクエストを起票いただき申請いただく必要がございます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/email/email-quota-increase">メール ドメインのクォータの引き上げ - An Azure Communication Services concept document</a></p><p>クォータの引き上げは申請いただいた内容ならびに、当該リソースの状況に応じて審査されます。</p><p><a href="https://azure.github.io/jpazpaas/2025/09/08/ACS-Email-Onboarding-FAQ.html#%E9%80%81%E4%BF%A1%E6%95%B0%E3%81%AE%E5%88%B6%E9%99%90%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">Azure Communication Services メール機能でよく頂くご質問 - Japan PaaS Support Team Blog</a> にて、クォータ引き上げに関する FAQ を記載させていただいております。</p><p>この記事ではクォータの引き上げの際に弊社よりお伺いする情報や、申請が却下される要因について補足します。<br>なお、具体的な審査内容は公開されておりません。この記事で記載する項目がすべてではございませんことご了承くださいませ。</p><blockquote><p>メール クォータの引き上げ要求は自動的に承認されません。 レビュー チームは、承認の状態を決定するときに、送信者の全体的な評判を考慮します。 送信者の評判には、メール配信の失敗率、ドメインの評判、スパムや不正使用のレポートなどの要因が含まれます。</p></blockquote><h1 id="クォータ緩和審査の対策"><a href="#クォータ緩和審査の対策" class="headerlink" title="クォータ緩和審査の対策"></a>クォータ緩和審査の対策</h1><h2 id="ドメインの信頼性の維持"><a href="#ドメインの信頼性の維持" class="headerlink" title="ドメインの信頼性の維持"></a>ドメインの信頼性の維持</h2><h3 id="カスタムドメインの管理"><a href="#カスタムドメインの管理" class="headerlink" title="カスタムドメインの管理"></a>カスタムドメインの管理</h3><p>クォータの緩和対象はカスタムドメインのみとなります。申請にあったってはカスタムドメインを構成ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/quickstarts/email/add-custom-verified-domains?pivots=platform-azp">カスタム検証済みメール ドメインを追加する - An Azure Communication Services article</a></p><ul><li><a href="https://azure.github.io/jpazpaas/2025/09/08/ACS-Email-Onboarding-FAQ.html">Azure Communication Services メール機能でよく頂くご質問 - Japan PaaS Support Team Blog</a> <blockquote><ul><li>送信数の制限は引き上げられますか？</li></ul></blockquote></li></ul><h3 id="カスタムドメインがブラックリストへの登録されていないこと"><a href="#カスタムドメインがブラックリストへの登録されていないこと" class="headerlink" title="カスタムドメインがブラックリストへの登録されていないこと"></a>カスタムドメインがブラックリストへの登録されていないこと</h3><p>メール送信に用いるドメインが、RBLに登録されていないことが求められます。<br>下記は外部サービスとなりますが、指定したドメインがブラックリスト登録されているかどうかを確認できるサイトとなります。</p><p><a href="https://multirbl.valli.org/lookup/0410mail1.t-oshida.org.html">MultiRBL.valli.org - Results of the query 0410mail1.t-oshida.org</a></p><p>もし、いずれかのリストにお客様の指定したドメインが登録されている場合、当該のリストを管理されているベンダーにお問い合わせいただき、解除の対応を進めていただく必要がございます。</p><p>以下の例では <code>0410mail1.t-oshida.org</code> はいずれのブラックリストにも登録されていないことが確認できます。</p><p><img src="/jpazpaas/2026/01/27/ACS-Email-quota-increase/image-c4655fff-b877-49b2-ba98-b2e8c942946f.png" alt="image-c4655fff-b877-49b2-ba98-b2e8c942946f.png"></p><h3 id="MX-レコードの登録"><a href="#MX-レコードの登録" class="headerlink" title="MX レコードの登録"></a>MX レコードの登録</h3><p>MX レコードを登録することで送信者ドメインの評判を向上に寄与します。</p><p>Azure Communication Serviceにおいて、カスタムドメイン利用時(<a href="https://azure.github.io/jpazpaas/2023/07/06/How-to-add-domain-to-Email-Communication-Service.html">メール通信サービスにドメインを追加する際の DNS 設定について - Japan PaaS Support Team Blog</a>)に MX レコードの登録は必須ではございませんが、<br>Azure Communication Service から送信されたメールを受信するサーバーによっては、受信時に MX レコードの有無を判定に用いられる場合がございますため、<br><code>&lt;お客様のカスタムドメイン&gt;</code> を管理するDNSにて、 <code>&lt;お客様のカスタムドメイン&gt;</code> 宛てのメールを振り分けるべき宛先をご確認、ご設定くださいませ。<br>なお、Azure Communication Service ならびに、Email Serviceについては、Email の送信を行うサービスとなり、Emailの受信機能はございません。<br>そのため、Azure Communication Serviceとして、 MX レコードに登録可能な正当なメールサーバーの IP や FQDN について提供できるものはございません。<br><code>&lt;お客様のカスタムドメイン&gt;</code> 宛てのメールをどのサーバーへ転送すべきかについては、お客様次第となるものとなり、弊社側から具体的なレコードをお出しするものではございません。</p><ul><li><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/email/email-quota-increase#3-configure-a-mail-exchange-record-for-your-custom-domain">メール ドメインのクォータの引き上げ - An Azure Communication Services concept document</a></p><blockquote><p>メール交換 (MX) レコードは、ドメイン名に代わって電子メール メッセージを受信する電子メール サーバーを指定します。 MX レコードは、ドメイン ネーム システム (DNS) のリソース レコードです。 基本的に、MX レコードは、ドメインが電子メールを受信できることを示します。</p><p>Azure Communication Service では送信メールのみがサポートされますが、送信者ドメインの評判を向上させるために MX レコードを設定することをお勧めします。 MX レコードがないカスタム ドメインからのメールは、受信者の電子メール サービス プロバイダーによってスパムとしてラベル付けされる可能性があります。 これにより、ドメインの評判が低下する可能性があります。</p></blockquote></li></ul><h3 id="DMARC-レコードの登録"><a href="#DMARC-レコードの登録" class="headerlink" title="DMARC レコードの登録"></a>DMARC レコードの登録</h3><p>MX レコードと同様にカスタムドメイン利用時に DMARC レコードは必須ではございませんが、DMARC レコードを設定いただくことで送信者ドメインの評判を向上に寄与します。</p><ul><li><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/email/email-authentication-best-practice#implementing-dmarc">送信者認証のサポートに関するベスト プラクティス - An Azure Communication Services article</a></p></li><li><p><a href="https://learn.microsoft.com/ja-jp/defender-office-365/email-authentication-dmarc-configure?preserve-view=true&view=o365-worldwide#syntax-for-dmarc-txt-records">DMARC を使用してメールを検証する、セットアップ手順 - Microsoft Defender for Office 365</a></p></li></ul><h2 id="送信成功率の維持"><a href="#送信成功率の維持" class="headerlink" title="送信成功率の維持"></a>送信成功率の維持</h2><p>メールの失敗率は 1% 未満であることが求められます。<br>検証目的であったとしても、当該のドメインからの失敗率が高い場合、申請は却下される可能性が高くございます。</p><ul><li><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/email/sender-reputation-managed-suppression-list#managing-sender-reputation-and-email-complaints-to-enhance-email-delivery">Azure Communication Services 電子メールの送信者の評判を理解する - An Azure Communication Services article</a></p><blockquote><p><strong>送信者の評判と電子メールの苦情を管理してメール配信を強化する</strong></p><p>Azure Communication Services には、顧客の通信を強化できる電子メール機能が用意されています。 ただし、プラットフォーム経由で送信したメールが顧客の受信トレイに届く保証はありません。 配信の問題を事前に特定して回避するには、次のような評判チェックを実行する必要があります。</p><ul><li>  正常に配信された電子メールの一貫性と正常な割合を一定期間にわたって確保します。</li><li>  電子メール配信の失敗とバウンスに関する特定の詳細の分析。</li><li>  スパムおよび不正使用レポートの監視。</li><li>  正常な連絡先リストを維持する。</li><li>  ユーザーエンゲージメントとメールボックス配置の理解。</li><li>  顧客の苦情を理解し、オプトアウトまたは登録解除のための簡単なプロセスを提供します。</li></ul></blockquote></li><li><p><a href="https://azure.github.io/jpazpaas/2025/09/08/ACS-Email-Onboarding-FAQ.html">Azure Communication Services メール機能でよく頂くご質問 - Japan PaaS Support Team Blog</a> </p><blockquote><ul><li>送信数のクォータ引き上げ審査でメール送信失敗率は加味されますか？</li><li>失敗率の監視はどこからできますか？</li></ul></blockquote></li></ul><h2 id="段階的な緩和について"><a href="#段階的な緩和について" class="headerlink" title="段階的な緩和について"></a>段階的な緩和について</h2><p>カスタムドメインに対するデフォルトのレート制限は、30件/min、100件/hour となります。<br>具体的な値をお伝えすることができず恐縮ではございますが、制限の緩和は送信実績に基づき段階的に実施させていただいております。<br>そのため、現在の制限を大幅に上回るような申請をいただいてもご希望に沿える可能性は低くございます。<br>目安として、現在の制限に抵触する状態が続くようであればその倍の容量をご申請いただければと存じます。</p><ul><li><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/quickstarts/email/send-email-advanced/throw-exception-when-tier-limit-reached?pivots=programming-language-javascript">メール送信層の制限に達したときに例外をスローする - An Azure Communication Services article</a></p></li><li><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/service-limits#email">Azure Communication Services のサービス制限 - An Azure Communication Services article</a></p><blockquote><p>メールの配信状態を注意深く監視しながら、2 週間から 4 週間かけて、Azure Communication Services Email を使用するメールの量を少しずつ増やすことをお勧めします。 このように段階的に増やすと、サード パーティのメール サービス プロバイダーはドメインのメール トラフィック用の IP の変更に適応できます。 少しずつ変更すると、送信者評価を保護し、メール配信の信頼性を維持する時間が得られます。</p></blockquote></li></ul><p>一方でシステム要件として予定されている送信数があらかじめ定まっている場合なども多かろうと存じます。<br>そのような場合、ビジネスインパクトやスケジュール等の詳細をお伺いさせていただき、可能な範囲で調整させていただくこともございます。一度サポートまでご相談くださいませ。</p><h2 id="弊社からのヒアリング事項"><a href="#弊社からのヒアリング事項" class="headerlink" title="弊社からのヒアリング事項"></a>弊社からのヒアリング事項</h2><p>ドキュメントに沿ってサポートリクエスト起票時に記入くださいませ。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/email/email-quota-increase">メール ドメインのクォータの引き上げ - An Azure Communication Services concept document</a></p><p>日本語で記載いただいてもかまいません。<br>未記載の項目がございますと、審査プロセスを進めるまでに時間がかかってしまうことになります。ご注意くださいませ。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1.送信を利用するお客様の会社名 (英語表記) :</span><br><span class="line">2.送信を利用するお客様の会社のウェブサイト URL :</span><br><span class="line">3.送信を利用するお客様の会社の事業内容について簡潔にご説明ください :</span><br><span class="line"></span><br><span class="line">4.該当の Azure Communication Services リソースでは、既にカスタムドメインを構成し、カスタムドメインからメールを送信できている状態でしょうか :</span><br><span class="line">5.メール送信に利用されているカスタムドメイン名 :</span><br><span class="line">6.Azure Communication Services リソース名および Email Services リソース名</span><br><span class="line">・Azure Communication Servicesリソース名 :</span><br><span class="line">・Email Services リソース名:</span><br><span class="line">7.サブスクリプション ID :</span><br><span class="line">8.テナント名 :</span><br><span class="line">9.テナント ID :</span><br><span class="line"></span><br><span class="line">10.本メール機能をどのような目的でご利用されるか (お客様との取引、売買 (ショッピング等)、宣伝等) :</span><br><span class="line">11.ご希望の上限:</span><br><span class="line"> - 件/1分</span><br><span class="line"> - 件/1時間</span><br><span class="line"> - 件/1日</span><br><span class="line">12.送信先のメールアドレスはどのような方法で取得しましたか :</span><br><span class="line">13.送信先となるユーザーが配信解除を希望、もしくは送信不達となった場合、対象ユーザーをどのように送信先から除外するか :</span><br><span class="line">14.現在該当のドメインにてどのようなプラットフォームをメール送信時に使用されているか教えてください。：例: オンプレミス、Amazon SES 等</span><br></pre></td></tr></table></figure><h1 id="クォータ緩和後のガイドライン"><a href="#クォータ緩和後のガイドライン" class="headerlink" title="クォータ緩和後のガイドライン"></a>クォータ緩和後のガイドライン</h1><p>メール送信量を増やしていく際のガイドラインとなります。ご参考にしてくださいませ。</p><ul><li><p>MXレコードが未設定の場合、MX レコードの追加を実施くださいませ。</p></li><li><p>低い失敗率と良好なNDR（配信不能通知）は、高いメールクォータを維持するために重要です。以下の2つの重要なガイダンスに従っていることを確認してください。<br><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/service-limits#email">Azure Communication Services のサービス制限 - An Azure Communication Services article</a></p><ul><li><ol><li>移行アプローチ<blockquote><p>メールの配信状態を注意深く監視しながら、2 週間から 4 週間かけて、Azure Communication Services Email を使用するメールの量を少しずつ増やすことをお勧めします。 このように段階的に増やすと、サード パーティのメール サービス プロバイダーはドメインのメール トラフィック用の IP の変更に適応できます。 少しずつ変更すると、送信者評価を保護し、メール配信の信頼性を維持する時間が得られます。</p></blockquote></li></ol></li><li><ol start="2"><li>失敗率の管理<blockquote><p>失敗率の要件</p><p>高いメール クォータを有効にするには、メールの失敗率が 1% 未満である必要があります。 失敗率が高い場合は、クォータの引き上げを要求する前に問題を解決する必要があります。 お客様は、失敗率を積極的に監視する必要があります。</p><p>クォータの引き上げ後に失敗率が上がった場合、Azure Communication Services はお客様に連絡して、直ちに対処することを求め、解決のタイムラインを確認します。 極端なケースでは、指定されたタイムライン内で失敗率が管理されない場合、Azure Communication Services は、問題が解決されるまでサービスを減らしたり中断したりする可能性があります。</p></blockquote></li></ol></li></ul></li></ul><p>下記のドキュメント群もご参考にしていただけますと幸いです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/email/sender-reputation-managed-suppression-list">Azure Communication Services 電子メールの送信者の評判を理解する - An Azure Communication Services article</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/analytics/insights/email-insights">メールの分析情報 - An Azure Communication Services article</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/analytics/enable-logging">Azure Monitor でログ記録を有効にする - An Azure Communication Services article</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/quickstarts/email/handle-email-events">メールイベントを処理する - Azure Communication Services</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/event-grid/communication-services-email-events">Azure Communication Services - Email イベント - Azure Event Grid</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/quickstarts/email/manage-suppression-list-management-sdks?pivots=programming-language-javascript">Management SDK を使用してドメイン抑制リストを管理する - An Azure Communication Services article</a></li><li><a href="https://azure.github.io/jpazpaas/2025/09/08/ACS-Email-Onboarding-FAQ.html">Azure Communication Services メール機能でよく頂くご質問 - Japan PaaS Support Team Blog</a></li></ul><p>これはテストです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;お世話になっております。Azure Communication Services サポート担当の押田です。&lt;/p&gt;
&lt;p&gt;Azure Communication Services で Email を送信には規定でクォータが設けられております。&lt;/p&gt;
&lt;p&gt;&lt;a href=</summary>
      
    
    
    
    
    <category term="Azure Communication Services" scheme="https://komayama.github.io/jpazpaas/tags/Azure-Communication-Services/"/>
    
    <category term="Email" scheme="https://komayama.github.io/jpazpaas/tags/Email/"/>
    
  </entry>
  
  <entry>
    <title>Azure ポータルで BLOB のリストやダウンロードはできるけれど削除ができないときに考えられること</title>
    <link href="https://komayama.github.io/jpazpaas/2026/01/16/i-can-listblobs-but-i-cant-deleteblobs.html"/>
    <id>https://komayama.github.io/jpazpaas/2026/01/16/i-can-listblobs-but-i-cant-deleteblobs.html</id>
    <published>2026-01-15T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.152Z</updated>
    
    <content type="html"><![CDATA[<p>Azure 仮想マシン上でブラウザを起動して Azure ポータルを表示しています。また、該当の Azure 仮想マシンが属している仮想ネットワークのサブネットに、今回操作対象のストレージアカウントの blob のプライベート エンドポイントはすでに作成済みです。</p><p>この環境で、Azure ポータルで対象のストレージアカウント内のコンテナー配下の BLOB の一覧を出したり、個別の BLOB のアップロードやダウンロード、個別の BLOB の画面まで行って削除はできるのですが、BLOB の一覧でチェックを入れて削除、などをすると以下のように失敗します。考えられることを教えてください。</p><p>例えば以下のようにコンテナー con1 の BLOB の一覧は見えています。あわせて、ダウンロードやアップロードもできました。</p><p><img src="/jpazpaas/2026/01/16/i-can-listblobs-but-i-cant-deleteblobs/image-64e7a0ef-ca22-4471-b3d8-b98e1b98263b.png" alt="image-64e7a0ef-ca22-4471-b3d8-b98e1b98263b.png"> </p><p>ただ、一覧からチェックを入れて削除しようとすると 403 エラー (This request is not authorized to perform this operation) となって削除に失敗しました。</p><p><img src="/jpazpaas/2026/01/16/i-can-listblobs-but-i-cant-deleteblobs/image-3b997c6f-19ba-422d-8348-83d5f89a7bc7.png" alt="image-3b997c6f-19ba-422d-8348-83d5f89a7bc7.png"></p><h1 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答</h1><h2 id="概要と回避方法"><a href="#概要と回避方法" class="headerlink" title="概要と回避方法"></a>概要と回避方法</h2><p>可能性として考えられることは、該当のストレージアカウントにおいて、</p><ul><li>ストレージアカウントのファイアウォールの設定を入れて経路を絞っている</li><li>プライベート エンドポイント経由のアクセスのみが許可されている</li><li>階層型名前空間が有効になっている</li><li>プライベート エンドポイントについて、blob 向けのプライベート エンドポイントは作成したものの dfs 向けのプライベート エンドポイントは作成していない</li></ul><p>といった状況になっていることが疑われます。この場合の問題の解決方法としては、blob 向けのプライベート エンドポイントと同様に dfs 向けのプライベート エンドポイントも作ってください、ということになります。</p><h2 id="詳細"><a href="#詳細" class="headerlink" title="詳細"></a>詳細</h2><p>Azure Blob Storage において Azure ポータル上で BLOB の一覧を出したり、アップロードやダウンロードをするといった操作はブラウザを起動しているクライアントからストレージに対して REST API を呼び出してその操作の結果をブラウザーに反映しているという動作になります。</p><p>例えば、Azure ポータルで コンテナー内の BLOB の一覧を取得する場合、以下の ListBlobs という REST API を発行することになります。ListBlobs の場合、REST API を発行する FQDN は <strong>(storagename).blob.core.windows.net</strong> となります。</p><p><a href="https://learn.microsoft.com/ja-jp/rest/api/storageservices/list-blobs">BLOB の一覧表示 REST API - Azure Storage</a></p><p>そして、ストレージアカウントでファイアウォールの設定をしていて、プライベート エンドポイント経由からのアクセスの許可のみをしている場合、blob 向けのプライベート エンドポイントが存在し、そのプライベート エンドポイントがポータルを実行している Azure 仮想マシンからアクセス可能な場合、上記の ListBlobs は成功することになります。</p><p>その一方で、Azure ポータルで BLOB の一覧でチェックを入れて複数の BLOB をまとめて削除、という操作をすると、階層型名前空間が無効なストレージアカウントでは以下の Delete BLOB という REST APIを実行します。</p><p><a href="https://learn.microsoft.com/ja-jp/rest/api/storageservices/delete-blob">BLOB の削除 REST API - Azure Storage</a></p><p>上記の DeleteBlob という REST API も REST API を発行する FQDN は ListBlobs と同様、**(storagename).blob.core.windows.net** となります。この場合、ListBlobs の時と同様に、プライベート エンドポイントへのアクセスになるので、経路としては許可された経路になります。</p><p>ただ、階層型名前空間が有効な環境でAzure ポータルで BLOB の一覧でチェックを入れて複数の BLOB をまとめて削除、という操作をすると、REST API は上記の DeleteBlob とは異なり、Path - Delete の REST API を利用します。</p><p><a href="https://learn.microsoft.com/ja-jp/rest/api/storageservices/datalakestoragegen2/path/delete">Path - Delete</a></p><p>この Path - Delete という REST API の場合、REST API を発行する FQDN は <strong>(storagename).dfs.core.windows.net</strong> となります。ここでもし dfs 向けのプライベート エンドポイントを作成していないと、ポータルからは (storagename).dfs.core.windows.net のエンドポイントへのアクセスはパブリックの IP になり、許可していない経路となるため、403 応答を受け取ることになります。</p><p>以下、Azure ポータルで、一覧から BLOB を選択して削除しに行った時のブラウザートレースを取得した画面となりますが、(storagename).dfs.core.windows.net のエンドポイントに HTTP の DELETE を発行して 403 になったことが確認できます。</p><p><img src="/jpazpaas/2026/01/16/i-can-listblobs-but-i-cant-deleteblobs/image-35cea72b-9bc6-4340-a4f2-ccba35f179a9.png" alt="image-35cea72b-9bc6-4340-a4f2-ccba35f179a9.png"></p><p>このような挙動になるため、階層型名前空間が有効な場合、blob 向けのプライベート エンドポイントだけでなく、dfs 向けのプライベート エンドポイントも作成する必要がある、ということなります。この点は以下の資料にも記載がございます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/storage-private-endpoints">プライベート エンドポイントを使用する - Azure Storage</a></p><p>以下、上記資料よりの引用となります。</p><p><code>Data Lake Storage ストレージ リソース用にプライベート エンドポイントを作成する場合は、Blob Storage リソース用にも作成する必要があります。 これは、Data Lake Storage エンドポイントをターゲットとする操作が、BLOB エンドポイントにリダイレクトされる可能性があるためです。 同様に、Blob Storage 用のみにプライベート エンドポイントを追加し、Data Lake Storage 用に追加しない場合、API には DFS プライベート エンドポイントが必要であるため、一部の操作 (ACL の管理、ディレクトリの作成、ディレクトリの削除など) が失敗します。 両方のリソースにプライベート エンドポイントを作成して、すべての操作が正常に完了できるようにします。</code></p><p>なお、今回は一覧でチェックを入れての削除、というパターンを例に取りましたが、ACL の設定など階層型名前空間を利用しているとき特有の操作が失敗する、というような見え方もするシナリオとなります。</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>コンテナー内の BLOB の一覧は出せるけれど削除ができない、というような見え方になるため、経路の問題というより、アクセスしているユーザーの権限、と考えがちな内容になります。ただ、階層型名前空間を利用しているストレージアカウントの場合においては、以下のことを気にしてみるとご自身でもトラブルシューティングができるかと思います。</p><ul><li>ストレージ アカウントのファイアウォールの設定でアクセスの経路を絞っているかどうか</li><li>Azure ポータルを使用している環境からストレージ アカウントへの経路は、プライベート エンドポイントを利用する環境になるか</li><li>プライベート エンドポイントを利用する環境の場合、blob、dfs 両方のプライベート エンドポイントを作成しているか</li><li>プライベート エンドポイントを利用している場合、ポータルを利用しているクライアントの環境から、blob、dfs 両方に対してプライベート エンドポイントの IP に名前解決できているか</li></ul><p>一部の操作が失敗、という挙動から権限周りの確認はしていただくものの、ストレージのファイアウォールまわりやプライベート エンドポイントの構成などを確認する、というところに視点が向かないということはそれなりに起こりうるシナリオかと思います。もちろんこのシナリオも一例に過ぎないので、似たような状況だけれどこのシナリオには完全に合致しない、ということもあるかとは思いますが、こういうシナリオもある、ということで参考になれば幸いです。</p><h1 id="参考資料"><a href="#参考資料" class="headerlink" title="参考資料"></a>参考資料</h1><p><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/storage-network-security">Azure Storage のファイアウォール規則 | Microsoft Learn</a>  </p><p><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/storage-private-endpoints">プライベート エンドポイントを使用する - Azure Storage | Microsoft Learn</a><br><br><br><br></p><hr><br><br><p>2026 年 01 月 16 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Azure 仮想マシン上でブラウザを起動して Azure ポータルを表示しています。また、該当の Azure 仮想マシンが属している仮想ネットワークのサブネットに、今回操作対象のストレージアカウントの blob のプライベート エンドポイントはすでに作成済みです。&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="Storage" scheme="https://komayama.github.io/jpazpaas/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>ドキュメントキー文字数制限エラーの解消法</title>
    <link href="https://komayama.github.io/jpazpaas/2025/12/22/How-to-resolve-the-document-key-character-limit-error.html"/>
    <id>https://komayama.github.io/jpazpaas/2025/12/22/How-to-resolve-the-document-key-character-limit-error.html</id>
    <published>2025-12-21T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.151Z</updated>
    
    <content type="html"><![CDATA[<p>Blob ストレージをデータソースとする AI Search を利用して、インデクサーを実行した際に 「<code>Document key cannot be longer than 1024 characters</code>」というエラーが発生し、インデクサーの実行が失敗しました。</p><h1 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答</h1><p>AI Search のインデックス内のドキュメントを一意に識別するドキュメントキーは、エラーにある通り、1,024文字を超えることはできません。<br>このドキュメントキーは一般的には、BLOBのパス（<code>metadata_storage_path</code>）を Base64 でエンコードすることで生成されます。<br>Blob の エンコードされたURLは、ファイル名に日本語等のマルチバイト文字列が含まれる場合、長さが大きくなり、1,024文字の制限に到達しやすくなります。</p><p>エラーの解消方法としては 3 つございます。</p><h3 id="1-fixedLengthEncode-関数-の利用"><a href="#1-fixedLengthEncode-関数-の利用" class="headerlink" title="1. fixedLengthEncode 関数 の利用"></a>1. fixedLengthEncode 関数 の利用</h3><p>ファイル名の長さによって、エラーになることを防ぐには、インデクサー定義内で <code>fixedLengthEncode</code> 関数を利用します。<br><code>fixedLengthEncode</code> 関数は、任意の長さの文字列を一意の固定長文字列に変換します。</p><p>この関数を使用すると、任意の長さの文字列が固定長文字列に変換されます。<br><a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-field-mappings?tabs=rest#fixedlengthencode-function">インデクサーのフィールドをマッピングする - Azure AI Search | Microsoft Learn</a></p><p>例えばインデクサー定義を以下のようにします。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;fieldMappings&quot; : [</span><br><span class="line"> &#123;</span><br><span class="line">  &quot;sourceFieldName&quot; : &quot;metadata_storage_path&quot;,</span><br><span class="line">  &quot;targetFieldName&quot; : &quot;your key field&quot;,</span><br><span class="line">   &quot;mappingFunction&quot; : &#123;</span><br><span class="line">    &quot;name&quot; : &quot;fixedLengthEncode&quot;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><br>一方で、テキストを分割し、チャンクごとにインデックスのドキュメントを作成する方法を利用されている場合などは、現時点では `fixedLengthEncode` 関数をサポートしておりません。<p>そのため、 <code>fixedLengthEncode</code> 関数を利用できない場合や、インデクサーの編集が困難な場合には、以下の方法にてエラーを解消することも可能です。</p><h3 id="2-ファイル名を短い名前に変更する"><a href="#2-ファイル名を短い名前に変更する" class="headerlink" title="2.ファイル名を短い名前に変更する"></a>2.ファイル名を短い名前に変更する</h3><p>2.1. 対象のファイルを特定します。インデクサーの実行履歴の画面を確認します。以下の画像のように、「<code>Target field &#39;chunk_id&#39; is...</code>」にカーソルを合わせると、エラーの原因となっているファイルを確認することができます。<br/><br><img src="/jpazpaas/2025/12/22/How-to-resolve-the-document-key-character-limit-error/image-4236d7ec-8c2d-42f3-90ce-4f30750e3312.png" alt="image-4236d7ec-8c2d-42f3-90ce-4f30750e3312.png"><br>2.2. Blobのファイル名自体は変更できないため、一度ファイルをダウンロードし、名前変更の上アップロードし、前のファイルは削除します。</p><h3 id="3-インデクサーが対象の-BLOB-をスキップするように設定する"><a href="#3-インデクサーが対象の-BLOB-をスキップするように設定する" class="headerlink" title="3.インデクサーが対象の BLOB をスキップするように設定する"></a>3.インデクサーが対象の BLOB をスキップするように設定する</h3><p>ファイル名変更が難しい場合は、該当Blobのメタデータに、キー : <code>AzureSearch_Skip</code>、値 : <code>true</code> を設定いただき、インデクサーが該当Blobを処理しないようにスキップさせます。<br/><br><img src="/jpazpaas/2025/12/22/How-to-resolve-the-document-key-character-limit-error/image-ff0cd6ea-7a08-4283-a2eb-5257e800b4ff.png" alt="image-ff0cd6ea-7a08-4283-a2eb-5257e800b4ff.png"></p><p>AzureSearch_Skipについては以下のドキュメントに記載がございます。</p><p> <strong>抜粋</strong></p><blockquote><p><code>&quot;AzureSearch_Skip&quot; : &quot;true&quot;</code></p></blockquote><blockquote><p>BLOB を完全にスキップするように BLOB インデクサーに指示します。 <br>メタデータとコンテンツのどちらの抽出も行われません。 <br>特定の BLOB で何度もエラーが発生し、インデックス作成プロセスが中断されるときに利用できます。</p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/search/search-how-to-index-azure-blob-storage#determine-which-blobs-to-index">Azure BLOB インデクサー - Azure AI Search</a></p><h1 id="参考資料"><a href="#参考資料" class="headerlink" title="参考資料"></a>参考資料</h1><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/search/cognitive-search-common-errors-warnings#error-could-not-parse-document">インデクサーのエラーと警告 - Azure AI Search</a></li></ul><br><br><hr><br><br><p>2025 年 12 月 22 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Blob ストレージをデータソースとする AI Search を利用して、インデクサーを実行した際に 「&lt;code&gt;Document key cannot be longer than 1024 characters&lt;/code&gt;」というエラーが発生し、インデクサーの実行が</summary>
      
    
    
    
    
    <category term="AI Search" scheme="https://komayama.github.io/jpazpaas/tags/AI-Search/"/>
    
  </entry>
  
  <entry>
    <title>App Service におけるインスタンスを指定した再起動手順</title>
    <link href="https://komayama.github.io/jpazpaas/2022/12/16/How-to-restart-unhealty-instance.html"/>
    <id>https://komayama.github.io/jpazpaas/2022/12/16/How-to-restart-unhealty-instance.html</id>
    <published>2025-12-10T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:02.853Z</updated>
    
    <content type="html"><![CDATA[<p>お世話になっております。App Service サポート担当の押田です。</p><p>App Service では、アプリケーションコードは Worker インスタンス と呼ばれる VM 上に配置されて実行されます。スケールアウトを行うと、指定された数のインスタンスが確保されそれぞれのインスタンス上でアプリケーションコードが実行されます。</p><p>App Service の運用段階において、特定のインスタンスだけ動作が不安定になる場合があります。原因自体はアプリケーションの内部動作起因であったり、プラットフォーム起因であったり様々な要因が考えられますが、本記事では、アプリケーションを正常な状態に復旧させることを目的とした応急処置として</p><ol><li>問題の発生しているインスタンスを見極める方法</li><li>インスタンスを指定した再起動</li><li>インスタンスの入れ替えを行う方法</li></ol><p>の 3 点について紹介します。</p><h1 id="問題の発生しているインスタンスを見極める方法"><a href="#問題の発生しているインスタンスを見極める方法" class="headerlink" title="問題の発生しているインスタンスを見極める方法"></a>問題の発生しているインスタンスを見極める方法</h1><p>アプリケーションが不安定な状態(仮にHTTP 500 エラー発生している状況) になった場合、まずはその傾向を見極める必要があります。いつから発生しているのか、何件発生しているのか、すべてのインスタンスで発生しているのか、あるいは特定のインスタンスのみで発生しているのかといった情報を確認していきます。</p><p>手早く確認できる手段として、App Service のポータルの [メトリック] ブレードが利用できます。</p><p>例えば、HTTP 2xx の合計件数と、HTTP Server Errors の合計件数を並べて表示することでリクエストの傾向をつかむことができます。</p><p>また、その際に [分割を適用する] から、分割基準として [Instance] を選択することで、リクエストを処理したインスタンス毎のグラフが描画されます。</p><p>下記例では、<code>RD0003FF47609F</code> というインスタンスに限って エラーが発生していることがわかります。</p><p><img src="/jpazpaas/2022/12/16/How-to-restart-unhealty-instance/image-0c66c25a-1759-4687-bd8d-39646375c921.png" alt="image-0c66c25a-1759-4687-bd8d-39646375c921.png"></p><p>アプリケーションの稼働するインスタンスにはそれぞれ、インスタンス名が付与されています。アプリケーションからは環境変数 <code>COMPUTERNAME</code> として参照することができます。<br>この値は例えば、<code>AppServiceHTTPLogs</code>では<a href="https://learn.microsoft.com/en-us/azure/azure-monitor/reference/tables/appservicehttplogs"><code>ComputerName</code></a>として出力されています。<br>先の例の <code>RD0003FF47609F</code> がインスタンス名となります。</p><h1 id="インスタンスを指定した再起動"><a href="#インスタンスを指定した再起動" class="headerlink" title="インスタンスを指定した再起動"></a>インスタンスを指定した再起動</h1><p>アプリケーションが不安定な状態となった場合、アプリケーションの再起動を行うことで事象が解消される可能性があり、一般的なワークアラウンドとしてサポートからお伝えさせていただくことも多くございます。<br>ただし、再起動に伴いユーザーエクスペリエンスに影響が出る可能性も考えられます。前述のように<br>問題の発生しているインスタンスが特定できた場合、そのインスタンスに限定して再起動を行う方法があります。</p><p>[問題の診断と解決]から、[高度なアプリケーション再起動 (Advanced Application Restart] を選択します。<br>メトリクスなどから確認した問題の発生しているインスタンス名 <code>RD0003FF47609F</code>を選択して [再起動] 実行します。</p><p><img src="/jpazpaas/2022/12/16/How-to-restart-unhealty-instance/image-b1f437a9-c174-4961-b83b-3cca6f2f2b73.png" alt="image-b1f437a9-c174-4961-b83b-3cca6f2f2b73.png"></p><h2 id="2025年12月追記"><a href="#2025年12月追記" class="headerlink" title="2025年12月追記"></a>2025年12月追記</h2><p>同様の操作は[インスタンス]から行うことも可能となりました。</p><p><img src="/jpazpaas/2022/12/16/How-to-restart-unhealty-instance/image-ad74303c-94e4-4eec-bfae-d8bc3d281470.png" alt="image-ad74303c-94e4-4eec-bfae-d8bc3d281470.png"></p><h1 id="インスタンスの入れ替えを行う方法"><a href="#インスタンスの入れ替えを行う方法" class="headerlink" title="インスタンスの入れ替えを行う方法"></a>インスタンスの入れ替えを行う方法</h1><p>「高度なアプリケーション再起動」による処理は、インスタンス上で稼働するアプリケーションの再起動となります。アプリケーションのメモリ状態などに問題があった場合、アプリケーションの再起動で状態が改善する可能性がありますが、例えばインスタンスそのものに何らかの問題が発生していた場合においてはアプリケーションの再起動では状況が改善しない場合もあります。</p><p>そうした場合、インスタンスを破棄して新しいインスタンスを用意することが暫定対応策として有効となります。</p><p>インスタンスを入れ替える方法としては、スケールアップやスケールダウンなど SKU を変更することで発生させることが可能です。ただしこの場合、すべてのインスタンスの入れ替えが発生することになります。</p><p>特定のインスタンスのみを入れ替える方法としては、<a href="https://learn.microsoft.com/ja-jp/rest/api/appservice/app-service-plans/reboot-worker">App Service Plans - Reboot Worker</a> API を利用することができます。</p><p>先程取得したインスタンス名および、App Service Plan 名、リソースグループ名、サブスクリプションを指定して実行します。実行にはcurl 等のクライアントでも利用可能ですが、<a href="https://learn.microsoft.com/ja-jp/rest/api/azure/#how-to-call-azure-rest-apis-with-postman">認証情報の設定の手間</a>を考えると API リファレンスページ内の [使ってみる]からログインし、GUI 操作いただく方法が簡易です。</p><p><img src="/jpazpaas/2022/12/16/How-to-restart-unhealty-instance/image-a4599ab6-d190-4481-9fd9-6847c4c33463.png" alt="image-a4599ab6-d190-4481-9fd9-6847c4c33463.png"></p><p>なお、インスタンスの入れ替えは App Service Plan 単位となります。同一 App Service Plan 上に複数のWeb Apps や Azure Functions リソースを展開している場合は影響を受けることに注意ください。<br>新しい用意されたインスタンスでは、この　App Service Plan を利用している全てのリソース(Web Apps や Azure Functions) の初期化処理が行われることとなります。</p><p>また Reboot Worker API は 1つの App Service Plan に対して 1時間に1回しか実行できません。</p><h2 id="2025年12月追記-1"><a href="#2025年12月追記-1" class="headerlink" title="2025年12月追記"></a>2025年12月追記</h2><p>Linux 環境(Web Apps for Container含む)に限り、同様の操作は[インスタンス]から行うことも可能となりました。</p><p><img src="/jpazpaas/2022/12/16/How-to-restart-unhealty-instance/image-59833536-d9cf-4899-8650-17ec9b2791e4.png" alt="image-59833536-d9cf-4899-8650-17ec9b2791e4.png"></p><p>以上、App Service 上でアプリケーションが不安定な状態になった際の応急処置についてご紹介させていただきました。</p><p>2025 年 12 月 11 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;お世話になっております。App Service サポート担当の押田です。&lt;/p&gt;
&lt;p&gt;App Service では、アプリケーションコードは Worker インスタンス と呼ばれる VM 上に配置されて実行されます。スケールアウトを行うと、指定された数のインスタンスが確保</summary>
      
    
    
    
    
    <category term="App Service" scheme="https://komayama.github.io/jpazpaas/tags/App-Service/"/>
    
  </entry>
  
  <entry>
    <title>Azure Front Door を経由してAzure AD 認証を有効にしたApp Serviceへのアクセス</title>
    <link href="https://komayama.github.io/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door.html"/>
    <id>https://komayama.github.io/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door.html</id>
    <published>2025-10-09T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:02.938Z</updated>
    
    <content type="html"><![CDATA[<p>ブラウザであるクライアントから Azure Front Door を経由して正常に App Service にアクセスするには、どのように設定すればよろしいですか。</p><h3 id="構成"><a href="#構成" class="headerlink" title="構成"></a><strong>構成</strong><a href=""></a></h3><p>Azure Front Door に、App Service をバックアップエンドとして追加しています。<br>App Service の認証において、プロバイダーが Microsoft であり Azure AD 認証を有効にしています。<br>App Service の受信トラフィックにおいて、Azure Front Door のトラフィックのみ許可します。<br><img src="/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door/image-58d468c8-5399-4f36-a1ca-6f91e34fa604.png" alt="image-58d468c8-5399-4f36-a1ca-6f91e34fa604.png"></p><h1 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答<a href=""></a></h1><p>認証のリダイレクトURLを Azure Front Door のフロントエンドホストに変更する設定及び App Service の proxy 設定を実施することにより、App Service アプリ側で Front Door からのアクセス許可のみという構成で、ブラウザであるクライアントから Azure FrontDoor を経由して、Azure AD 認証を有効にした App Service に正常にアクセスを行うことが可能となります。<br><br>手順１：認証のリダイレクトURLを Azure Front Door のフロントエンドホストに変更する<br><br>手順２：App Service の proxy 設定を変更する</p><p>各手順の詳細を以下にご説明いたします。</p><h2 id="手順-1-認証のリダイレクトURLを-Azure-Front-Door-のフロントエンドホストに設定する"><a href="#手順-1-認証のリダイレクトURLを-Azure-Front-Door-のフロントエンドホストに設定する" class="headerlink" title="手順 1. 認証のリダイレクトURLを Azure Front Door のフロントエンドホストに設定する"></a>手順 1. 認証のリダイレクトURLを Azure Front Door のフロントエンドホストに設定する<a href=""></a></h2><p><strong>設定する理由：</strong><br><br>ブラウザから Azure Front Door にアクセスして、App Service の認証を行った後、下記のように Azure Front Door ではなく、App Service の URL にリダイレクされます。<br><img src="/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door/image-e073b36d-c2a3-46a4-a880-a2047dc788cf.png" alt="image-e073b36d-c2a3-46a4-a880-a2047dc788cf.png"></p><p>上記のことから、App Service アプリ側で Front Door からのアクセス許可のみ構成する場合、App Service のアクセス制限に抵触するため、App Service 認証を行った後、403 エラーが発生してしまいます。</p><p><img src="/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door/image-f3bddc3e-da6a-4f10-b8b5-35fdaf8edf61.png" alt="image-f3bddc3e-da6a-4f10-b8b5-35fdaf8edf61.png"></p><p>そのため、上記のエラーを解消する認証のリダイレクトを Azure Front Door のフロントエンドホストに変更する必要がございます。</p><p><strong>設定の詳細：</strong><br><br>1. Azure Portal で “Front Door と CDN プロファイル”を開きます。<br><br>2. [概要]メニューより確認できるフロントエンド ホスト名をコピーして、txtファイルなどに貼り付けます。<br><img src="/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door/image-047835ca-f491-48b9-a54b-922859f77ab0.png" alt="image-047835ca-f491-48b9-a54b-922859f77ab0.png"></p><p><br>3. Azure Portal で App Service を開きます。<br><br>4. App Service アプリの[認証]メニューより “IDプロバイダー”項目にて表示されているリンクをクリックします。<br><img src="/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door/image-53671cae-c38c-42c4-8a73-5c4a360e182f.png" alt="image-53671cae-c38c-42c4-8a73-5c4a360e182f.png"></p><p><br>5. 表示された画面において[認証]メニューより下記のようにリダイレクトURLを修正した後、”保存”ボタンをクリックします。<br><br>リダイレクトURL：<br><br><a href="https://1で確認したフロントエンドホスト名/.auth/login/aad/callback">https://1で確認したフロントエンドホスト名/.auth/login/aad/callback</a> </p><p><img src="/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door/image-0c41ebb4-10fc-4daa-b1d5-ad3d446f2d28.png" alt="image-0c41ebb4-10fc-4daa-b1d5-ad3d446f2d28.png"></p><h2 id="手順-2-App-Service-の-proxy-を設定する"><a href="#手順-2-App-Service-の-proxy-を設定する" class="headerlink" title="手順 2. App Service の proxy を設定する"></a>手順 2. App Service の proxy を設定する<a href=""></a></h2><p><strong>設定する理由：</strong><br><br>App Service 認証（Azure AD 認証）の仕組み上では認証時の Azure AD に対するリクエスト送信元ホスト名と、リダイレクト先のホスト名を一致させる必要がございます。<br><br>認証時の Azure AD に対するリクエスト送信元ホスト名が App Services のホスト名となり、リダイレクト先は Azure Front Door のホスト名となっている場合以下のようにホスト名が一致しないエラーが発生します。</p><p><img src="/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door/image-8b9cb8df-1f5a-4b57-a93a-f24e3b7d3f24.png" alt="image-8b9cb8df-1f5a-4b57-a93a-f24e3b7d3f24.png"></p><p>App Service の proxy を設定することにより、上記の事象を解消することが可能となります。<br>App Service や Azure Front Door は製品ごとに異なるヘッダーが使用され、異なる forwardProxy 設定となっているため、proxy 設定し直す必要がございます。</p><p><br>詳細は下記のドキュメントおよび弊社 App Service チームのブログ記事にて記載がございます。<br><br><a href="https://learn.microsoft.com/ja-jp/azure/app-service/overview-authentication-authorization#considerations-for-using-azure-front-door">Azure Front Door を使用する場合の考慮事項</a><br><br><a href="https://azure.github.io/AppService/2021/03/26/Secure-resilient-site-with-custom-domain.html#alter-authentication-settings">Alter authentication settings</a></p><p><strong>設定の詳細：</strong><br><br>1. az rest コマンドを使用して、App Service 認証機能の構成情報を JSON 形式でエクスポートします。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/app-service/overview-authentication-authorization#export-settings">設定のエクスポート</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az rest --uri /subscriptions/REPLACE-ME-SUBSCRIPTIONID/resourceGroups/REPLACE-ME-RESOURCEGROUP/providers/Microsoft.Web/sites/REPLACE-ME-APPNAME/config/authsettingsV2?api-version=2020-09-01 --method get &gt; auth.json</span><br></pre></td></tr></table></figure><p><br>2.  JSON 形式でエクスポートした構成内容を編集します。<br>編集する内容といたしましては、<code>forwardProxy</code> の要素内にて以下の内容を記述します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;forwardProxy&quot;: &#123;</span><br><span class="line">   &quot;convention&quot;: &quot;Standard&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br>3. 編集した JSON 形式の構成内容を App Service リソースへ適用（インポート）します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/app-service/overview-authentication-authorization#import-settings">設定のインポート</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az rest --uri /subscriptions/REPLACE-ME-SUBSCRIPTIONID/resourceGroups/REPLACE-ME-RESOURCEGROUP/providers/Microsoft.Web/sites/REPLACE-ME-APPNAME/config/authsettingsV2?api-version=2020-09-01 --method put --body @auth.json</span><br></pre></td></tr></table></figure><p><br>上述の手順で実施した結果として以下のように Azure Front Door からアクセスして、正常に認証が完了し、App Service に正常にアクセスすることを確認することが出来ます。</p><p><img src="/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door/image-b121cff0-5eaa-400c-aa94-54f392e0c508.png" alt="image-b121cff0-5eaa-400c-aa94-54f392e0c508.png"></p><p><img src="/jpazpaas/2023/05/31/Access-to-EasyAuth-enabled-App-Service-via-Azure-Front-Door/image-296a3bdf-5520-44d2-b299-3f99c60e1eaa.png" alt="image-296a3bdf-5520-44d2-b299-3f99c60e1eaa.png"></p><p><strong>補足</strong><br><br><br>App Service にアクセス制限を構成していないシナリオでも、上述リダイレクト先のホスト名が一致しないエラーが発生する場合、手順 2 の通りApp Service の proxy を設定する必要がございます。</p><h1 id="参考ドキュメント"><a href="#参考ドキュメント" class="headerlink" title="参考ドキュメント"></a>参考ドキュメント</h1><p><a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/quickstart-create-front-door#create-a-front-door-for-your-application">アプリケーション用のフロント ドアを作成する</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/app-service/app-service-ip-restrictions">Azure App Service のアクセス制限を設定する</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/app-service/overview-authentication-authorization#identity-providers">ID プロバイダー</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-auth-code-flow">Microsoft ID プラットフォームと OAuth 2.0 認証コード フロー</a></p><p><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/active-directory/error-code-aadsts50011-redirect-uri-mismatch">エラー AADSTS50011: 要求で指定されたリダイレクト URI が一致しません</a></p><p>本ブログは App Service の前段に FrontDoor を構成する場合のシナリオについて記載されましたが、App Service の前段に Application Gateway を構成する場合の Azure AD 認識について以下のブログをご参考までにご参照ください。</p><p><a href="https://azure.github.io/jpazpaas/2022/03/09/Application-Gateway-front-of-App-Service-auth.html">App Service の前段に ApplicationGateway を配置した際の Azure AD 認証</a></p><hr><br><br>2025 年 10 月 10 日時点の内容となります。<br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。<br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ブラウザであるクライアントから Azure Front Door を経由して正常に App Service にアクセスするには、どのように設定すればよろしいですか。&lt;/p&gt;
&lt;h3 id=&quot;構成&quot;&gt;&lt;a href=&quot;#構成&quot; class=&quot;headerlink&quot; title</summary>
      
    
    
    
    
    <category term="App Service" scheme="https://komayama.github.io/jpazpaas/tags/App-Service/"/>
    
    <category term="Azure Front Door" scheme="https://komayama.github.io/jpazpaas/tags/Azure-Front-Door/"/>
    
    <category term="Azure AD認証" scheme="https://komayama.github.io/jpazpaas/tags/Azure-AD%E8%AA%8D%E8%A8%BC/"/>
    
  </entry>
  
  <entry>
    <title>ストレージアカウントの最小 TLS バージョンを確認する方法について</title>
    <link href="https://komayama.github.io/jpazpaas/2024/05/08/how-to-check-tls-version-of-storage-accounts.html"/>
    <id>https://komayama.github.io/jpazpaas/2024/05/08/how-to-check-tls-version-of-storage-accounts.html</id>
    <published>2025-09-23T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.084Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/transport-layer-security-configure-migrate-to-tls2">Azure Blob Storage の TLS 1.2 に移行する</a> という資料に以下の記述がありました。</p><p>( 引用開始 )<br><br/><br><strong>2026 年 1 月 31 日</strong>、<em>Azure Blob Storage では、トランスポート層セキュリティ (TLS) のバージョン 1.0 と 1.1 のサポートが停止されます。 TLS 1.2 が新しい最小 TLS バージョンになります。 この変更は、すべてのクラウドで、TLS 1.0 と 1.1 を使用するすべての既存および新しい BLOB ストレージ アカウントに影響します。 TLS 1.2 を既に使用しているストレージ アカウントは、この変更の影響を受けません。</em><br><br/>( 引用終了 )  </p><p>上記の状況もあり、自分の手元のストレージアカウントで TLS 1.0 や 1.1 が設定されているかを確認したいのですが、どの TLS バージョンを使っているか確認する方法はありますか。</p><h1 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答</h1><h2 id="特定のストレージアカウントの最小-TLS-バージョンの確認方法"><a href="#特定のストレージアカウントの最小-TLS-バージョンの確認方法" class="headerlink" title="特定のストレージアカウントの最小 TLS バージョンの確認方法"></a>特定のストレージアカウントの最小 TLS バージョンの確認方法</h2><p>まず、単一のストレージアカウントで確認する場合は、Azure ポータルで該当のストレージアカウントを選択して、「概要」か「構成」のブレードを開けば確認できます。それぞれのスクリーンショットを載せます。</p><p><img src="/jpazpaas/2024/05/08/how-to-check-tls-version-of-storage-accounts/image-99bf3e16-8393-48b3-b318-476b31ccfe0d.png" alt="image-99bf3e16-8393-48b3-b318-476b31ccfe0d.png"></p><p>「構成」ブレードでは設定変更もできます。<br/></p><p><img src="/jpazpaas/2024/05/08/how-to-check-tls-version-of-storage-accounts/image-d79d8339-6703-443d-8000-1d4a53c017d1.png" alt="image-d79d8339-6703-443d-8000-1d4a53c017d1.png"></p><h2 id="複数のストレージアカウントの最小-TLS-バージョンの確認方法"><a href="#複数のストレージアカウントの最小-TLS-バージョンの確認方法" class="headerlink" title="複数のストレージアカウントの最小 TLS バージョンの確認方法"></a>複数のストレージアカウントの最小 TLS バージョンの確認方法</h2><p>ただ、お手元に複数のストレージアカウントがある場合には一つずつ確認するのは手間になるかと思います。この場合はAzure Resource Graph、Azure CLI、Azure PowerShell などを使うといいかと思います。ここではAzure Resource Graph と Azure CLI の例を紹介します。</p><h3 id="Azure-Resource-Graph-の例"><a href="#Azure-Resource-Graph-の例" class="headerlink" title="Azure Resource Graph の例"></a>Azure Resource Graph の例</h3><p>Azure ポータルで Azure Resource Graph エクスプローラーを開き、以下のようなクエリを実行します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Resources  </span><br><span class="line">| where type =~ &#x27;microsoft.storage/storageaccounts&#x27;</span><br><span class="line">| where subscriptionId == &quot;XXX&quot;</span><br><span class="line">| where properties.minimumTlsVersion == &quot;TLS1_0&quot; or properties.minimumTlsVersion == &quot;TLS1_1&quot; </span><br><span class="line">| project name, properties.minimumTlsVersion</span><br></pre></td></tr></table></figure><p>上記の例では特定のサブスクリプションID を指定し、かつ TLS 1.0、1.1 のみを抽出しております。<br>具体的なストレージアカウント名があるのでマスクしていますが、ストレージアカウント名と最小 TLS バージョンが一覧で表示されます。</p><p><img src="/jpazpaas/2024/05/08/how-to-check-tls-version-of-storage-accounts/image-c8bbf004-6925-4dbe-ae2f-edee82d88849.png" alt="image-c8bbf004-6925-4dbe-ae2f-edee82d88849.png"></p><p>他のプロパティも一緒に見たい、などあるようでしたら、適宜クエリを編集ください。</p><h3 id="Azure-CLI-での例"><a href="#Azure-CLI-での例" class="headerlink" title="Azure CLI での例"></a>Azure CLI での例</h3><p>こちらは一例として、Cloud Shell 上で実行しますが、以下のようなクエリを実行します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az storage account list --query &quot;[].&#123;name:name,minimumTlsVersion:minimumTlsVersion&#125;&quot; --output table</span><br></pre></td></tr></table></figure><p>結果としては以下のような表示になります。具体的なストレージアカウント名があるのでマスクしていますが、ストレージアカウント名と最小 TLS バージョンを表形式で表示しています。</p><p><img src="/jpazpaas/2024/05/08/how-to-check-tls-version-of-storage-accounts/image-9ddff4a6-7e09-47d6-9da6-ebda7d7263c1.png" alt="image-9ddff4a6-7e09-47d6-9da6-ebda7d7263c1.png"></p><h1 id="よくある質問"><a href="#よくある質問" class="headerlink" title="よくある質問"></a>よくある質問</h1><h2 id="Q1-最小-TLS-バージョンを-1-2-にしているのですが、TLS-1-0-を使った接続の確立まではできてしまいます。これはなぜですか？"><a href="#Q1-最小-TLS-バージョンを-1-2-にしているのですが、TLS-1-0-を使った接続の確立まではできてしまいます。これはなぜですか？" class="headerlink" title="(Q1)  最小 TLS バージョンを 1.2 にしているのですが、TLS 1.0 を使った接続の確立まではできてしまいます。これはなぜですか？"></a>(Q1)  最小 TLS バージョンを 1.2 にしているのですが、TLS 1.0 を使った接続の確立まではできてしまいます。これはなぜですか？</h2><p>こちらについては、2026 年 1 月 31 日以前では想定された動作となります。ストレージアカウントについてはマルチテナントの構成となっているため、ストレージアカウント単位でポートを閉じたり、通信としての特定の TLS バージョンのみを許可する、ということはできません。そのため、TLS バージョンによるアクセス許可の制御は以下の流れになります。</p><ol><li>仮にストレージアカウントの最小 TLS バージョンが 1.2、クライアントの利用する TLS バージョンが 1.0 だったとしても、TLS の接続自体は確立する</li><li>クライアントがストレージアカウントに設定されている最小 TLS バージョンを満たしていない場合、HTTP の応答として、400 The TLS version of the connection is not permitted on this storage account. という応答を返す</li></ol><p>例えば、ストレージアカウントの最小 TLS バージョンが 1.2 において、TLS 1.2 で接続すれば、例えば以下のように BLOB の内容が得られるものの、クライアントが TLS 1.0 を用いた場合は HTTP 400 応答となり、BLOB の内容は取得できません。下記の例は curl をもちいて、TLS 1.2、1.0 それぞれで同じ BLOB にアクセスした時の例となります。この例では container1 の配下に hello123.txt という BLOB があり、中身は ”hello” というテキストです。一回目の curl は TLS 1.2 になるため、BLOB の中身である “hello” が取得できていますが、二回目の curl は TLS 1.0 を利用しているため、BLOB の中身は取得できず、TlsVersionNotPermitted という文言を含んだエラーの XML 応答を受け取っています。</p><p><img src="/jpazpaas/2024/05/08/how-to-check-tls-version-of-storage-accounts/image-c2994107-abf8-4c24-8959-9b9bcd698922.png" alt="image-c2994107-abf8-4c24-8959-9b9bcd698922.png"></p><h2 id="Q2-特定のストレージアカウントの最小-TLS-バージョンが-1-0-となっていました。このストレージアカウントを利用するクライアントで-TLS-1-0-や-1-1-を使っているクライアントを確認したいのですが、どうすればいいですか。"><a href="#Q2-特定のストレージアカウントの最小-TLS-バージョンが-1-0-となっていました。このストレージアカウントを利用するクライアントで-TLS-1-0-や-1-1-を使っているクライアントを確認したいのですが、どうすればいいですか。" class="headerlink" title="(Q2) 特定のストレージアカウントの最小 TLS バージョンが 1.0 となっていました。このストレージアカウントを利用するクライアントで TLS 1.0 や 1.1 を使っているクライアントを確認したいのですが、どうすればいいですか。"></a>(Q2) 特定のストレージアカウントの最小 TLS バージョンが 1.0 となっていました。このストレージアカウントを利用するクライアントで TLS 1.0 や 1.1 を使っているクライアントを確認したいのですが、どうすればいいですか。</h2><p>こちらについてはストレージアカウントで診断設定を有効にしていただき、個別のアクセスを記録するようにしたうえで、TlsVersion の列に TLS 1.0 や 1.1 を利用している形跡がないかをご確認いただく必要があります。実際の方法については下記資料に詳細がございますので、ご覧ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/transport-layer-security-configure-minimum-version?tabs=portal#detect-the-tls-version-used-by-client-applications">クライアント アプリケーションによって使用される TLS のバージョンを検出する</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/transport-layer-security-configure-migrate-to-tls2?toc=/azure/storage/blobs/toc.json&bc=/azure/storage/blobs/breadcrumb/toc.json#enforce-tls-12-as-the-minimum-allowed-version">最小許容バージョンとして TLS 1.2 を適用する</a></p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>本記事ではストレージアカウントの 最小 TLS バージョンの確認手順について説明しました。ストレージアカウントの最小 TLS バージョンの確認自体はシンプルな方法でできますが、TLS 1.0、1.1 を使っているクライアントがいた場合に、そのクライアントが TLS 1.2 を利用できるのか、ということの確認はクライアント側での確認が必要となります。</p><p>クライアントの網羅はできませんが、新しいクライアントなら基本的には TLS 1.2 の利用はできると思いますが、古いクライアントになると、TLS のバージョンを上げるために様々な対応が必要になる、というシナリオも考えられます。TLS 1.0、1.1 が非推奨であることは RFC 7525 などでも触れられておりますので、もし、TLS 1.0、1.1 を利用しているクライアントがいるようでしたら、早めの TLS 1.2 対応をご検討いただくのがよいかと思います。</p><h2 id="変更履歴"><a href="#変更履歴" class="headerlink" title="変更履歴"></a>変更履歴</h2><p>(2024/10/7) 質問の節で引用しているサイトに記載のあった移行の期限が当初 2024 年 11 月 1 日だったものの、2025 年 11 月 1 日に変更されたため、その部分を修正しました。</p><p>(2025/9/24) 質問の節で引用しているサイトに記載のあった移行の期限が 2025 年 11 月 1 日だったものの、2026 年 1 月 31 日に変更されたため、その部分を修正しました。</p><br><br><hr><br><br><p>2025 年 09 月 24 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/storage/common/transport-layer-security-configure-migrate-to-tls2&quot;&gt;Azure Blob Storage の </summary>
      
    
    
    
    
    <category term="Storage" scheme="https://komayama.github.io/jpazpaas/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>App Service の前段に ApplicationGateway を配置した際の Azure AD 認証</title>
    <link href="https://komayama.github.io/jpazpaas/2022/03/09/Application-Gateway-front-of-App-Service-auth.html"/>
    <id>https://komayama.github.io/jpazpaas/2022/03/09/Application-Gateway-front-of-App-Service-auth.html</id>
    <published>2025-09-07T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:02.679Z</updated>
    
    <content type="html"><![CDATA[<h2 id="質問"><a href="#質問" class="headerlink" title="質問"></a>質問</h2><p>App Service の前段に Application Gateway の配置をしています。それぞれの Azure リソースでは異なるホスト名として構成し、ブラウザであるクライアントから Azure AD 認証を行った場合に失敗してしまうため対応を行いたいです。</p><h3 id="構成"><a href="#構成" class="headerlink" title="構成"></a>構成</h3><p>Application Gateway に、App Service をバックエンド プールとして追加している状況です。また、Application Gateway と App Service が異なるホスト名で公開をしています。</p><p><img src="/jpazpaas/2022/03/09/Application-Gateway-front-of-App-Service-auth/1-1-auth-architecture.png" alt="1-1-auth-architecture.png"></p><h3 id="発生しているエラー"><a href="#発生しているエラー" class="headerlink" title="発生しているエラー"></a>発生しているエラー</h3><p>Azure AD の Azure ポータル画面より アプリの登録 から対象のアプリを選択し、左ブレードメニューの 認証 にて、リダイレクト URI を Application Gateway にて設定しているホスト名を追加いたしました。<br>その後、ブラウザから Application Gateway 経由にて App Service へ接続を行い、Azure AD 認証画面が表示された後にユーザ情報を入力したところ、Azure AD による以下のエラーメッセージが表示されました。</p><blockquote><p>AADSTS50011: The reply URL specified in the request does not match the reply URLs configured for the application:”</p></blockquote><p><img src="/jpazpaas/2022/03/09/Application-Gateway-front-of-App-Service-auth/1-2-auth-faild.png" alt="1-2-auth-faild.png"></p><h2 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答</h2><p>結論から申し上げますと、Application Gateway と App Service 間の URL にて FQDN やドメインの違いにより、Azure AD 側にて認証が失敗していることが想定されます。</p><h3 id="認証フローについて"><a href="#認証フローについて" class="headerlink" title="認証フローについて"></a>認証フローについて</h3><p>App Service と Azure AD 間の通信では、App Service 認証を用いて Azure AD のアクセス トークンを取得する際に、Authorization Code Grant と呼ばれる認証フローを利用します。詳細な AzureAD での認証フローにつきましては以下の弊社提供の公開情報がございます。</p><p><a href="https://learn.microsoft.com/ja-jp/entra/identity-platform/v2-oauth2-auth-code-flow">Microsoft ID プラットフォームと OAuth 2.0 認証コード フロー</a></p><ol><li><p>App Service は未認証のユーザーがアクセスしてきた場合、ユーザーを認証するため Azure AD の Authorize エンドポイントに、認可リクエストを送信します。<br>この際、Azure AD からの認証結果を返却する「リダイレクト URI」(redirect_uri) を認可リクエストのクエリに含めます。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET https://login.microsoftonline.com/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/oauth2/v2.0/authorize?</span><br><span class="line">response_type=code+id_token&amp;</span><br><span class="line">redirect_uri=https%3A%2F%2Fxxxxxxxxxxxx.azurewebsites.net%2F.auth%2Flogin%2Faad%2Fcallback&amp;</span><br><span class="line">client_id=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&amp;</span><br><span class="line">scope=openid+profile+email&amp;</span><br><span class="line">response_mode=form_post&amp;</span><br><span class="line">nonce=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx_2022xxxxxxxxxx&amp;</span><br><span class="line">state=redir%3D%252F</span><br></pre></td></tr></table></figure></li><li><p>リダイレクト URI は認証情報が返却される URI のため、必ず Azure AD のアプリ登録に設定されたリダイレクト URI と一致する必要がございます。Azure AD は上記リクエストに対し、アクセス トークン引換のための認可コード (code) を App Service へ返却します。<br>その後、code を受け取った App Service は、認可コードを利用して 以下の Azure AD のエンドポイントへトークンリクエストを行います。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST https://login.microsoftonline.com/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/oauth2/v2.0/token</span><br><span class="line"></span><br><span class="line">client_id= xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</span><br><span class="line">&amp;code=OAAABAAAAiL9Kn2Z27UubvWFPbm0gLWQJVzCTE9UkP3pSx1aXxUjq3n8b2JRLk4OxVXr...</span><br><span class="line">&amp;redirect_uri= https%3A%2F%2Fxxxxxxxxxxxx.azurewebsites.net%2F.auth%2Flogin%2Faad%2Fcallback&amp;</span><br><span class="line">&amp;grant_type=authorization_code</span><br><span class="line">&amp;client_secret=xxxxxxxxxxxxxxxx</span><br></pre></td></tr></table></figure></li></ol><p>トークンリクエストに含まれる redirect_uri は、アプリ登録のリダイレクト URI だけではなく  1. の認可リクエストに含まれる redirect_uri と完全にも一致している必要があり、こちらが一致しない場合には上記のエラーが発生します。</p><h3 id="対応策"><a href="#対応策" class="headerlink" title="対応策"></a>対応策</h3><p><strong>App Service が返却する認可リクエストの redirect_uri を Application Gateway が受け取った HOST ヘッダーに合わせる</strong></p><p>Application Gateway の場合、X-Original-Host というヘッダーにて、Application Gateway  が受け取った HOST ヘッダーが格納されるということで、App Service 認証がこのヘッダーを読み取り、redirect_uri を適切に構成することで、認証が正常に行えるようになります。</p><p>以下の弊社検証環境の公開情報に従って、App Service 認証機能の設定を構成します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/app-service/overview-authentication-authorization#ensure-that-app-service-is-using-the-right-redirect-uri">App Service で適切なリダイレクト URI が使用されていることを確認する</a></p><h4 id="1-az-rest-コマンドを使用して、App-Service-認証機能の構成情報を-JSON-形式でエクスポートします。"><a href="#1-az-rest-コマンドを使用して、App-Service-認証機能の構成情報を-JSON-形式でエクスポートします。" class="headerlink" title="1. az rest コマンドを使用して、App Service 認証機能の構成情報を JSON 形式でエクスポートします。"></a>1. az rest コマンドを使用して、App Service 認証機能の構成情報を JSON 形式でエクスポートします。</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/app-service/overview-authentication-authorization#export-settings">設定のエクスポート</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az rest --uri /subscriptions/REPLACE-ME-SUBSCRIPTIONID/resourceGroups/REPLACE-ME-RESOURCEGROUP/providers/Microsoft.Web/sites/REPLACE-ME-APPNAME/config/authsettingsV2?api-version=2020-09-01 --method get &gt; auth.json</span><br></pre></td></tr></table></figure><h4 id="2-JSON-形式でエクスポートした構成内容を編集します。"><a href="#2-JSON-形式でエクスポートした構成内容を編集します。" class="headerlink" title="2.  JSON 形式でエクスポートした構成内容を編集します。"></a>2.  JSON 形式でエクスポートした構成内容を編集します。</h4><p>編集する内容といたしましては、<code>forwardProxy</code> の要素内にて以下の内容を記述します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;forwardProxy&quot;: &#123;</span><br><span class="line">    &quot;convention&quot;: &quot;Custom&quot;,</span><br><span class="line">    &quot;customHostHeaderName&quot;: &quot;X-Original-Host&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-編集した-JSON-形式の構成内容を-App-Service-リソースへ適用（インポート）します。"><a href="#3-編集した-JSON-形式の構成内容を-App-Service-リソースへ適用（インポート）します。" class="headerlink" title="3. 編集した JSON 形式の構成内容を App Service リソースへ適用（インポート）します。"></a>3. 編集した JSON 形式の構成内容を App Service リソースへ適用（インポート）します。</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/app-service/overview-authentication-authorization#import-settings">設定のインポート</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az rest --uri /subscriptions/REPLACE-ME-SUBSCRIPTIONID/resourceGroups/REPLACE-ME-RESOURCEGROUP/providers/Microsoft.Web/sites/REPLACE-ME-APPNAME/config/authsettingsV2?api-version=2020-09-01 --method put --body @auth.json</span><br></pre></td></tr></table></figure><p>弊社 App Service 開発チームのブログにてこちらの詳細な内容が記載されておりますためご参照ください。</p><p><a href="https://azure.github.io/AppService/2021/03/26/Secure-resilient-site-with-custom-domain.html#application-gateway">Application Gateway</a></p><br><br><hr><br><br><p>2025 年 09 月 08 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;質問&quot;&gt;&lt;a href=&quot;#質問&quot; class=&quot;headerlink&quot; title=&quot;質問&quot;&gt;&lt;/a&gt;質問&lt;/h2&gt;&lt;p&gt;App Service の前段に Application Gateway の配置をしています。それぞれの Azure リソースでは異なるホス</summary>
      
    
    
    
    
    <category term="Function App" scheme="https://komayama.github.io/jpazpaas/tags/Function-App/"/>
    
    <category term="App Service" scheme="https://komayama.github.io/jpazpaas/tags/App-Service/"/>
    
    <category term="Web Apps" scheme="https://komayama.github.io/jpazpaas/tags/Web-Apps/"/>
    
    <category term="Application Gateway" scheme="https://komayama.github.io/jpazpaas/tags/Application-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Azure Functions トリガー・バインディング シリーズ</title>
    <link href="https://komayama.github.io/jpazpaas/2024/02/22/Azure-functions-trigger-and-binding-series-cover.html"/>
    <id>https://komayama.github.io/jpazpaas/2024/02/22/Azure-functions-trigger-and-binding-series-cover.html</id>
    <published>2025-09-07T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.045Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Functions はイベントドリブンな処理を実装する手段を提供します。つまり、Azure Functions では何かしらの契機無くアプリケーションが動作するというシナリオは存在しておらず、何かしらのイベントによってアプリケーション コードが動作する仕組みとなっています。Azure Functions の動作契機として接続可能な製品は多く、<a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-triggers-bindings?tabs=csharp#supported-bindings">トリガーとバインディング</a>の2種類がそれぞれ定義されています。<br>トリガーやバインディングは Azure Functions の拡張機能を利用して各リソースと接続を行っています。サポートされているトリガーとバインディングの使用例は公式ドキュメントや GitHub のリポジトリにも記載しておりますが、トリガーの動作詳細やチューニング方法について多数お問い合わせをいただいております。本ブログでは、Azure Functions に関していただいておりましたお問合せの内容や、弊社エンジニアにて検証した内容をトリガーごとに整理した各記事へのリンク記事となっております。本ブログで紹介いたします情報が Azure Functions ご利用の際のお役に立ちますと幸いです。</p><h1 id="記事一覧"><a href="#記事一覧" class="headerlink" title="記事一覧"></a>記事一覧</h1><p>※リンクが無い種類については今後投稿されますため、お待ちください。</p><table><thead><tr><th>項番</th><th>種類</th></tr></thead><tbody><tr><td>1</td><td><a href="https://azure.github.io/jpazpaas/2025/02/26/Azure-functions-trigger-and-binding-series-blob.html"> Blob Storage </a></td></tr><tr><td>2</td><td>Azure Cosmos DB</td></tr><tr><td>3</td><td>Azure Data Explorer</td></tr><tr><td>4</td><td>Azure SQL</td></tr><tr><td>5</td><td>Dapr</td></tr><tr><td>6</td><td>Event Grid</td></tr><tr><td>7</td><td><a href="https://azure.github.io/jpazpaas/2024/02/22/Azure-functions-trigger-and-binding-series-eventhubs.html">Event Hubs</a></td></tr><tr><td>8</td><td>HTTP と Webhook</td></tr><tr><td>9</td><td><a href="https://azure.github.io/jpazpaas/2025/02/26/Azure-functions-trigger-and-binding-series-iothub.html">IoT Hub</a></td></tr><tr><td>10</td><td>Kafka</td></tr><tr><td>11</td><td>Mobile Apps</td></tr><tr><td>12</td><td>Notification Hubs</td></tr><tr><td>13</td><td><a href="https://azure.github.io/jpazpaas/2025/02/26/Azure-functions-trigger-and-binding-series-queue.html"> Queue Storage </a></td></tr><tr><td>14</td><td>Redis</td></tr><tr><td>15</td><td>RabbitMQ</td></tr><tr><td>16</td><td>SendGrid</td></tr><tr><td>17</td><td><a href="https://azure.github.io/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus.html">Service Bus</a></td></tr><tr><td>18</td><td>SignalR</td></tr><tr><td>19</td><td>Table Storage</td></tr><tr><td>20</td><td><a href="https://azure.github.io/jpazpaas/2024/02/22/Azure-functions-trigger-and-binding-series-timer.html">Timer</a></td></tr><tr><td>21</td><td>Twilio</td></tr></tbody></table><h1 id="関連リンク"><a href="#関連リンク" class="headerlink" title="関連リンク"></a>関連リンク</h1><p><a href="https://azure.github.io/jpazpaas/2023/08/24/azure-functions-words-relative-management.html">Azure Functions（関数アプリ）の内部アーキテクチャ概要や関連する用語について</a></p><br><br><hr><br><br><p>2025 年 09 月 08 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Azure Functions はイベントドリブンな処理を実装する手段を提供します。つまり、Azure Functions では何かしらの契機無くアプリケーションが動作するというシナリオは存在しておらず、何かしらのイベントによってアプリケーション コードが動作する仕組みとな</summary>
      
    
    
    
    
    <category term="Function App" scheme="https://komayama.github.io/jpazpaas/tags/Function-App/"/>
    
    <category term="トリガー・バインディング シリーズ" scheme="https://komayama.github.io/jpazpaas/tags/%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC%E3%83%BB%E3%83%90%E3%82%A4%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0-%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA/"/>
    
  </entry>
  
  <entry>
    <title>Azure Functions トリガー・バインディング シリーズ - Service Bus トリガー</title>
    <link href="https://komayama.github.io/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus.html"/>
    <id>https://komayama.github.io/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus.html</id>
    <published>2025-09-07T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.142Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-service-bus?tabs=isolated-process,extensionv5,extensionv3&pivots=programming-language-csharp">Service Bus トリガー</a> は Service Bus からイベントを読み取り実行される関数です。</p><p>Service Bus トリガーは、<a href="https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/service-bus-queues-topics-subscriptions">Service Bus のキューとトピック</a> に対し、それぞれ Service Bus キュー トリガーと Service Bus トピック トリガーの 2 種類のトリガーを設定できます。メッセージに対して、単一処理を行うか（キュー）、複数処理を行うか（トピック）により、トリガーを使い分けてご利用ください。なお、キューとトピックの処理は混在させることができないので、それぞれ異なるトリガー（Service Bus キュー トリガーと Service Bus トピック トリガー）を作る必要があります。<br>Service Bus のメッセージに対して、<a href="https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/message-transfers-locks-settlement#peeklock">PeekLock</a>  と呼ばれるロックを取得し、ロック更新することで動作します（外部ストレージにどこまで読んだかなどのメモなどは保持しません）。PeekLock では、メッセージの Complete または Abandon を呼び出してメッセージの終わりを示します。</p><h2 id="ロックについて"><a href="#ロックについて" class="headerlink" title="ロックについて"></a>ロックについて</h2><p>PeekLock について、Service Bus のキューとサブスクリプションには既定の<a href="https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/message-transfers-locks-settlement#renew-locks">ロック期間 1 分</a> があります。このロックを更新し、ロック状態を維持することを host.json の <a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-service-bus?tabs=in-process,extensionv5,extensionv3&pivots=programming-language-csharp#hostjson-settings">maxAutoLockRenewalDuration</a> (規定 5 分) にて定義できます。既定では 1 分ごとに 4 回のロックが更新されます。メッセージのロックが解除され、再度メッセージが<br>取得されると、DeliveryCount (配信回数と呼ばれメッセージの読み取り回数上限で、既定では 10 が最大) がインクリメントされ、最大配信回数に至ると<a href="https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/service-bus-dead-letter-queues">配信不能キュー(Dead Letter Queue)</a>にメッセージが移動されます。</p><p>別のクライアントによるメッセージの処理を避けるために、Azure Functions にて実装しているアプリケーションの処理時間と同じ以上の長さ maxAutoLockRenewalDuration を設定しておく必要があります。</p><p>Service Bus キューの参考画面：</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-a169cc6d-efc3-4434-b6a4-6985c8613529.png" alt="image-a169cc6d-efc3-4434-b6a4-6985c8613529.png"></p><p>PeekLock 時の Complete または Abandon は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-service-bus-trigger?tabs=python-v2,isolated-process,nodejs-v4,extensionv5&pivots=programming-language-csharp#peeklock-behavior">オートコンプリート</a> と呼ばれる機能で Azure Functions が自動で行うことができます。関数の実行に応じて、Complete (実行完了としてメッセージの破棄) または Abandon が自動で呼び出されます。規定ではオートコンプリートは true となっていますが、false とした場合には、アプリケーション コード内でそれぞれのメッセージに対して明示的に <a href="https://learn.microsoft.com/ja-jp/dotnet/api/microsoft.servicebus.messaging.queueclient.complete?view=azure-dotnet#Microsoft_ServiceBus_Messaging_QueueClient_Complete_System_Guid_">Complete</a>  または <a href="https://learn.microsoft.com/ja-jp/dotnet/api/microsoft.servicebus.messaging.queueclient.abandon?view=azure-dotnet">Abandon</a>  を呼び出す必要があります。</p><h2 id="セッションについて"><a href="#セッションについて" class="headerlink" title="セッションについて"></a>セッションについて</h2><p>Service Bus では、<a href="https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/message-sessions">セッション</a> と呼ばれる概念があります。各メッセージにセッション ID をメタデータとして保持できます。Service Bus トリガーでは、<a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-service-bus-trigger?tabs=python-v2,isolated-process,nodejs-v4,extensionv5&pivots=programming-language-csharp#attributes">IsSessionsEnabled 属性</a>を有効化することで、セッション機能を使用することができます。利用する Service Bus キューやサブスクリプションについても作成時にセッションを有効化しないとこの機能は使えないことをご留意ください。  </p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-7b4370e9-4a7b-44fb-81ec-ecae48191898.png" alt="image-7b4370e9-4a7b-44fb-81ec-ecae48191898.png"></p><h1 id="作成手順"><a href="#作成手順" class="headerlink" title="作成手順"></a>作成手順</h1><p>Service Bus トリガーの作成方法は<a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-create-your-first-function-visual-studio#create-a-function-app-project">チュートリアル</a>で紹介されているテンプレートをご利用ください。チュートリアルでは HTTP トリガーを利用しておりますが、同画面にて Service Bus キュー トリガーまたは Service Bus トピック トリガーを選択いただけます。選択いただいたトリガーに応じて <a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-service-bus-trigger?tabs=python-v2,isolated-process,nodejs-v4,extensionv5&pivots=programming-language-csharp#attributes">属性</a> として定義するべき項目が異なるためご注意ください。</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-5759391f-c15d-43f5-af96-4339b5c6d06c.png" alt="image-5759391f-c15d-43f5-af96-4339b5c6d06c.png"></p><p>また、キュー、トピック名など各属性情報は、アプリケーション設定にて管理することができます。C# の例ですが、ServiceBusTrigger の引数で 各属性情報を <code>%</code> 括りのアプリケーション設定名とします(上段黄色枠)。ローカルの実行のため local.settings.json となりますが(下段黄色枠)、設定値の中身を宣言します。</p><p>Service Bus の <a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-service-bus-trigger?tabs=python-v2,isolated-process,nodejs-v4,extensionv5&pivots=programming-language-csharp#connection-string">接続文字列</a> については <code>connection</code> プロパティで指定した値と一致する名前のアプリケーション設定を定義する、または、<code>connection</code> プロパティで指定した値に “AzureWebJobs” の接頭字を付与してアプリケーション設定で定義する（青色枠）ことが可能です。</p><p>Azure 上の Azure Functions リソースの場合には local.settings.json にて定義いただいた同項目をアプリケーション設定に設定ください。</p><p>Service Bus キュー トリガー例：</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-2b6bf99e-c9d3-457b-a626-9521cd74c098.png" alt="image-2b6bf99e-c9d3-457b-a626-9521cd74c098.png"></p><p>Service Bus トピック トリガー例：</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-9118de59-a23c-4aee-97f3-22751b08ee74.png" alt="image-9118de59-a23c-4aee-97f3-22751b08ee74.png"></p><h1 id="実行状況をログで確認する"><a href="#実行状況をログで確認する" class="headerlink" title="実行状況をログで確認する"></a>実行状況をログで確認する</h1><p>Service Bus トリガーの実行詳細をログから確認します。host.json の logging で下記のカテゴリのログを出力するように設定します。デバッグ用となるため、運用状況によって有効/無効化を検討ください。</p><h2 id="host-json"><a href="#host-json" class="headerlink" title="host.json"></a>host.json</h2><pre><code>&quot;logging&quot;: &#123;  &quot;logLevel&quot;: &#123;    &quot;Host.General&quot;: &quot;Debug&quot;,    &quot;Function&quot;: &quot;Debug&quot;,    &quot;Microsoft.Azure.WebJobs.Hosting&quot;: &quot;Debug&quot;,    &quot;Microsoft.Azure.WebJobs.ServiceBus&quot;: &quot;Debug&quot;,    &quot;Azure.Messaging.ServiceBus&quot;: &quot;Debug&quot;  &#125;&#125;</code></pre><h2 id="Application-Insights-で利用するクエリ"><a href="#Application-Insights-で利用するクエリ" class="headerlink" title="Application Insights で利用するクエリ"></a>Application Insights で利用するクエリ</h2><pre><code>traces| where timestamp &gt; datetime(&quot;yyyy-mm-dd hh:mi&quot;)| where customDimensions.Category startswith &quot;Microsoft.Azure.WebJobs.ServiceBus&quot; or customDimensions.Category startswith &quot;Azure.Messaging.ServiceBus&quot; or operation_Name =~ &quot;&lt;関数名&gt;&quot;| project timestamp, message, customDimensions| order by timestamp asc</code></pre><p>上記の設定を行った際に記録されるログの例です。</p><h3 id="メッセージ取得"><a href="#メッセージ取得" class="headerlink" title="メッセージ取得"></a>メッセージ取得</h3><p>Azure Functions Host で Service Bus クライアント、Service Bus レシーバーの作成、Service Bus への認証を行い（黄色枠）、メッセージ受信を行うポーリング処理（赤色枠の <code>ReceiveBatchAsync</code> の処理）を行っていることが記録されています。</p><p>Service Bus キュー トリガー例：</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-38465d84-1d28-4147-bf7e-af98e4a659b1.png" alt="image-38465d84-1d28-4147-bf7e-af98e4a659b1.png"></p><p>Service Bus トピック トリガー例：</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-82255ffb-feb0-48fb-847b-69e01d76bf60.png" alt="image-82255ffb-feb0-48fb-847b-69e01d76bf60.png"></p><h3 id="実行ログ"><a href="#実行ログ" class="headerlink" title="実行ログ"></a>実行ログ</h3><p>Service Bus よりメッセージ取得されたことで、トリガーの実行され <code>Executing~</code> と <code>Executed~</code> に合わせて <code>Trigger Details:~</code> が記録されています。<code>Trigger Details:~</code> となっているログでは、Service Bus の<a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-service-bus-trigger?tabs=python-v2,isolated-process,nodejs-v4,extensionv5&pivots=programming-language-csharp#message-metadata">メタ データ</a> が確認でき配信回数、エンキュー時刻やシーケンス番号などが記録されます。</p><p>Service Bus キュー トリガー例：</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-e184c18b-7138-4f2d-ac19-baceee3a76a3.png" alt="image-e184c18b-7138-4f2d-ac19-baceee3a76a3.png"></p><p>Service Bus トピック トリガー例：</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-c08c6f4e-06b2-4aa7-b145-1949f46447f4.png" alt="image-c08c6f4e-06b2-4aa7-b145-1949f46447f4.png"></p><h3 id="ロックの更新"><a href="#ロックの更新" class="headerlink" title="ロックの更新"></a>ロックの更新</h3><p>60 秒以上処理時間がかかるアプリケーション（実行ログは青色ハイライト）を実装しています。メッセージを受信したことにより 1:48:49 に処理開始をしています。その後、Service Bus 側のロック期間を超過しないように 1 分以内（下記ログでは 1:49:39 に実施）にロックの更新（RenewMessageLock）を行っていることが確認できます（ロック処理の一連は黄色ハイライト）。最終的に関数実行が完了したことで、Complete （緑色ハイライト）をしています。</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-e30fb6f5-20d1-4f61-a870-630f87d23017.png" alt="image-e30fb6f5-20d1-4f61-a870-630f87d23017.png"></p><h1 id="並行処理とチューニング"><a href="#並行処理とチューニング" class="headerlink" title="並行処理とチューニング"></a>並行処理とチューニング</h1><h2 id="並行処理の考え方"><a href="#並行処理の考え方" class="headerlink" title="並行処理の考え方"></a>並行処理の考え方</h2><p>Service Bus トリガーには「単一ディスパッチ処理」「単一ディスパッチ処理(セッションベース)」「バッチ処理」の 3 つの実行モデルがあります。選択いただいた実行モデルに基づきメッセージを何件ずつ処理するかが異なります。また、この構成は Service Bus キュー トリガーと Service Bus トピック トリガー共通となります。</p><p>上記の実行モデルは <strong>IsBatched</strong> と <strong>IsSessionsEnabled</strong> の 2 つの属性の組み合わせによって決まります。また実行数に関するプロパティとして、<strong>maxConcurrentCalls</strong>、<strong>maxConcurrentSessions</strong>、<strong>maxMessageBatchSize(maxMessageCount)</strong> がありますが、実行モデルによって有効なプロパティが異なるので留意する必要があります。<br>実行モデルに対応する組み合わせと実行数の制御を行うプロパティについては <a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-target-based-scaling?tabs=v5,csharp#service-bus-queues-and-topics">こちら</a> に紹介がございます。  </p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-55fe0f8f-c0fb-466c-a499-ed1d99603f1d.png" alt="image-55fe0f8f-c0fb-466c-a499-ed1d99603f1d.png"></p><h3 id="単一ディスパッチ処理"><a href="#単一ディスパッチ処理" class="headerlink" title="単一ディスパッチ処理"></a>単一ディスパッチ処理</h3><p>関数が 1 回実行されるとメッセージは 1 件だけ処理されます。<br>1 インスタンスで並行処理されるメッセージ数を <strong>maxConcurrentCalls</strong> プロパティで制御できます。<br>下記は、.NET 分離ワーカモデルでの実装サンプルです。関数が 1 回実行されるとメッセージは 1 件だけ処理されますので、受け付ける型は <code>ServiceBusReceivedMessage</code> です。</p><pre><code>[Function(nameof(ServiceBusReceivedMessageFunction))][ServiceBusOutput(&quot;outputQueue&quot;, Connection = &quot;ServiceBusConnection&quot;)]public string ServiceBusReceivedMessageFunction(    [ServiceBusTrigger(&quot;queue&quot;, Connection = &quot;ServiceBusConnection&quot;)] ServiceBusReceivedMessage message)&#123;    _logger.LogInformation(&quot;Message ID: &#123;id&#125;&quot;, message.MessageId);    _logger.LogInformation(&quot;Message Body: &#123;body&#125;&quot;, message.Body);    _logger.LogInformation(&quot;Message Content-Type: &#123;contentType&#125;&quot;, message.ContentType);    var outputMessage = $&quot;Output message created at &#123;DateTime.Now&#125;&quot;;    return outputMessage;&#125;</code></pre><p>Service Bus に複数メッセージがある場合でも 1 件ずつ受信され、それぞれ関数実行されることが確認できます。</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-37acc4d2-0fac-483a-a440-b702829dfa2f.png" alt="image-37acc4d2-0fac-483a-a440-b702829dfa2f.png"></p><h3 id="単一ディスパッチ処理-セッションベース"><a href="#単一ディスパッチ処理-セッションベース" class="headerlink" title="単一ディスパッチ処理 (セッションベース)"></a>単一ディスパッチ処理 (セッションベース)</h3><p>関数が 1 回実行されるとメッセージは 1 件だけ処理されます。<br>1 インスタンスで並行処理されるメッセージ数を <strong>maxConcurrentSessions</strong> プロパティで制御できます。<br>※基本的には前項の「単一ディスパッチ処理」と違いはなく、セッションベースか否かとなります。</p><h3 id="バッチ処理"><a href="#バッチ処理" class="headerlink" title="バッチ処理"></a>バッチ処理</h3><p>関数が 1 回実行されるとメッセージは N 件数分処理されます。最大で <strong>maxMessageBatchSize</strong> プロパティ件数分処理されます。<br>1 インスタンスでメッセージを並行処理はできません。<br>下記は、.NET 分離ワーカモデルでの実装サンプルです。関数が 1 回実行されるとメッセージは N 件処理されますので、受け付ける型は <code>ServiceBusReceivedMessage[]</code> です。</p><pre><code>[Function(nameof(ServiceBusReceivedMessageBatchFunction))]public void ServiceBusReceivedMessageBatchFunction(    [ServiceBusTrigger(&quot;queue&quot;, Connection = &quot;ServiceBusConnection&quot;, IsBatched = true)] ServiceBusReceivedMessage[] messages)&#123;    foreach (ServiceBusReceivedMessage message in messages)    &#123;        _logger.LogInformation(&quot;Message ID: &#123;id&#125;&quot;, message.MessageId);        _logger.LogInformation(&quot;Message Body: &#123;body&#125;&quot;, message.Body);        _logger.LogInformation(&quot;Message Content-Type: &#123;contentType&#125;&quot;, message.ContentType);    &#125;&#125;</code></pre><p>ログからも一回の関数実行にて 2 つのメッセージが処理されていることを確認できます。</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-724c46c8-6c6f-4026-a46c-414d157109c4.png" alt="image-724c46c8-6c6f-4026-a46c-414d157109c4.png"></p><h1 id="よくお問い合わせいただく動作"><a href="#よくお問い合わせいただく動作" class="headerlink" title="よくお問い合わせいただく動作"></a>よくお問い合わせいただく動作</h1><p>弊サポートにてよくお問い合わせいただく事例について紹介します。なお、下記に記載しますログ出力例は、Function Host のランタイム バージョン が v4.1041.200.25360 時点の例となります。バージョンが異なることにより出力内容が異なる可能性がありますことをご留意ください。なお、ログは <a href="#application-insights-%E3%81%A7%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%82%AF%E3%82%A8%E3%83%AA">Application Insights で利用するクエリ</a> にて記載したクエリを実行した結果より確認しています。</p><h2 id="デプロイ後に-Service-Bus-トリガーが実行できない"><a href="#デプロイ後に-Service-Bus-トリガーが実行できない" class="headerlink" title="デプロイ後に Service Bus トリガーが実行できない"></a>デプロイ後に Service Bus トリガーが実行できない</h2><p>Azure 上に展開した後に動作しない場合の代表的な原因のひとつに、Service Bus の接続情報が正しく設定されていないことがあります。接続文字列が正しくない場合、存在しないキューやトピックを指定している場合、Service Bus 側のネットワーク制限によりアクセス拒否されている場合、Azure Fucntions にて VNet 統合を使用している際に NSG（Network Security Group） により Service Bus への通信が阻害されている場合などがあります。下記のようなログが記録されている場合は設定を見直していただくことで、事象が解消する可能性があります。</p><ul><li><p>接続文字列が正しくなく 401 エラーが発生</p><p>Azure Function にて設定している接続文字列が正しいか、有効期限内であるかをご確認ください。再設定をすることで正常に動作する可能性があります。</p><p><strong>traces ログ</strong></p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-16c4b7aa-ecba-4915-afdb-d257ba4f9034.png" alt="image-16c4b7aa-ecba-4915-afdb-d257ba4f9034.png"></p><p>また Service Bus 名前空間より [概要] ブレードの ”ローカル認証” の設定にて SAS キー認証が有効となっているかも併せてご確認ください。</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-c0662c24-78a8-419f-887d-65c15e13b2a8.png" alt="image-c0662c24-78a8-419f-887d-65c15e13b2a8.png"></p></li><li><p>存在しないキューを指定したため 404 エラーが発生</p><p>Azure Function におけるキューやトピック/サブスクリプションの設定が正しいか、Service Bus に対象が存在するかをご確認ください。また使用している接続文字列にて対象のキューやトピック/サブスクリプションが参照できる権限があるかについてもご確認ください。</p></li></ul><p>  <strong>traces ログ</strong></p><p>  <img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-2943cbff-dc56-4377-903b-c472f9818b88.png" alt="image-2943cbff-dc56-4377-903b-c472f9818b88.png"></p><ul><li><p>Service Bus 側のネットワーク制限により 401 エラーが発生</p><p>Service Bus のネットワーク設定をご確認いただき、Azure Function の送信 IP アドレスが許可されていることを確認してください。</p><p><strong>traces ログ</strong></p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-1646136c-254d-401b-a847-031d6550b846.png" alt="image-1646136c-254d-401b-a847-031d6550b846.png"></p><p>Service Bus 名前空間の [ネットワーク] ブレードにて許可されている IP アドレスが確認できます。</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-1d091cb7-5b70-4117-b987-729b9bda0f46.png" alt="image-1d091cb7-5b70-4117-b987-729b9bda0f46.png"></p><p>既定では Azure Functions の送信 IP アドレスは使用可能なアドレスの内 1つを使用するため、全てのアドレスを許可いただく必要があります。IP アドレスの確認方法は <a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/ip-addresses?tabs=portal#find-outbound-ip-addresses">こちら</a> を参照ください。</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-ae532b9a-333e-46a5-b891-38c80e9f55de.png" alt="image-ae532b9a-333e-46a5-b891-38c80e9f55de.png"></p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-how-to-use-nat-gateway">Azure 仮想ネットワーク NAT ゲートウェイを使用して Azure Functions の送信 IP を制御</a> し、送信 IP アドレスを固定化をすることで特定の IP アドレスのみ許可いただくことでも実現いただけます。</p></li><li><p>NSG により Service Bus へ通信できない状況でソケットエラーが発生</p><p>Azure Function に統合いただいている VNet の NSG により、Outbound 通信が制限されていないかをご確認ください。</p><p><strong>traces ログ</strong></p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-20c95a59-bd18-4e98-a26b-e88352ff1268.png" alt="image-20c95a59-bd18-4e98-a26b-e88352ff1268.png"></p><p>Azure Function に統合いただいている VNet の NSG のOutbound 通信の設定として、 ServiceBus のサービス タグで <a href="https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/service-bus-faq#----------------------------">Service Bus の通信に必要なポート（5671, 5672, 443）</a> を許可する必要があります。なお、その他に　Azure Function に必要な通信設定はここでは割愛しているため、お客様の通信要件に合わせてその他設定もする必要があることをご留意ください。</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-2906e519-13c9-4fa6-979d-422de7b2f89c.png" alt="image-2906e519-13c9-4fa6-979d-422de7b2f89c.png"></p></li></ul><h2 id="Message-processing-error-という例外が発生した"><a href="#Message-processing-error-という例外が発生した" class="headerlink" title="Message processing error という例外が発生した"></a>Message processing error という例外が発生した</h2><p>ロック機構に関連してエラーが発生しています。 ServiceBus.ServiceBusException の内容を確認することで詳細なエラーが確認でき、下記の例ではアプリケーション処理時間が maxAutoLockRenewalDuration にて定義しているロック更新期間を超えた際のログとなります。Service Bus におけるロックの状態や実際のアプリケーションの処理時間を確認することで原因を切り分けいただけます。</p><p>  <strong>traces ログ</strong></p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-5f8bac8d-665c-4e35-8a5b-a82cc03ca23c.png" alt="image-5f8bac8d-665c-4e35-8a5b-a82cc03ca23c.png"></p><p>エラーが発生した際は Service Bus 側のメッセージ状態を確認し、状況に応じて対処ください。</p><ul><li><p>メッセージがキューやトピックに残存している場合</p><p>自動で再試行されるため、対処不要となります。下記の例では処理失敗したメッセージの配信回数がインクリメントされた状態となります。再度メッセージ受信されることで処理されます。Service Bus のキューやトピックの [Service Bus エクスプローラー] ブレードより下記の画面をご確認いただけます。</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-4a464d96-79e6-4273-8712-82a2777db081.png" alt="image-4a464d96-79e6-4273-8712-82a2777db081.png"></p></li><li><p>配信不能キューにメッセージが存在する場合</p><p>対象のメッセージのプロパティを確認することで、配信不能になった理由を確認できます。下記例では最大配信回数超過によりメッセージが移動されていますので、アプリケーションが処理できる状態であるか、処理時間に問題はないかなどをご確認いただいた上で、メッセージの再送信をすることで復旧いただける可能性があります。Service Bus のキューやトピックの [Service Bus エクスプローラー] ブレードより下記の画面をご確認いただけます。</p><p><img src="/jpazpaas/2025/09/08/Azure-functions-trigger-and-binding-series-servicebus/image-a0d39151-c6ee-4c6c-93a2-c5cf01d06e6f.png" alt="image-a0d39151-c6ee-4c6c-93a2-c5cf01d06e6f.png"></p></li></ul><ul><li><p>メッセージが配信不能キューを含め、キューやトピックに存在しない場合</p><p>再試行処理などにより処理が完了している状態となりますので、正常終了しています。</p></li></ul><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>本ブログでは Service Bus トリガー関数の動作及び作成方法について整理しました。Service Bus トリガーのトラブルシューティングの参考になれば幸いです。</p><h1 id="参考ドキュメント"><a href="#参考ドキュメント" class="headerlink" title="参考ドキュメント"></a>参考ドキュメント</h1><p><a href="https://azure.github.io/jpazpaas/2023/08/24/azure-functions-words-relative-management.html">Azure Functions（関数アプリ）の内部アーキテクチャ概要や関連する用語について</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-service-bus?tabs=isolated-process,extensionv5,extensionv3&pivots=programming-language-csharp">Azure Functions における Azure Service Bus のバインド</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/service-bus-queues-topics-subscriptions">Azure Service Bus のメッセージング - キュー、トピック、およびサブスクリプション - Azure Service Bus</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/message-sessions">Azure Service Bus のメッセージ セッション - Azure Service Bus</a></p><p><a href="https://learn.microsoft.com/ja-jp/azure/service-bus-messaging/message-transfers-locks-settlement">Azure Service Bus メッセージの転送、ロック、および解決 - Azure Service Bus</a><br><br><br><br></p><hr><br><br><p>2025 年 09 月 08 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-functions/functions-bindings-service-bus?tabs=isolated-process,extensionv5,extensi</summary>
      
    
    
    
    
    <category term="Function App" scheme="https://komayama.github.io/jpazpaas/tags/Function-App/"/>
    
    <category term="トリガー・バインディング シリーズ" scheme="https://komayama.github.io/jpazpaas/tags/%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC%E3%83%BB%E3%83%90%E3%82%A4%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0-%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA/"/>
    
  </entry>
  
  <entry>
    <title>Azure Functions で使用している CDN ドメインの移行について</title>
    <link href="https://komayama.github.io/jpazpaas/2025/09/05/Migration-of-functionscdn.azureedge.net-Subdomain.html"/>
    <id>https://komayama.github.io/jpazpaas/2025/09/05/Migration-of-functionscdn.azureedge.net-Subdomain.html</id>
    <published>2025-09-04T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.142Z</updated>
    
    <content type="html"><![CDATA[<p>お世話になっております。App Service サポート担当の仲野です。いつも Azure Functions（関数アプリ）をご利用いただき誠にありがとうございます。Azure Functions では拡張バンドルのコンテンツを Contents Delivery Network（CDN） を使用して取得しています。これまで使用していた CDN プロバイダーの運用の停止に伴い、Azure Functions では新たな CDN よりコンテンツの配布を行うようになりました。本記事は CDN ドメインの移行の詳細、それに伴う影響についてを解説します。</p><h1 id="Azure-Functions-で使用している-CDN-移行について"><a href="#Azure-Functions-で使用している-CDN-移行について" class="headerlink" title="Azure Functions で使用している CDN 移行について"></a>Azure Functions で使用している CDN 移行について</h1><p><a href="https://learn.microsoft.com/ja-jp/previous-versions/azure/cdn/edgio-retirement-faq">Azure CDN from Edgio の廃止に関する FAQ</a> にて言及されているように、2025 年 1 月 15 日に Edgio 社にて提供されているサービスが終了され、それに伴い CDN サービスの移行が行われました。移行前後で使用されている CDN のドメインは下記の通りとなります。</p><p><strong>移行前の CDN ドメイン</strong></p><ul><li>functionscdn.azureedge.net</li><li>functionscdnstaging.azureedge.net</li></ul><p><strong>移行後の CDN ドメイン</strong></p><ul><li>cdn.functions.azure.com</li><li>cdn-staging.functions.azure.com</li></ul><h1 id="各種ツールの-CDN-ドメイン対応状況"><a href="#各種ツールの-CDN-ドメイン対応状況" class="headerlink" title="各種ツールの CDN ドメイン対応状況"></a>各種ツールの CDN ドメイン対応状況</h1><p>Azure Functions にて提供されている各種ツールにおいても CDN ドメインの移行対応が完了しています。例えば、Core Tools や Functions Host では、それぞれ下記のバージョン以降は CDN ドメインの移行がされています。</p><h2 id="Azure-Functions-Core-Tools"><a href="#Azure-Functions-Core-Tools" class="headerlink" title="Azure Functions Core Tools"></a>Azure Functions Core Tools</h2><ul><li><p>Azure Functions Core Tools：<a href="https://github.com/Azure/azure-functions-core-tools/releases/tag/4.0.7030">4.0.7030</a> 以降</p><p> 更新内容は <a href="https://github.com/Azure/azure-functions-core-tools/pull/4265">こちら</a> からご確認いただけます。</p><p> ローカル環境で動作している Core Tool のバージョンを確認する例として、コマンド プロンプトにて <code>func --version</code> を実行いただくことでご確認いただけます。</p><p> <img src="/jpazpaas/2025/09/05/Migration-of-functionscdn.azureedge.net-Subdomain/image-3209480f-4274-4762-a67a-5dfc2b98453e.png" alt="image-3209480f-4274-4762-a67a-5dfc2b98453e.png"></p></li></ul><h2 id="Functions-Host"><a href="#Functions-Host" class="headerlink" title="Functions Host"></a>Functions Host</h2><ul><li><p>Functions Host：<a href="https://github.com/Azure/azure-functions-host/releases/tag/v4.1038.100">4.1038.100</a> 以降</p><p> 更新内容は Github の Issue（<a href="https://github.com/Azure/azure-functions-host/pull/10816">#10816</a>、<a href="https://github.com/Azure/azure-functions-host/pull/10817">#10817</a>、<a href="https://github.com/Azure/azure-functions-host/pull/10824">#10824</a>、<a href="https://github.com/Azure/azure-functions-host/pull/10847">#10847</a>）よりご確認いただけます。</p><p> 動作している Functions Host のバージョンは Azure Portal にて対象の Azure Functions の [概要] ブレードよりご確認いただけます。 </p><p> <img src="/jpazpaas/2025/09/05/Migration-of-functionscdn.azureedge.net-Subdomain/image-d2130638-996a-4210-90c5-abb8479f6337.png" alt="image-d2130638-996a-4210-90c5-abb8479f6337.png"></p></li></ul><h1 id="CDN-移行に伴う影響について"><a href="#CDN-移行に伴う影響について" class="headerlink" title="CDN 移行に伴う影響について"></a>CDN 移行に伴う影響について</h1><h2 id="影響"><a href="#影響" class="headerlink" title="影響"></a>影響</h2><p>CDN ドメインの移行は既に完了しており、旧 CDN プロバイダーにて使用されていた移行前のドメインについては動作保証されない状況となります。そのため、執筆時点において使用しているドメインの移行が完了していない場合、Azure Functions が正常に動作しなくなる可能性があります。</p><p>以下のようなユースケースで影響が発生しますので、お手元の環境に該当するものがないかご確認ください。</p><ul><li>ユーザー コードにて移行前のドメインに直接的な依存を設けている場合</li><li>Firewall 等で対象の移行後のドメインが通信許可されていない場合</li><li>Core Tools や Functions Host などのバージョンが最新化されていない場合</li></ul><h2 id="対策"><a href="#対策" class="headerlink" title="対策"></a>対策</h2><p>移行後のドメインは、移行前のドメインとエンドポイント互換性があるため、移行前のドメインから使用可能なすべてのリソースは、移行後のドメインを通じて使用可能なため速やかに下記の対策をご検討ください。</p><ul><li>対象のドメインへ直接的な依存関係がある場合には移行後のドメインに更新ください。</li><li>Firewall 等で移行後のドメインが通信許可されるよう設定ください。</li><li>Core Tools や Functions Host などのバージョンを最新化ください。</li></ul><h1 id="参考ドキュメント"><a href="#参考ドキュメント" class="headerlink" title="参考ドキュメント"></a>参考ドキュメント</h1><p><a href="https://learn.microsoft.com/ja-jp/previous-versions/azure/cdn/edgio-retirement-faq">Azure CDN from Edgio の廃止に関する FAQ</a></p><p><a href="https://github.com/Azure/Azure-Functions/issues/2576">Clarification on Migration of functionscdn.azureedge.net Subdomain</a></p><p><a href="https://github.com/Azure/azure-functions-extension-bundles/issues/474">Critical Notice: Bundles are now hosted from cdn.functions.azure.com</a></p><p><a href="https://github.com/Azure/azure-functions-core-tools/issues/4260">Critical Notice: Core Tools is now hosted from cdn.functions.azure.com</a></p><br><br><hr><br><br><p>2025 年 09 月 05 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;お世話になっております。App Service サポート担当の仲野です。いつも Azure Functions（関数アプリ）をご利用いただき誠にありがとうございます。Azure Functions では拡張バンドルのコンテンツを Contents Delivery Netw</summary>
      
    
    
    
    
    <category term="Function App" scheme="https://komayama.github.io/jpazpaas/tags/Function-App/"/>
    
  </entry>
  
  <entry>
    <title>Azure Communication Services メール機能でよく頂くご質問</title>
    <link href="https://komayama.github.io/jpazpaas/2025/09/08/ACS-Email-Onboarding-FAQ.html"/>
    <id>https://komayama.github.io/jpazpaas/2025/09/08/ACS-Email-Onboarding-FAQ.html</id>
    <published>2025-08-09T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.142Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Communication Services (以下 ACS) のサポートチームです。</p><p><a href="https://techcommunity.microsoft.com/blog/exchange/exchange-online-to-retire-basic-auth-for-client-submission-smtp-auth/4114750">Exchange Online SMTP 基本認証廃止 </a> 等をきっかけに、ACS メール機能のご利用をご検討くださり、ありがとうございます。本記事では、ACS のメール機能をご利用いただく方に向けて、よく頂くご質問をおまとめしております。本情報がご参考になりましたら幸いでございます。</p><h2 id="ACS-メール機能では-SMTP-AUTH-基本認証はサポートされていますか？"><a href="#ACS-メール機能では-SMTP-AUTH-基本認証はサポートされていますか？" class="headerlink" title="ACS メール機能では SMTP AUTH 基本認証はサポートされていますか？"></a>ACS メール機能では SMTP AUTH 基本認証はサポートされていますか？</h2><p>SMTP AUTH 基本認証はサポートされております。</p><p>基本認証を利用してメール送信する際のセットアップは<a href="https://learn.microsoft.com/ja-jp/azure/communication-services/quickstarts/email/send-email-smtp/smtp-authentication?tabs=built-in-role">簡易メール転送プロトコル (SMTP) 認証の資格情報を作成する</a> をご確認ください。</p><h2 id="先端認証は利用できますか？"><a href="#先端認証は利用できますか？" class="headerlink" title="先端認証は利用できますか？"></a>先端認証は利用できますか？</h2><p>はい、ACS メール機能では先端認証もサポートされています。</p><p>先端認証として、XOauth2 を利用したメール送信の<a href="https://learn.microsoft.com/ja-jp/azure/communication-services/quickstarts/email/send-email-smtp/send-email-smtp-oauth">チュートリアル</a>をご覧ください。</p><h1 id="送信元メールアドレスについて"><a href="#送信元メールアドレスについて" class="headerlink" title="送信元メールアドレスについて"></a>送信元メールアドレスについて</h1><h2 id="送信元メールアドレスとして利用できるドメインはどのような種類がありますか？"><a href="#送信元メールアドレスとして利用できるドメインはどのような種類がありますか？" class="headerlink" title="送信元メールアドレスとして利用できるドメインはどのような種類がありますか？"></a>送信元メールアドレスとして利用できるドメインはどのような種類がありますか？</h2><p>ACS からメールを送信する際に利用できるドメイン種別にはマネージドドメインとカスタムドメインがあります。</p><p>マネージドドメインは、<code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.azurecomm.net</code> 形式でお客様に払い出される弊社管理のドメインとなります。<a href="https://learn.microsoft.com/ja-jp/azure/communication-services/quickstarts/email/add-azure-managed-domains?pivots=platform-azp">マネージドドメイン追加のチュートリアル</a> にありますように、Azure ポータルから払い出すことができます。</p><p>マネージドドメインには、<code>donotreply@xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.azurecomm.net</code> から送信元メールアドレスを変更できない、１分間や１時間にメール送信できる数が極めて低く、引き上げることができないといった<a href="https://learn.microsoft.com/ja-jp/azure/communication-services/quickstarts/email/add-azure-managed-domains?pivots=platform-azp#azure-managed-domains-compared-to-custom-domains">制限</a>があります。そのため、本番環境ではカスタムドメインが一般に利用されると考えております。</p><p>カスタムドメインは、お客様管理の任意のドメインです。カスタムドメインを ACS に追加し、同ドメインを ACS から送信するメールの送信元メールアドレスのドメインにすることができます。</p><p>カスタムドメインを ACS に追加するためには、ドメインの所有権を検証するための TXT レコード、SFP TXT レコード、DKIM CNAME レコードをそれぞれ同ドメインのレジストラーに設定していただく必要がございます。　手順は、<a href="https://learn.microsoft.com/ja-jp/azure/communication-services/quickstarts/email/add-custom-verified-domains?pivots=platform-azp">カスタムドメインを ACS へ追加する手順</a>をご確認ください。</p><h2 id="onmicrosoft-com-は-ACS-の送信元ドメインとして使えますか？"><a href="#onmicrosoft-com-は-ACS-の送信元ドメインとして使えますか？" class="headerlink" title="onmicrosoft.com は ACS の送信元ドメインとして使えますか？"></a>onmicrosoft.com は ACS の送信元ドメインとして使えますか？</h2><p>onmicrosoft.com は ACS としてはカスタムドメインの扱いでございます。<br>onmicrosoft.com では、お客様にて DKIM CNAME レコードを追加できず、カスタムドメインとして ACS でご利用いただけません。</p><h2 id="送信元メールアドレスの-より前のユーザー名を-donotreply-以外にできますか？"><a href="#送信元メールアドレスの-より前のユーザー名を-donotreply-以外にできますか？" class="headerlink" title="送信元メールアドレスの @ より前のユーザー名を donotreply 以外にできますか？"></a>送信元メールアドレスの @ より前のユーザー名を donotreply 以外にできますか？</h2><p>マネージドドメインではできませんが、カスタムドメインでは donotreply 以外のユーザー名をご利用いただけます。</p><p>手順・<a href="https://learn.microsoft.com/ja-jp/azure/communication-services/quickstarts/email/add-multiple-senders?pivots=platform-azp#create-multiple-sender-usernames">複数の送信者ユーザー名を作成する</a> を参考に、「Email Communication Services Domain」・「Mailfrom addresses」の「Add」ボタンから新しいユーザー名の送信元メールアドレスを作成してください。</p><p>なお、「Add」ボタンは既定の送信数の制限ではグレーアウトされて操作できないようになっております。<br>後述の「送信数の制限」クォータ引き上げのサポートリクエストをご発行ください。</p><h1 id="送信数の制限について"><a href="#送信数の制限について" class="headerlink" title="送信数の制限について"></a>送信数の制限について</h1><h2 id="送信数の制限はありますか？"><a href="#送信数の制限はありますか？" class="headerlink" title="送信数の制限はありますか？"></a>送信数の制限はありますか？</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/service-limits#email">サービス制限</a> に記載しております通り、１分、１時間当たりに送信できるメール数に制限（クォータ）がございます。</p><h2 id="送信数の制限は引き上げられますか？"><a href="#送信数の制限は引き上げられますか？" class="headerlink" title="送信数の制限は引き上げられますか？"></a>送信数の制限は引き上げられますか？</h2><p>マネージドドメインは引き上げられませんが、カスタムドメインは引き上げられます。</p><h2 id="送信数の制限を引き上げるにはどうすればいいですか。"><a href="#送信数の制限を引き上げるにはどうすればいいですか。" class="headerlink" title="送信数の制限を引き上げるにはどうすればいいですか。"></a>送信数の制限を引き上げるにはどうすればいいですか。</h2><p>クォータ引き上げのためのサポートリクエストを ACS 宛にご発行ください。サポートリクエストには、<a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/email/email-quota-increase#5-request-an-email-quota-increase">審査に必要な情報</a> を日本語で問題ございませんので記載ください。<br>審査の上、送信数の制限が引き上げられます。審査には３営業日ほどかかる場合もございますことご留意ください。</p><h2 id="大量のメールを送りたいのですが、どの程度の送信数を-ACS-はサポートできますか？"><a href="#大量のメールを送りたいのですが、どの程度の送信数を-ACS-はサポートできますか？" class="headerlink" title="大量のメールを送りたいのですが、どの程度の送信数を ACS はサポートできますか？"></a>大量のメールを送りたいのですが、どの程度の送信数を ACS はサポートできますか？</h2><p>以下<a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/service-limits#email">記載</a>ございます通り、1 時間あたり最大 100 万から 200 万メッセージのメール送信がサポートできます。</p><p>ただし、IP ウォームアップのために徐々に送信数の制限を引き上げていただく必要がございますので、ACS にてカスタムドメインからメール送信できるようになりましたら、お早めにクォータ引き上げのサポートリクエストをご発行いただくことをお勧めいたします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Azure Communication Services のメール サービスは、高スループットをサポートするように設計されています。</span><br><span class="line">ただし、このサービスには、お客様がオンボードを円滑に行い、新しいメール サービスに切り替えるときに発生する可能性のあるいくつかの問題を回避できるように、初期レート制限が設けられています。</span><br><span class="line"></span><br><span class="line">メールの配信状態を注意深く監視しながら、2 週間から 4 週間かけて、Azure Communication Services Email を使用するメールの量を少しずつ増やすことをお勧めします。</span><br><span class="line">このように段階的に増やすと、サード パーティのメール サービス プロバイダーはドメインのメール トラフィック用の IP の変更に適応できます。 </span><br><span class="line">少しずつ変更すると、送信者評価を保護し、メール配信の信頼性を維持する時間が得られます。</span><br><span class="line"></span><br><span class="line">Azure Communication Services のメール サービスでは、1 時間あたり最大 100 万から 200 万メッセージの大量のメッセージがサポートされます。</span><br></pre></td></tr></table></figure><h2 id="送信数のクォータ引き上げ審査でメール送信失敗率は加味されますか？"><a href="#送信数のクォータ引き上げ審査でメール送信失敗率は加味されますか？" class="headerlink" title="送信数のクォータ引き上げ審査でメール送信失敗率は加味されますか？"></a>送信数のクォータ引き上げ審査でメール送信失敗率は加味されますか？</h2><p>以下<a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/service-limits#failure-rate-requirements">記載</a>の通り加味されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">高いメール クォータを有効にするには、メールの失敗率が 1% 未満である必要があります。</span><br><span class="line">失敗率が高い場合は、クォータの引き上げを要求する前に問題を解決する必要があります。</span><br><span class="line">お客様は、失敗率を積極的に監視する必要があります。</span><br><span class="line">クォータの引き上げ後に失敗率が上がった場合、Azure Communication Services はお客様に連絡して、直ちに対処することを求め、解決のタイムラインを確認します。</span><br><span class="line">極端なケースでは、指定されたタイムライン内で失敗率が管理されない場合、Azure Communication Services は、問題が解決されるまでサービスを減らしたり中断したりする可能性があります。</span><br></pre></td></tr></table></figure><h2 id="失敗率の監視はどこからできますか？"><a href="#失敗率の監視はどこからできますか？" class="headerlink" title="失敗率の監視はどこからできますか？"></a>失敗率の監視はどこからできますか？</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/communication-services/concepts/analytics/insights/email-insights#failure-rate">失敗率</a> に記載がございますように、Azure ポータルの「Communication Service」リソース、「分析情報」ブレード、「メールの概要」タブから何通のうち何件のメール配信が成功・失敗したのか確認いただけます。</p><p>お客様の監視要件に応じてテスト・カスタマイズが必要ではありますが、KQL のサンプルは以下になります。失敗率監視のご検討の参考になりましたら幸いです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ACSEmailStatusUpdateOperational </span><br><span class="line">| where OperationName == &quot;DeliveryStatusUpdate&quot; and isnotempty(DeliveryStatus) and DeliveryStatus != &quot;OutForDelivery&quot;</span><br><span class="line">| summarize total=count(), failures=countif(DeliveryStatus != &quot;Delivered&quot; and DeliveryStatus != &quot;Suppressed&quot;)</span><br><span class="line">| extend rate=round(((failures * 100.0)/total),2)</span><br><span class="line">| extend label=&quot;Emails failed&quot;, TotalMessage=strcat(&#x27;out of &#x27;, total, &#x27;, &#x27;, rate,&#x27;% total Emails sent&#x27;)</span><br></pre></td></tr></table></figure><h1 id="ACS-でのメール受信について"><a href="#ACS-でのメール受信について" class="headerlink" title="ACS でのメール受信について"></a>ACS でのメール受信について</h1><h2 id="ACS-でメールを受け取ることはできますか？"><a href="#ACS-でメールを受け取ることはできますか？" class="headerlink" title="ACS でメールを受け取ることはできますか？"></a>ACS でメールを受け取ることはできますか？</h2><p>ACS にはメール受信機能が現状ございません。バウンスメールの受信等のために、お客様でメール受信サーバーを別途ご用意ください。</p><br><br><hr><br><br><p>2025 年 8 月 10 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Communication Services (以下 ACS) のサポートチームです。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://techcommunity.microsoft.com/blog/exchange/exchange-online</summary>
      
    
    
    
    
    <category term="ACS" scheme="https://komayama.github.io/jpazpaas/tags/ACS/"/>
    
    <category term="SMTP" scheme="https://komayama.github.io/jpazpaas/tags/SMTP/"/>
    
    <category term="Email" scheme="https://komayama.github.io/jpazpaas/tags/Email/"/>
    
  </entry>
  
  <entry>
    <title>ライフサイクル管理を設定する際の Blob の種類について</title>
    <link href="https://komayama.github.io/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management.html"/>
    <id>https://komayama.github.io/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management.html</id>
    <published>2025-08-03T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:02.802Z</updated>
    
    <content type="html"><![CDATA[<p>#目次<br><br>• はじめに<br><br>• 自動でログを削除するライフサイクル管理ポリシーの作成方法<br><br>• 作成したライフサイクル管理ポリシーの確認方法<br><br>• まとめ<br><br>• 3行要約<br><br><br><br></p><p>#はじめに<br><br>　<br>   Azure Monitor の出力するログ（以下の写真参照、[insights-logs-XXXX] ）を一定期間が経った後に消すために Azure Storage の Blob のライフサイクル管理の規則を入れたけれど、想定していた通りに消えないというお問い合わせをいただくことが時々あります。<br></p><p><img src="/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management/image-f37e20bb-3374-45c9-9d2b-443fcb4cecb8.png" alt="image-f37e20bb-3374-45c9-9d2b-443fcb4cecb8.png"></p><br><p>   このログは、診断設定で [他のストレージ アカウントに保存する] を選択したため出力される、対象アカウント（ここでは、「satest0829」）のログです。下記のスクリーンショットでは、「satest0829」 ストレージ アカウントの読み取り、上書き、削除のログを 「r40904mon」 ストレージ アカウントに出力させる診断設定になります。<br><br><br><img src="/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management/image-4122d2d6-0cad-4b10-8e4a-41bb5d0cc9bc.png" alt="image-4122d2d6-0cad-4b10-8e4a-41bb5d0cc9bc.png"></p><p>（診断設定の作成方法に関しては、以下の URL で確認出来ます。<br><br><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal%EF%BC%89">Azure Monitor の診断設定｜診断設定の作成</a>)<br><br></p><p>  ライフサイクル管理設定を行ったのにもかかわらず、このようなログが削除されない理由は、ライフサイクル管理ポリシーの対象がブロック BLOB のみになっていて、追加 BLOB を対象に入れていないことに起因します。<br><br></p><p>   では、診断設定を変えずに、このようなログを自動で削除するためのライフサイクル管理ポリシーを実際に構成してみましょう。<br><br><br><br></p><p>#自動でログを削除するライフサイクル管理ポリシーの作成方法 <br></p><ol><li><p>Azure Portal からログ出力対象のストレージ アカウントに移動します。<br></p></li><li><p>[データ管理] の [ライフサイクル管理] を選択し、[規則を追加 (Add a rule)] をクリックします。<br><br><br><img src="/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management/image-aa71c355-e66a-44ea-85c2-852809e1b965.png" alt="image-aa71c355-e66a-44ea-85c2-852809e1b965.png"></p></li><li><p>必要に応じて詳細を選択します。<br><br>ここで、Azure Monitor が出力する insights-logs-XXXX と表記されるコンテナー配下のログは追加 BLOB になるので、ポリシー作成時に [追加 BLOB (Append blobs)] を対象にする必要があります。<br><br><br><img src="/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management/image-9e96980e-1df0-4da2-af3d-faabe3eb7bdb.png" alt="image-9e96980e-1df0-4da2-af3d-faabe3eb7bdb.png"></p></li><li><p>条件（生成された後に実行するか、最後に修正された後に実行するか）を選択し、実行（削除）までの期間を設定し、[追加 (Add)] を選択します。<br><br><br><img src="/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management/image-bf1d6cc5-f86a-4bfd-a1a3-bc7bac4e918f.png" alt="image-bf1d6cc5-f86a-4bfd-a1a3-bc7bac4e918f.png"></p><br> <p>これで、ライフサイクル管理ポリシーの作成は完了です。<br><br></p></li></ol><p>  Azure Portal の他、PowerShell、Azure CLI 又は Azure Resource Manager テンプレートを使用してライフサイクル管理ポリシーを構成、編集する方法やその他の詳細については以下の URL で確認出来ます。<br><br><a href="https://docs.microsoft.com/ja-jp/azure/storage/blobs/lifecycle-management-policy-configure?tabs=azure-portal">ライフサイクル管理ポリシーを構成する</a><br><br><br></p><p>　＊ライフサイクル管理のポリシーを作成・更新してから有効になるまで最大 24 時間、さらに実行されるまでに 24 時間以上かかる場合がありますのでご注意ください。<br><br><br><br></p><p>　では、実際にログがライフサイクル管理ポリシーによって削除されたか確認する方法は何があるのでしょうか？<br><br><br></p><h3 id="•-件数だけの場合"><a href="#•-件数だけの場合" class="headerlink" title="• 件数だけの場合"></a>• 件数だけの場合<br></h3><p>メトリックで Delete Blob 実行の件数を一目で見ることが可能です。<br><br></p><p>Azure Monitor で Metrics に移動します。ストレージ アカウントの範囲を選択し適用すると、チャートが作成されます。その後、フィルターの [メトリック] 部分で [Transactions] を選択します。更に上の方にある [フィルターの追加 (Add Filter)] を選択し、[プロパティ (Property)] に [API name]、[値 (Value)] に [DeleteBlob] を入力すると、時間軸に沿った実行を確認することが出来ます。<br><br><br><img src="/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management/image-5a702bf3-c8f9-47a2-a5a4-f907c1af0cec.png" alt="image-5a702bf3-c8f9-47a2-a5a4-f907c1af0cec.png"><br><br></p><p>（その他のメトリック操作の詳細に関しては、以下の URL で確認出来ます。<br><br>    <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-charts">Azure Monitor のメトリックス エクスプローラーの高度な機能</a> )<br></p><p><br>ただし、このチャートにはライフサイクル管理ポリシーだけでなく、Azure Portal からの手動削除など、他の操作による Delete Blob も含まれます。そのため、実行数が多い場合は以下の Log Analytics を利用し、ライフサイクル管理ポリシーの実行状況を詳細に確認することが出来ます。<br><br></p><h3 id="•-詳細に確認する場合"><a href="#•-詳細に確認する場合" class="headerlink" title="• 詳細に確認する場合"></a>• 詳細に確認する場合<br></h3><br>$logs コンテナーに出力された診断ログから Delete Blob のオペレーションを確認することが可能です。この方法は、予め [診断ログ (クラシック)] から、ログの出力を有効化しておく必要があります。<br><p><br>[診断設定 (クラシック)] ログ出力設定例<br><img src="/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management/image-81d44b47-c906-4ff6-8615-7da8e25e5210.png" alt="image-81d44b47-c906-4ff6-8615-7da8e25e5210.png"></p><br>      下記出力例のように、<user-agent-header> フィールドに、"ObjectLifeCycleScanner" が出力されたエントリを確認することで、　　ライフサイクル管理によって行われたリクエストのログをご確認いただけます。<br><br>凡例 (バージョン 2.0 の場合)：            <version-number>;<request-start-time>;<operation-type>;<request-status>;<http-status-code>;<end-to-end-latency-in-ms>;<server-latency-in-ms>;<authentication-type>;<requester-account-name>;<owner-account-name>;<service-type>;<request-url>;<requested-object-key>;<request-id-header>;<operation-count>;<requester-ip-address>;<request-version-header>;<request-header-size>;<request-packet-size>;<response-header-size>;<response-packet-size>;<request-content-length>;<request-md5>;<server-md5>;<etag-identifier>;<last-modified-time>;<conditions-used>;<user-agent-header>;<referrer-header>;<client-request-id>;<user-object-id>;<tenant-id>;<application-id>;<audience>;<issuer>;<user-principal-name>;<reserved-field>;<authorization-detail>     <br>出力例 (バージョン 2.0 の場合)：        2.0;2025-07-18T19:17:16.5043171Z;DeleteBlob;TrustedAccessSasSuccess;202;13;13;TrustedAccessSas;;XXXXX;blob;"https://XXXXX.blob.core.windows.net:443/insights-logs-storageread/resourceId%3D/subscriptions/XXXXX/resourceGroups/XXXXX/providers/Microsoft.Storage/storageAccounts/XXXXX/blobServices/default/y%3D2024/m%3D10/d%3D18/h%3D12/m%3D00/PT1H.json?sv=2020-06-12&amp;ss=b&amp;srt=sco&amp;sp=rwdlacuptx&amp;se=2025-08-01T18%3A36%3A35.4416023Z&amp;spr=https&amp;sk=system-1&amp;sig=XXXXX&amp;timeout=10";"/XXXXX/insights-logs-storageread/resourceId=/subscriptions/XXXXX/resourceGroups/XXXXX/providers/Microsoft.Storage/storageAccounts/XXXXX/blobServices/default/y=2024/m=10/d=18/h=12/m=00/PT1H.json";4ec85451-801e-0041-1218-f86f9d000000;0;XXX.XXX.XXX.XXX:59234;2019-12-12;869;0;271;0;0;;;;;;"xAzure/1.0 AzureStorage/1.0 ObjectLifeCycleScanner/0.50";;"XXXXX_ms-tyo31prdstr02a_2025-07-18T18:34:57.4214940Z_2faabfc8-9051-4f24-ace5-1a95ceb43ee9_";;;;;;;;<p><br><img src="/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management/image-2bf8a9cb-0c9f-49ee-83c5-c4c36cb5cde1.png" alt="image-2bf8a9cb-0c9f-49ee-83c5-c4c36cb5cde1.png"></p><p><br>出力されるログの項目内訳につきましては、下記をご参照ください。<br><br><a href="https://learn.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-log-format">Storage Analytics ログ形式 (REST API) - Azure Storage | Microsoft Learn</a></p><p><br><br>    </p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ<br></h1><p>   ファイル ベースの方法で簡単に確認できるため、診断設定を利用しストレージ アカウントのログを出力するように設定した場合でも、そのログが多くなると確認しづらくなります。このようなジレンマを解決するため、ライフサイクル管理ポリシーを構成し一定期間が経過した後自動的にログが削除されるように設定することが出来ます。また、このポリシーの実行状況をメトリックや $logs コンテナーへ出力したログ などを利用し確認することが出来ます。<br></p><p><img src="/jpazpaas/2022/09/12/2022-09-09-Types-of-BLOB-for-Lifecycle-Management/image-61c17501-e9f6-4112-9367-42dea6dedaf3.png" alt="image-61c17501-e9f6-4112-9367-42dea6dedaf3.png"><br><br></p><h1 id="3行要約"><a href="#3行要約" class="headerlink" title="3行要約"></a>3行要約<br></h1><ol><li>診断設定でログの出力が出来る<br></li><li>ライフサイクル管理ポリシーで対象の Blob 種類を [追加 BLOB (Append blobs)] に設定することで、一定期間が経過した後ログを自動的に削除することが出来る<br></li><li>メトリックや $logs コンテナーなどでログの自動削除を確認することが出来る<br></li></ol><p><br><br><br><br>2025 年 8 月 4 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><h1 id="変更履歴"><a href="#変更履歴" class="headerlink" title="変更履歴"></a>変更履歴</h1><p>2022 年 9 月 9 日：公開<br><br>2025 年 8 月 4 日：「詳細に確認する場合」の確認方法を Log Analytics → [診断設定 (クラシック)] で出力したログ ($logs) から確認する方法に変更</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;#目次&lt;br&gt;&lt;br&gt;• はじめに&lt;br&gt;&lt;br&gt;• 自動でログを削除するライフサイクル管理ポリシーの作成方法&lt;br&gt;&lt;br&gt;• 作成したライフサイクル管理ポリシーの確認方法&lt;br&gt;&lt;br&gt;• まとめ&lt;br&gt;&lt;br&gt;• 3行要約&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    
    <category term="デプロイ履歴" scheme="https://komayama.github.io/jpazpaas/tags/%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E5%B1%A5%E6%AD%B4/"/>
    
  </entry>
  
  <entry>
    <title>Azure Functions の古いランタイム バージョンに対する潜在的な破壊的変更（2025年10月）</title>
    <link href="https://komayama.github.io/jpazpaas/2025/07/31/Potential-breaking-change-for-older-versions.html"/>
    <id>https://komayama.github.io/jpazpaas/2025/07/31/Potential-breaking-change-for-older-versions.html</id>
    <published>2025-07-30T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.142Z</updated>
    
    <content type="html"><![CDATA[<h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>お世話になっております。App Service サポート担当の仲野です。いつも Azure Functions（関数アプリ）をご利用いただき誠にありがとうございます。</p><p>本記事は <a href="https://github.com/Azure/app-service-announcements/issues/503">Potential breaking change for older versions (October 2025)</a> にてアナウンスされた内容の日本語抄訳です。最新情報につきましてはリンク先の Github の Issue をご確認ください。</p><p>2025 年 10 月に Azure Functions のプラットフォームのアップデートが予定されています。それに伴い、マイナー ランタイム バージョンに固定されている Azure Functions が正常に動作しなくなる潜在リスクがあります。</p><p>以下に当該アップデートにより潜在的なリスクが存在するバージョンと対策について解説します。<br/></p><h2 id="影響を受ける可能性のあるバージョン情報と対応内容"><a href="#影響を受ける可能性のあるバージョン情報と対応内容" class="headerlink" title="影響を受ける可能性のあるバージョン情報と対応内容"></a>影響を受ける可能性のあるバージョン情報と対応内容</h2><p>プラットフォームのアップデートに伴い、特定のセキュリティ機能がない古いランタイム バージョンで動作する Azure Functions に影響を及ぼす可能性があります。現時点ではプラットフォームの変更は、<strong>2025年10月28日</strong>に有効になる見込みです。そのため当該アップデート以前に Azure Functions のランタイムの更新をすることを推奨します。</p><p>下記の表に示すランタイム バージョンで動作している Azure Functions につきましては、直ちに対策をご検討ください。</p><table><thead><tr><th>ランタイム メジャー バージョン</th><th>ランタイム バージョン</th><th>対応内容</th></tr></thead><tbody><tr><td>v1.x</td><td>1.0.20776.0 未満</td><td>常に最新の 1.x バージョンを使うようにアプリを更新してください。1.x のサポートは 2026年9月14日に終了します。できるだけ早く<a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/migrate-version-1-version-4">4.x への移行</a>を行ってください。</td></tr><tr><td>v3.x</td><td>3.20.0.0 未満</td><td>直ちに<a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/migrate-version-3-version-4">4.x への移行</a>を行ってください。2.x および 3.x のサポートは 2022年12月13日に終了しています。暫定対処として最新の 3.x へ更新できますが、4.x への移行をご検討ください。</td></tr><tr><td>v4.x</td><td>4.24.0.0 未満</td><td>常に最新の 4.x バージョンを使うようにアプリを更新してください。</td></tr></tbody></table><p>影響を受ける可能性があるランタイム バージョンで動作する Azure Functions をご利用中の場合、メールによる通知がされ、App Service Advisor で新たな推奨事項が作成されます。Azure ポータルの「診断と問題の解決」ビューで推奨事項を確認できます。</p><h2 id="重要事項"><a href="#重要事項" class="headerlink" title="重要事項"></a>重要事項</h2><p>前述の表に記載したバージョン範囲は、今回の変更のためにフラグが立てられたものですが、記載されたランタイム バージョンを「最低限必要なバージョン」と解釈しないようご注意ください。他にもセキュリティ修正が後のバージョンに含まれています。古いバージョンに固定されている Azure Functions は必ず更新すべきであり、1.0.20776.0、3.20.0.0、4.24.0.0 に移行しても十分ではありません。これらの範囲は、影響を受ける可能性のある Azure Functions を特定するための目安となります。</p><p>ランタイム バージョンにつきましては、原則マイナー バージョンに固定せず、メジャー バージョンのみを指定し、最新バージョンへ移行するよう努めてください。</p><h2 id="対策方法"><a href="#対策方法" class="headerlink" title="対策方法"></a>対策方法</h2><h3 id="常に最新バージョンで動作させる方法"><a href="#常に最新バージョンで動作させる方法" class="headerlink" title="常に最新バージョンで動作させる方法"></a>常に最新バージョンで動作させる方法</h3><p>Azure Functions が古いバージョンで動作している主な理由は、カスタム コンテナー イメージの基本レイヤーが更新されていないことが多いです。</p><p>カスタム コンテナー イメージを最新の 4.x ランタイムで動作させるには、以下の表にある適切な <a href="https://mcr.microsoft.com/catalog?search=functions">基本イメージ タグ</a> をプルし、カスタム イメージを定期的にリビルドして、新しいバージョンを使用してください。</p><table><thead><tr><th>言語スタック</th><th>推奨される基本イメージ タグの例</th></tr></thead><tbody><tr><td>.NET（分離ワーカー モデル）</td><td><code>mcr.microsoft.com/azure-functions/dotnet-isolated:4-dotnet-isolated8.0</code><br/>または<br/><code>mcr.microsoft.com/azure-functions/dotnet-isolated:4-dotnet-isolated8.0-appservice</code><br/>(これらの例は .NET 8 を対象とします。必要な .NET バージョンに適したイメージを選択します)。</td></tr><tr><td>.NET（レガシ インプロセスモデル）</td><td><code>mcr.microsoft.com/azure-functions/dotnet:4-dotnet8.0</code><br/>または<br/><code>mcr.microsoft.com/azure-functions/dotnet:4-dotnet8.0-appservice</code><br/>(インプロセス モデルのサポートは 2026 年 11 月 10 日に終了します。できるだけ早く<a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/migrate-dotnet-to-isolated-model">分離ワーカー モデルへの移行</a>する必要があります)</td></tr><tr><td>Java</td><td><code>mcr.microsoft.com/azure-functions/java:4-java21</code><br/>または<br/><code>mcr.microsoft.com/azure-functions/java:4-java21-appservice</code><br/>(これらの例は Java 21 を対象とします。必要な Java バージョンに適したイメージを選択します)。</td></tr><tr><td>Node.js（JavaScript または TypeScript）</td><td><code>mcr.microsoft.com/azure-functions/node:4-node22</code><br/>または<br/><code>mcr.microsoft.com/azure-functions/node:4-node22-appservice</code><br/>(これらの例では、Node.js 22 を対象とします。必要な Node.js バージョンに適したイメージを選択します)。</td></tr><tr><td>PowerShell</td><td><code>mcr.microsoft.com/azure-functions/powershell:4-powershell7.4</code><br/>または<br/><code>mcr.microsoft.com/azure-functions/powershell:4-powershell7.4-appservice</code><br/>(これらの例は PowerShell 7.4 を対象とします。必要な PowerShell バージョンに適したイメージを選択します)。</td></tr><tr><td>Python</td><td><code>mcr.microsoft.com/azure-functions/python:4-python3.12</code><br/>または<br/><code>mcr.microsoft.com/azure-functions/python:4-python3.12-appservice</code><br/>(これらの例は Python 3.12 を対象とします。必要な Python バージョンに適したイメージを選択します)。)</td></tr><tr><td>カスタムハンドラー/その他</td><td><code>mcr.microsoft.com/azure-functions/base:4</code><br/>または<br/><code>mcr.microsoft.com/azure-functions/base:4-appservice</code></td></tr></tbody></table><p>詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/container-concepts#maintaining-custom-containers">カスタム コンテナーのメンテナンス</a> を参照してください。</p><p>また、Azure Functions の設定で古いバージョンに固定している場合もあります。<br>4.x ランタイムの最新バージョンを対象とするには、アプリ設定<code>FUNCTIONS_EXTENSION_VERSION</code> の値を <code>~4</code> と設定してください。</p><p>詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/set-runtime-version">Azure Functions ランタイム バージョンをターゲットにする方法</a> を参照してください。</p><hr><br><br><p>2025 年 07 月 31 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h2&gt;&lt;p&gt;お世話になっております。App Service サポート担当の仲野です。いつも Azure Functions（関数アプリ）</summary>
      
    
    
    
    
    <category term="Function App" scheme="https://komayama.github.io/jpazpaas/tags/Function-App/"/>
    
  </entry>
  
  <entry>
    <title>Azure AI Search から Azure OpenAI Service へ可能な限りセキュアに接続したい</title>
    <link href="https://komayama.github.io/jpazpaas/2024/01/25/search-private-access-to-openai.html"/>
    <id>https://komayama.github.io/jpazpaas/2024/01/25/search-private-access-to-openai.html</id>
    <published>2025-07-24T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.015Z</updated>
    
    <content type="html"><![CDATA[<p>Azure AI Search でベクトル検索を利用するために、インデクサー実行時に Azure OpenAI Embedding スキルでコンテンツをベクトル化したいです。<br/><br>しかし、Azure OpenAI Service のネットワーク設定でパブリックアクセスを無効とすると、Azure OpenAI Embedding スキルが失敗します。<br/><br>可能な限り Azure AI Search から Azure OpenAI Service への接続をセキュアにする方法はありますでしょうか。</p><p>インデクサーを実行すると以下のようなエラーが発生します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">メッセージ</span><br><span class="line">Could not execute skill because the Web Api request failed.</span><br><span class="line">詳細</span><br><span class="line">Web Api response status: &#x27;Forbidden&#x27;, Web Api response details: &#x27;&#123;&quot;error&quot;:&#123;&quot;code&quot;:&quot;403&quot;,&quot;message&quot;: &quot;Public access is disabled. Please configure private endpoint.&quot;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure><p><img src="/jpazpaas/2024/01/25/search-private-access-to-openai/image-afddb292-ce11-42dc-a5d6-c25aeb92e136.png" alt="image-afddb292-ce11-42dc-a5d6-c25aeb92e136.png"></p><p>また、Azure OpenAI Service のパブリックアクセスを無効化せず、「選択したネットワークとプライベート エンドポイント」からのアクセスに制限している場合は以下のエラーが発生します。 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">メッセージ</span><br><span class="line">Could not execute skill because the Web Api request failed.</span><br><span class="line">詳細</span><br><span class="line">Web Api response status: &#x27;Forbidden&#x27;, Web Api response details: &#x27;&#123;&quot;error&quot;:&#123;&quot;code&quot;:&quot;403&quot;,&quot;message&quot;: &quot;Access denied due to Virtual Network/Firewall rules.&quot;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure><h1 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答</h1><p>現在は以下の 2 点の選択肢がございます。<br/><br>それぞれ長所と短所を記載いたしましたので、ご検討いただけますと幸いです。<br/><br>恐れ入りますが、2 つ目のマネージド ID を利用する方法は、Azure OpenAI Service がパブリックアクセスを無効としているとご利用することがかないませんのでご注意ください。</p><ol><li><strong>Azure AI Search の Azure OpenAI Service への共有プライベートリンク経由でアクセスするように設定します。</strong><ul><li>長所<ul><li>Azure AI Search から Azure OpenAI Service へプライベート接続ができます。</li><li>手順として共有プライベートリンクの作成とインデクサーの設定を変更すればよく、管理が容易です。</li></ul></li><li>短所<ul><li>Azure AI Search サービスの作成日、リージョン、およびスキルの構成によっては、Standard 1 以上のプランが必要となり、ご利用料金が高くなる可能性があります。</li><li>プライベートエンドポイントを利用することによる料金が追加で請求されます。</li></ul></li></ul></li><li><strong>Azure AI Search から Azure OpenAI Service に対してマネージド ID 認証を利用して接続します。</strong>  <ul><li>長所<ul><li>マネージド ID は Azure AI Search の Basic プランから利用可能であるため、垂直統合以外のスキルを利用する場合、Basic プランを選択でき、料金が安くなります。<ul><li>垂直統合以外のスキルを利用する場合、さらに共有プライベートリンクを利用するには Standard 1 が必要です。</li></ul></li></ul></li><li>短所<ul><li>Azure AI Search から Azure OpenAI Service へのアクセスは Microsoft バックボーンネットワークを経由するため、パブリックインターネットを経由することはございませんが、プライベート接続とはなりません。</li></ul></li></ul></li></ol><p>以下に 2 つの選択肢の詳細を記載いたします。</p><h2 id="1-Azure-AI-Search-の-Azure-OpenAI-Service-への共有プライベートリンク経由でアクセスするように設定します。"><a href="#1-Azure-AI-Search-の-Azure-OpenAI-Service-への共有プライベートリンク経由でアクセスするように設定します。" class="headerlink" title="1. Azure AI Search の Azure OpenAI Service への共有プライベートリンク経由でアクセスするように設定します。"></a>1. Azure AI Search の Azure OpenAI Service への共有プライベートリンク経由でアクセスするように設定します。</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create">共有プライベートリンク</a> は、Azure AI Search から別の Azure サービスへのプライベート接続が必要な場合に利用します。<br/><br>共有プライベートリンクを作成し、インデクサーでプライベート接続を利用する設定を追加するだけでご利用可能になります。また、共有プライベートリンクによって作成されるプライベートエンドポイントリソースは Microsoft で管理されるため、お客様にてプライベートエンドポイントやプライベート DNS ゾーン等を管理する必要はございません。<br/></p><p>共有プライベートリンクの利用によって以下の構成となります。<br/><br><img src="/jpazpaas/2024/01/25/search-private-access-to-openai/search-private-access-9a3051ea-003c-4767-9d32-88cc714bb4ca.jpg" alt="search-private-access-9a3051ea-003c-4767-9d32-88cc714bb4ca.jpg"><br><br/><br><br/><br>ただし、共有プライベートリンクを利用する上で <a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create#prerequisites">前提条件</a> がありますため、予め前提条件を満たすかご確認ください。</p><p>あくまで参考情報となりますが、以前はスキルセットが必要な場合は Standard 2 以上のレベルの Azure AI Search サービスが必要でした。<br>2024 年 11 月以降、上記の前提条件を満たせば、Basic レベルでも Azure OpenAI の埋め込みスキルをプライベート環境で実行することが可能となりました。<br>さらに、2025 年 5 月以降、Standard 1 レベルでもカスタムスキルをプライベート環境で実行することが可能となりました。</p><h3 id="設定手順"><a href="#設定手順" class="headerlink" title="設定手順"></a>設定手順</h3><p>以下に設定手順について参考となるドキュメントと、手順実施の際の参考情報を記載いたします。</p><h4 id="1-共有プライベート-リンクを作成する-を参考に設定します。"><a href="#1-共有プライベート-リンクを作成する-を参考に設定します。" class="headerlink" title="1. 共有プライベート リンクを作成する を参考に設定します。"></a>1. <a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create#1---create-a-shared-private-link">共有プライベート リンクを作成する</a> を参考に設定します。</h4><p>Azure OpenAI Service へ接続するため、以下の画像のように「リソースの種類」 は <code>Microsoft.CognitiveServices/accounts</code>、「対象サブリソース」は <code>openai_account</code> とします。<br/><br><img src="/jpazpaas/2024/01/25/search-private-access-to-openai/image-98f65f48-6c67-4845-86d2-f8d48411b208.png" alt="image-98f65f48-6c67-4845-86d2-f8d48411b208.png"></p><h4 id="2-プライベート-エンドポイント接続を承認する-を参考に設定します。"><a href="#2-プライベート-エンドポイント接続を承認する-を参考に設定します。" class="headerlink" title="2. プライベート エンドポイント接続を承認する を参考に設定します。"></a>2. <a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create#1---create-a-shared-private-link">プライベート エンドポイント接続を承認する</a> を参考に設定します。</h4><h4 id="3-共有プライベート-リンクの状態を確認する-を参考に設定します。"><a href="#3-共有プライベート-リンクの状態を確認する-を参考に設定します。" class="headerlink" title="3. 共有プライベート リンクの状態を確認する を参考に設定します。"></a>3. <a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create#3---check-shared-private-link-status">共有プライベート リンクの状態を確認する</a> を参考に設定します。</h4><h4 id="4-プライベート環境で実行されるようにインデクサーを構成する-を参考に設定します。"><a href="#4-プライベート環境で実行されるようにインデクサーを構成する-を参考に設定します。" class="headerlink" title="4. プライベート環境で実行されるようにインデクサーを構成する を参考に設定します。"></a>4. <a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create#4---configure-the-indexer-to-run-in-the-private-environment">プライベート環境で実行されるようにインデクサーを構成する</a> を参考に設定します。</h4><p>既にインデクサーが存在する場合は、Azure Portal より以下のように <code>&quot;executionEnvironment&quot;: &quot;private&quot;</code> を追記して保存いただけますと幸いです。<br/><br><img src="/jpazpaas/2024/01/25/search-private-access-to-openai/image-582712e4-1123-4e50-89a3-999ae9bc1223.png" alt="image-582712e4-1123-4e50-89a3-999ae9bc1223.png"></p><h2 id="2-Azure-AI-Search-から-Azure-OpenAI-Service-に対してマネージドID認証を利用して接続します。"><a href="#2-Azure-AI-Search-から-Azure-OpenAI-Service-に対してマネージドID認証を利用して接続します。" class="headerlink" title="2. Azure AI Search から Azure OpenAI Service に対してマネージドID認証を利用して接続します。"></a>2. Azure AI Search から Azure OpenAI Service に対してマネージドID認証を利用して接続します。</h2><p>1 の共有プライベートリンクを利用する方法は、Azure AI Search サービスの作成日、リージョン、およびスキルの構成によっては、Standard 1 以上のプランが必要となり、ご利用料金が高くなる可能性があります。また、Standard 1 以上のプランでなくとも、共有プライベートリンクを利用する以上、プライベート エンドポイントの料金が追加で発生いたします。<br/></p><p>一方で、プライベート接続はできないものの、Azure OpenAI Service のアクセス制限を構成しつつ、Azure AI Search からアクセスする方法として、マネージド ID 認証を利用する方法がございます。プライベート エンドポイントの料金がないため、共有プライベートリンクを利用する場合と比較して安くなります。<br/><br>Azure OpenAI Service のドキュメントに以下の記載がございますので、参考になれば幸いです。</p><blockquote><p>他のアプリのネットワーク規則を維持しながら、信頼された Azure サービスのサブセットに Azure OpenAI へのアクセス権を付与することができます。 その後、これらの信頼されたこれらのサービスでは、マネージド ID を使用して、Azure OpenAI サービスの認証が行われます。<br/><br>次の表は、これらのサービスのマネージド ID に適切なロールが割り当てられている場合に Azure OpenAI にアクセスできるサービスを示しています。<br/><br>(中略)<br/><br>Azure AI Search<br/></p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/ai-services/cognitive-services-virtual-networks?tabs=portal#grant-access-to-trusted-azure-services-for-azure-openai">Azure OpenAI の信頼された Azure サービスへのアクセス権を付与する</a></p><p>以下のような構成になります。<br/><br><img src="/jpazpaas/2024/01/25/search-private-access-to-openai/search-private-access-Page-2-a143ba1e-96bc-474d-88eb-0e80128750eb.jpg" alt="search-private-access-Page-2-a143ba1e-96bc-474d-88eb-0e80128750eb.jpg"></p><p>もちろん、プライベート接続はできないものの、<a href="https://learn.microsoft.com/ja-jp/azure/networking/microsoft-global-network#get-the-premium-cloud-network">マイクロソフトのグローバル ネットワーク</a> のドキュメントに記載がある通り、Microsoft のサービス間の通信はパブリックインターネットを経由することはございませんので、その点はご安心ください。<br/></p><p>また、質問に記載の 2 番目のエラーメッセージ <code>Access denied due to Virtual Network/Firewall rules.</code> を解消する方法にもなっています。</p><h3 id="設定手順-1"><a href="#設定手順-1" class="headerlink" title="設定手順"></a>設定手順</h3><p>以下に設定手順を記載いたします。</p><h4 id="1-Azure-OpenAI-Service-側でネットワーク規則の例外を許可します。"><a href="#1-Azure-OpenAI-Service-側でネットワーク規則の例外を許可します。" class="headerlink" title="1. Azure OpenAI Service 側でネットワーク規則の例外を許可します。"></a>1. Azure OpenAI Service 側でネットワーク規則の例外を許可します。</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/ai-services/cognitive-services-virtual-networks?tabs=portal#using-the-azure-portal">Azure OpenAI の信頼された Azure サービスへのアクセス権を付与する - Azure Portal の使用</a> のドキュメントにしたがい、対象の Azure OpenAI Service に対してネットワーク規則の例外を作成します。<br/></p><p>具体的には、Azure OpenAI の「ネットワーク」ブレードから、「選択したネットワークとプライベートエンドポイント」を選択し、<br>「Allow Azure services on the trusted services list to access this cognitive services account.」をチェックします。<br/><br>以下のスクリーンショットが参考になれば幸いです。<br/><br><img src="/jpazpaas/2024/01/25/search-private-access-to-openai/image-207eddb1-ca9f-4ab0-bf38-69ff93f63c0b.png" alt="image-207eddb1-ca9f-4ab0-bf38-69ff93f63c0b.png"></p><p>また、<a href="https://learn.microsoft.com/ja-jp/azure/ai-services/cognitive-services-virtual-networks?tabs=portal#using-the-azure-cli">Azure CLI の使用</a> の「Azure portal から信頼できるサービスが有効になっているかどうかを確認する」の手順にしたがい、<code>bypass: AzureServices</code> となっており、ネットワーク規則の例外が設定されているか念のため確認しておきましょう。</p><ol><li>Azure OpenAI リソースの概要ページから <strong>[JSON ビュー]</strong> を使用します。<br/><br><img src="/jpazpaas/2024/01/25/search-private-access-to-openai/image-344d3179-b354-4978-8281-966606aaea45.png" alt="image-344d3179-b354-4978-8281-966606aaea45.png">    </li><li><strong>[API バージョン]</strong> で最新の API バージョンを選択します。<br/><br><img src="/jpazpaas/2024/01/25/search-private-access-to-openai/image-e3a414bd-d40d-48ea-bfd6-e21fb1b4140c.png" alt="image-e3a414bd-d40d-48ea-bfd6-e21fb1b4140c.png"></li></ol><h4 id="2-Azure-AI-Search-側で-システム-マネージド-ID-を作成する-を参考に、システム割り当てマネージドIDを有効化します。"><a href="#2-Azure-AI-Search-側で-システム-マネージド-ID-を作成する-を参考に、システム割り当てマネージドIDを有効化します。" class="headerlink" title="2. Azure AI Search 側で システム マネージド ID を作成する を参考に、システム割り当てマネージドIDを有効化します。"></a>2. Azure AI Search 側で <a href="https://learn.microsoft.com/ja-jp/azure/search/search-howto-managed-identities-data-sources?tabs=portal-sys,portal-user#create-a-system-managed-identity">システム マネージド ID を作成する</a> を参考に、システム割り当てマネージドIDを有効化します。</h4><h4 id="3-Azure-OpenAI-Service-リソースのスコープで、手順-2-で作成したシステム割り当てマネージド-ID-に対して「Cognitive-Services-OpenAI-ユーザー」ロールを割り当てます。ロールの割り当て-の手順をご確認ください。"><a href="#3-Azure-OpenAI-Service-リソースのスコープで、手順-2-で作成したシステム割り当てマネージド-ID-に対して「Cognitive-Services-OpenAI-ユーザー」ロールを割り当てます。ロールの割り当て-の手順をご確認ください。" class="headerlink" title="3. Azure OpenAI Service リソースのスコープで、手順 2 で作成したシステム割り当てマネージド ID に対して「Cognitive Services OpenAI ユーザー」ロールを割り当てます。ロールの割り当て の手順をご確認ください。"></a>3. Azure OpenAI Service リソースのスコープで、手順 2 で作成したシステム割り当てマネージド ID に対して「Cognitive Services OpenAI ユーザー」ロールを割り当てます。<a href="https://learn.microsoft.com/ja-jp/azure/search/search-howto-managed-identities-data-sources?tabs=portal-sys,portal-user#assign-a-role">ロールの割り当て</a> の手順をご確認ください。</h4><p>必要なロールについては以下のドキュメントに記載がございます。</p><blockquote><p>Azure OpenAI にテキストを送信するには、マネージド ID に Cognitive Services OpenAI ユーザー アクセス許可が必要です。<br/></p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/search/cognitive-search-skill-azure-openai-embedding#skill-parameters">Azure OpenAI Embedding スキル</a></p><h4 id="4-スキルセットで-apiKey-と-authIdentity-を-null-にします。もし既存の定義に記載がない場合はそのままで問題ございません。"><a href="#4-スキルセットで-apiKey-と-authIdentity-を-null-にします。もし既存の定義に記載がない場合はそのままで問題ございません。" class="headerlink" title="4. スキルセットで apiKey と authIdentity を null にします。もし既存の定義に記載がない場合はそのままで問題ございません。"></a>4. スキルセットで <code>apiKey</code> と <code>authIdentity</code> を <code>null</code> にします。もし既存の定義に記載がない場合はそのままで問題ございません。</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;@odata.type&quot;</span>: <span class="string">&quot;#Microsoft.Skills.Text.AzureOpenAIEmbeddingSkill&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;#1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">&quot;context&quot;</span>: <span class="string">&quot;/document/pages/*&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;resourceUri&quot;</span>: https:<span class="comment">//airesource.openai.azure.com,</span></span><br><span class="line">  <span class="string">&quot;apiKey&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">&quot;deploymentId&quot;</span>: <span class="string">&quot;****&quot;</span>,</span><br></pre></td></tr></table></figure><p>以下のドキュメントにマネージド ID を利用する方法について記載がございますので、参考になれば幸いです。</p><blockquote><p>Azure OpenAI に接続するために検索サービスによって使用されるユーザー マネージド ID。 システムまたはユーザーのマネージド ID を使用できます。 システム マネージド ID を使用するには、apiKey と authIdentity を空白のままにします。 システム マネージド ID が自動的に使用されます。 <br/></p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/search/cognitive-search-skill-azure-openai-embedding#skill-parameters">Azure OpenAI Embedding スキル</a></p><h4 id="5-インデックスの設定で-Azure-OpenAI-Service-への接続でマネージド-ID-を利用するようにします。"><a href="#5-インデックスの設定で-Azure-OpenAI-Service-への接続でマネージド-ID-を利用するようにします。" class="headerlink" title="5. インデックスの設定で Azure OpenAI Service への接続でマネージド ID を利用するようにします。"></a>5. インデックスの設定で Azure OpenAI Service への接続でマネージド ID を利用するようにします。</h4><p>ベクトル検索をする場合、検索文字列に対しても Azure OpenAI Service の API を利用してベクトル化する必要があります。<br>マネージド ID を利用する設定がインデックスにないと、検索時に以下のようなエラーが発生します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Could not complete vectorization action. Could not reach the vectorization endpoint.</span><br></pre></td></tr></table></figure><p><img src="/jpazpaas/2024/01/25/search-private-access-to-openai/image-631d1172-f493-4659-8ac5-82d475769dcc.png" alt="image-631d1172-f493-4659-8ac5-82d475769dcc.png"></p><p>インデクサーの設定と同様に、インデックス定義の以下の部分で <code>apiKey</code> と <code>authIdentity</code> を <code>null</code> にして保存します。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;vectorizers&quot;</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;vector-1706146801319-vectorizer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;azureOpenAI&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;azureOpenAIParameters&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;resourceUri&quot;</span>: <span class="string">&quot;https://********.openai.azure.com&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;deploymentId&quot;</span>: <span class="string">&quot;tsample&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;apiKey&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">&quot;authIdentity&quot;</span>: <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;customWebApiParameters&quot;</span>: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>Azure Portal では以下のように変更し、保存します。<br/><br><img src="/jpazpaas/2024/01/25/search-private-access-to-openai/image-997b6bee-19e4-4c0b-bbcf-67fd668f114f.png" alt="image-997b6bee-19e4-4c0b-bbcf-67fd668f114f.png"></p><h4 id="6-インデクサーを実行しエラーなく処理が完了することと、インデックスの検索でエラーが発生しないことを確認します。"><a href="#6-インデクサーを実行しエラーなく処理が完了することと、インデックスの検索でエラーが発生しないことを確認します。" class="headerlink" title="6. インデクサーを実行しエラーなく処理が完了することと、インデックスの検索でエラーが発生しないことを確認します。"></a>6. インデクサーを実行しエラーなく処理が完了することと、インデックスの検索でエラーが発生しないことを確認します。</h4><br><br><h1 id="変更履歴"><a href="#変更履歴" class="headerlink" title="変更履歴"></a>変更履歴</h1><p>2025 年 07 月 25 日：Standard1 でも共有プライベートリンクでカスタムスキルを利用できるようになったため、前提条件の記載を修正しました。</p><hr><br><br><p>2025 年 07 月 25 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Azure AI Search でベクトル検索を利用するために、インデクサー実行時に Azure OpenAI Embedding スキルでコンテンツをベクトル化したいです。&lt;br/&gt;&lt;br&gt;しかし、Azure OpenAI Service のネットワーク設定でパブリックア</summary>
      
    
    
    
    
    <category term="AI Search" scheme="https://komayama.github.io/jpazpaas/tags/AI-Search/"/>
    
  </entry>
  
  <entry>
    <title>AI Search で OCR 等の組み込みスキルを Azure AI Service でパブリックアクセスを無効化した状態で実行したい</title>
    <link href="https://komayama.github.io/jpazpaas/2024/08/16/search-ai-skills-on-private-environment.html"/>
    <id>https://komayama.github.io/jpazpaas/2024/08/16/search-ai-skills-on-private-environment.html</id>
    <published>2025-07-24T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.094Z</updated>
    
    <content type="html"><![CDATA[<p>AI Search のスキルセットで、AI マルチサービス リソースの OCR スキルを設定しています。<br>しかし、AI マルチサービス リソースのパブリックネットワークアクセスを無効にするとエラーが発生しました。回避する方法はありますか?</p><h1 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答</h1><p>まず、本ブログは <strong>Azure OpenAI の Embedding スキル以外</strong> の、「AI マルチサービス リソース」によって提供される組み込みスキル (OCR スキル等) をターゲットとしております。Azure OpenAI の Embedding スキルをご利用の場合は以下のブログに詳細がございますので、参考になれば幸いです。<br/><br><a href="https://azure.github.io/jpazpaas/2024/01/25/search-private-access-to-openai.html">Azure AI Search から Azure OpenAI Service へ可能な限りセキュアに接続したい</a></p><p>AI マルチサービス リソースのパブリックネットワークアクセスを無効にする場合、共有プライベートリンクを利用することで、AI マルチサービス リソースの OCR 等の組み込みスキルを実行することが可能です。<br><br>以下のドキュメントに記載があります。</p><blockquote><p>Azure AI マルチサービス アカウントへの接続のための共有プライベート リンクは (2024 年 11 月現在) サポートされるようになりました。 Azure AI 検索は、<a href="https://learn.microsoft.com/ja-jp/azure/search/cognitive-search-attach-cognitive-services">課金のため</a>に Azure AI マルチサービスに接続します。 これらの接続は、共有プライベート リンクを介してプライベートにできるようになりました。 共有プライベート リンクは、スキルセット定義で、<a href="https://learn.microsoft.com/ja-jp/azure/search/cognitive-search-attach-cognitive-services#bill-through-a-keyless-connection">マネージド ID (キーレス構成)</a> を構成している場合にのみサポートされます。<br></p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create#supported-resource-types">共有プライベート リンク経由で接続する</a></p><p>おおまかに 2 つの作業が必要となります。<br/></p><ol><li><strong>AI Search のマネージド ID を設定し、AI マルチサービス リソースへの操作に必要なロールを割り当て、設定したマネージド ID をスキル実行時に使用するようにスキルセットを構成します。</strong></li><li><strong>AI Search から AI マルチサービス リソースへの共有プライベートリンクを経由して接続するように設定します。</strong></li></ol><h2 id="1-AI-マルチサービス-リソースへのアクセスでマネージド-ID-を利用する。"><a href="#1-AI-マルチサービス-リソースへのアクセスでマネージド-ID-を利用する。" class="headerlink" title="1. AI マルチサービス リソースへのアクセスでマネージド ID を利用する。"></a>1. AI マルチサービス リソースへのアクセスでマネージド ID を利用する。</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/search/cognitive-search-attach-cognitive-services?tabs=portal,portal-remove#bill-through-a-keyless-connection">キーレス接続での課金</a> の手順にしたがいます。</p><h2 id="2-AI-Search-から-AI-マルチサービス-リソースへの共有プライベートリンクを利用する設定"><a href="#2-AI-Search-から-AI-マルチサービス-リソースへの共有プライベートリンクを利用する設定" class="headerlink" title="2.  AI Search から AI マルチサービス リソースへの共有プライベートリンクを利用する設定"></a>2.  AI Search から AI マルチサービス リソースへの共有プライベートリンクを利用する設定</h2><p>共有プライベートリンクの利用には <a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create#prerequisites">前提条件</a> があります。<br>前提条件を満たしていれば、<br><a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create#1---create-a-shared-private-link">1 - 共有プライベート リンクを作成する</a> の手順にて、リソースの種類を <code>Microsoft.CognitiveServices/accounts</code>、サブリソースを <code>cognitiveservices_account</code> とします。</p><table><thead><tr><th>リソースの種類</th><th>サブリソース (またはグループ ID)</th></tr></thead><tbody><tr><td>Microsoft.CognitiveServices/accounts</td><td><code>cognitiveservices_account</code></td></tr></tbody></table><p><a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create#supported-resource-types">サポートされているリソースの種類</a></p><p>あとは <a href="https://learn.microsoft.com/ja-jp/azure/search/search-indexer-howto-access-private?tabs=portal-create">共有プライベート リンク経由で接続する</a> のドキュメントに記載の内容にしたがってください。<br><br><br><br></p><h1 id="変更履歴"><a href="#変更履歴" class="headerlink" title="変更履歴"></a>変更履歴</h1><p>2025 年 07 月 25 日：Standard1 でも共有プライベートリンクでカスタムスキルを利用できるようになったため、前提条件の記載を修正しました。</p><hr><br><br><p>2025 年 07 月 25 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;AI Search のスキルセットで、AI マルチサービス リソースの OCR スキルを設定しています。&lt;br&gt;しかし、AI マルチサービス リソースのパブリックネットワークアクセスを無効にするとエラーが発生しました。回避する方法はありますか?&lt;/p&gt;
&lt;h1 id=&quot;回答</summary>
      
    
    
    
    
    <category term="AI Search" scheme="https://komayama.github.io/jpazpaas/tags/AI-Search/"/>
    
  </entry>
  
  <entry>
    <title>Azure Functions .NET Isolated（分離ワーカー）モデルで Dependency の一部のログをフィルタリングして Application Insights に送信する方法</title>
    <link href="https://komayama.github.io/jpazpaas/2025/07/16/Azure-functions-dotnet-isolated-application-insights-filtering-dependency-log.html"/>
    <id>https://komayama.github.io/jpazpaas/2025/07/16/Azure-functions-dotnet-isolated-application-insights-filtering-dependency-log.html</id>
    <published>2025-07-15T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.138Z</updated>
    
    <content type="html"><![CDATA[<hr><p>お世話になっております。App Service サポート担当の山村です。いつも Azure Functions（関数アプリ）をご利用いただき誠にありがとうございます。</p><p>Azure Functions を使用してサーバーレスアプリケーションを開発・運用する際、アプリケーションや実行状況のログ監視は非常に重要です。<br>Azure Functions では Application Insights と統合することでこれらの監視が可能です。</p><p>本ブログでは、Azure Functions の .NET Isolated (分離ワーカー) モデルにおいて <code>Language Worker → Application Insights</code> のログ送信パイプラインをご利用いただいている場合に、Application Insights への 依存関係（Dependency）ログの送信について、特定の <code>type (HTTP etc)</code> や <code>target (www.microsoft.com etc)</code> 毎に制御する方法を解説します。</p><p>本ブログに記載の内容は、Dependency に関するログ保存のコストを抑えたいというユースケースでご利用いただけます。<br>Dependency ログの <code>type (HTTP etc)</code> や <code>target (www.microsoft.com etc)</code> 属性の値をもとに Dependency ログの保存有無を制御したい場合に、本内容が有効となります。</p><h1 id="Azure-Functions-のアーキテクチャ概略"><a href="#Azure-Functions-のアーキテクチャ概略" class="headerlink" title="Azure Functions のアーキテクチャ概略"></a>Azure Functions のアーキテクチャ概略</h1><p>Azure Functions では、Functions Host と呼ばれるプロセスと、Language Worker と呼ばれるプロセスが動作しています。</p><p>Functions Host は、HTTP トリガーや Blob トリガーなどのイベント検知や各種ログの記録といった共通処理を担い、Azure Functions のランタイムとして動作する Language Worker へ処理を要求します。 <br>Language Worker は各言語に応じた関数コードを実行するプロセスであり、お客様のアプリケーションコードが実行されます。<br>Azure Functions のアーキテクチャの詳細は、<a href="https://azure.github.io/jpazpaas/2023/08/24/azure-functions-words-relative-management.html">こちらのブログ</a>をご参照ください。</p><p><img src="/jpazpaas/2025/07/16/Azure-functions-dotnet-isolated-application-insights-filtering-dependency-log/image-47a83b48-dab2-4d99-aaa6-82f19e20635a.png" alt="image-47a83b48-dab2-4d99-aaa6-82f19e20635a.png"></p><h1 id="Application-Insights-へのログ送信フロー"><a href="#Application-Insights-へのログ送信フロー" class="headerlink" title="Application Insights へのログ送信フロー"></a>Application Insights へのログ送信フロー</h1><p>Azure Functions .NET Isolated を Application Insights と統合している場合には、Language Worker が Application Insights へログを送信するパイプラインは以下の二通りがあります。</p><ol><li><code>Language Worker → Functions Host → Application Insights</code><br></li><li><code>Language Worker → Application Insights</code></li></ol><p>詳細については、<a href="https://azure.github.io/jpazpaas/2025/05/07/Azure-functions-dotnet-isolated-application-insights-key-considerations.html">こちらのブログ</a>をご参照ください。</p><p>なお、2) の場合は、Language Worker が出力するログについては、Functions Host を経由しないため host.json の Application Insights の設定は効果がありません。<br>Language Worker が出力するログに関する Application Insights の設定は、スタートアップ構成の <code>Program.cs</code> 内で実装する必要があります。</p><h1 id="本題-Language-Worker-→-Application-Insights-ログ送信パイプラインの場合の-Dependency-ログの送信について、特定の-type-や-target-毎に制御する方法"><a href="#本題-Language-Worker-→-Application-Insights-ログ送信パイプラインの場合の-Dependency-ログの送信について、特定の-type-や-target-毎に制御する方法" class="headerlink" title="本題: Language Worker → Application Insights ログ送信パイプラインの場合の Dependency ログの送信について、特定の type や target 毎に制御する方法"></a>本題: Language Worker → Application Insights ログ送信パイプラインの場合の Dependency ログの送信について、特定の type や target 毎に制御する方法</h1><h2 id="実装例"><a href="#実装例" class="headerlink" title="実装例"></a>実装例</h2><p>スタートアップ構成の <code>Program.cs</code> 側で ITelemetryProcessor を用いて制御します。</p><p>まずは、外部エンドポイントに HTTP リクエストを実施するアプリケーションコード例を示します。</p><p><strong>HTTP トリガー関数の実装例</strong> <br></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;  </span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;  </span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.Functions.Worker;  </span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.Functions.Worker.Http; <span class="comment">//追加</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Company.Function</span>;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HttpTrigger1</span>  </span><br><span class="line">&#123;  </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;HttpTrigger1&gt; _logger;  </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> HttpClient httpClient = <span class="keyword">new</span> HttpClient();</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">HttpTrigger1</span>(<span class="params">ILogger&lt;HttpTrigger1&gt; logger</span>)</span>  </span><br><span class="line">   &#123;  </span><br><span class="line">       _logger = logger;  </span><br><span class="line">   &#125;</span><br><span class="line">   [<span class="meta">Function(<span class="meta-string">&quot;HttpTrigger1&quot;</span>)</span>]  </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;HttpResponseData&gt; <span class="title">Run</span>(<span class="params">[HttpTrigger(AuthorizationLevel.Anonymous, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;post&quot;</span></span>)] HttpRequestData req)</span>  </span><br><span class="line">   &#123;  </span><br><span class="line">       _logger.LogInformation(<span class="string">&quot;C# HTTP trigger function processed a request starting...&quot;</span>);  </span><br><span class="line">       <span class="keyword">var</span> response = <span class="keyword">await</span> httpClient.GetAsync(<span class="string">&quot;https://www.microsoft.com&quot;</span>);  </span><br><span class="line">       _logger.LogInformation(response.StatusCode.ToString());</span><br><span class="line">       <span class="keyword">var</span> res = req.CreateResponse(response.IsSuccessStatusCode  </span><br><span class="line">           ? System.Net.HttpStatusCode.OK  </span><br><span class="line">           : System.Net.HttpStatusCode.BadGateway);</span><br><span class="line">       <span class="keyword">await</span> res.WriteStringAsync(<span class="string">$&quot;Status: <span class="subst">&#123;response.StatusCode&#125;</span>&quot;</span>);  </span><br><span class="line">       <span class="keyword">return</span> res;  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>次に、ビルダー構成時に <code>AddApplicationInsightsTelemetryProcessor</code> を用いて、Telemetry データのフィルタリングと加工処理を適用します。</p><p><strong>Program.cs</strong> <br></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Azure.Functions.Worker;  </span><br><span class="line"><span class="keyword">using</span> Microsoft.Azure.Functions.Worker.Builder;  </span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;  </span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Hosting;  </span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> IsolatedApplicationInsightsCustomTelemetryProcessor;</span><br><span class="line"><span class="keyword">var</span> builder = FunctionsApplication.CreateBuilder(args);</span><br><span class="line"></span><br><span class="line">builder.Services  </span><br><span class="line">   .AddApplicationInsightsTelemetryWorkerService()  </span><br><span class="line">   .ConfigureFunctionsApplicationInsights()  </span><br><span class="line">   .AddApplicationInsightsTelemetryProcessor&lt;CustomTelemetryProcessor&gt;();</span><br><span class="line">  </span><br><span class="line">builder.Logging.Services.Configure&lt;LoggerFilterOptions&gt;(options =&gt;  </span><br><span class="line">&#123;  </span><br><span class="line">   LoggerFilterRule toRemove = options.Rules.FirstOrDefault(rule =&gt;  </span><br><span class="line">       rule.ProviderName == <span class="string">&quot;Microsoft.Extensions.Logging.ApplicationInsights.ApplicationInsightsLoggerProvider&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (toRemove <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)  </span><br><span class="line">   &#123;  </span><br><span class="line">       options.Rules.Remove(toRemove);  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;);  </span><br><span class="line">  </span><br><span class="line">builder.Build().Run();  </span><br></pre></td></tr></table></figure><p>ITelemetryProcessor で具体的なフィルタリング処理を追加します。<br><br>※ CustomTelemetryProcessor.cs を新しいファイルとして作成し、Program.cs にインポートするような実装としています。</p><p><strong>CustomTelemetryProcessor.cs</strong> <br></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">IsolatedApplicationInsightsCustomTelemetryProcessor</span>  </span><br><span class="line">&#123;  </span><br><span class="line">   <span class="keyword">using</span> Microsoft.ApplicationInsights.Channel;  </span><br><span class="line">   <span class="keyword">using</span> Microsoft.ApplicationInsights.DataContracts;  </span><br><span class="line">   <span class="keyword">using</span> Microsoft.ApplicationInsights.Extensibility;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomTelemetryProcessor</span> : <span class="title">ITelemetryProcessor</span>  </span><br><span class="line">   &#123;  </span><br><span class="line">       <span class="keyword">private</span> ITelemetryProcessor Next &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">CustomTelemetryProcessor</span>(<span class="params">ITelemetryProcessor next</span>)</span>  </span><br><span class="line">       &#123;  </span><br><span class="line">           <span class="keyword">this</span>.Next = next;  </span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">ITelemetry telemetry</span>)</span>  </span><br><span class="line">       &#123;  </span><br><span class="line">           <span class="comment">// if (telemetry is DependencyTelemetry dependency &amp;&amp; dependency.Target == &quot;www.microsoft.com&quot;) // target URL or service name etc.  </span></span><br><span class="line">           <span class="comment">// if (telemetry is DependencyTelemetry dependency &amp;&amp; dependency.Type == &quot;Http&quot;) // &quot;Http&quot;, &quot;InProc&quot; etc.  </span></span><br><span class="line">           <span class="keyword">if</span> (telemetry <span class="keyword">is</span> DependencyTelemetry dependency) <span class="comment">// Don&#x27;t send all dependencies telemetry  </span></span><br><span class="line">           &#123;  </span><br><span class="line">               Console.WriteLine(<span class="string">$&quot;target: <span class="subst">&#123;dependency.Target&#125;</span>&quot;</span>);  </span><br><span class="line">               Console.WriteLine(<span class="string">$&quot;type: <span class="subst">&#123;dependency.Type&#125;</span>&quot;</span>);  </span><br><span class="line">               <span class="keyword">return</span>;  </span><br><span class="line">           &#125;  </span><br><span class="line">           <span class="keyword">this</span>.Next.Process(telemetry);  </span><br><span class="line">       &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="具体的なフィルタリング例"><a href="#具体的なフィルタリング例" class="headerlink" title="具体的なフィルタリング例"></a>具体的なフィルタリング例</h2><p>上記までのアプリケーションコードを Azure Functions にデプロイします。<br><br>また、実行した際の Application Insights のログに対して、下記 KQL クエリで Dependency のログが記録されているかを確認します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">union requests, traces, dependencies, exceptions</span><br><span class="line">| where timestamp &gt; ago(30d)</span><br><span class="line">| where operation_Id == &#x27;&lt;対象の実行の operation id を入力&gt;&#x27; or customDimensions[&#x27;InvocationId&#x27;] == &#x27;&lt;対象の実行の invocation id を入力&gt;&#x27;</span><br><span class="line">| order by timestamp asc</span><br><span class="line">| project-reorder timestamp, itemType, target, type, sdkVersion, message</span><br></pre></td></tr></table></figure><h3 id="1-すべての-Dependency-ログを送信する場合"><a href="#1-すべての-Dependency-ログを送信する場合" class="headerlink" title="1. すべての Dependency ログを送信する場合"></a>1. すべての Dependency ログを送信する場合</h3><p>Program.cs で <code>AddApplicationInsightsTelemetryProcessor</code> を利用しなければ、すべての Dependency のログが送信されます。</p><p><img src="/jpazpaas/2025/07/16/Azure-functions-dotnet-isolated-application-insights-filtering-dependency-log/image-29f168f8-d4b6-44f8-8c44-e4b5994afac5.png" alt="image-29f168f8-d4b6-44f8-8c44-e4b5994afac5.png"></p><h3 id="2-すべての-Dependency-ログを送信しない場合"><a href="#2-すべての-Dependency-ログを送信しない場合" class="headerlink" title="2. すべての Dependency ログを送信しない場合"></a>2. すべての Dependency ログを送信しない場合</h3><p>ITelemetryProcessor で <code>if (telemetry is DependencyTelemetry dependency)</code> とします。<br><br>下記のように Dependency のログは記録されません。</p><p><img src="/jpazpaas/2025/07/16/Azure-functions-dotnet-isolated-application-insights-filtering-dependency-log/image-36d61019-319b-405b-9e48-8da291d6a5a9.png" alt="image-36d61019-319b-405b-9e48-8da291d6a5a9.png"></p><h3 id="3-特定の-target-のみを送信しない場合"><a href="#3-特定の-target-のみを送信しない場合" class="headerlink" title="3. 特定の target のみを送信しない場合"></a>3. 特定の target のみを送信しない場合</h3><p>ITelemetryProcessor で <code>if (telemetry is DependencyTelemetry dependency &amp;&amp; dependency.Target == &quot;www.microsoft.com&quot;)</code> とします。<br><br>下記のように Dependency のログのうち “<a href="http://www.microsoft.com&quot;/">www.microsoft.com&quot;</a> を target とするログは記録されません。</p><p><img src="/jpazpaas/2025/07/16/Azure-functions-dotnet-isolated-application-insights-filtering-dependency-log/image-de3c40b8-6688-4733-a720-a0bfd07ed1a6.png" alt="image-de3c40b8-6688-4733-a720-a0bfd07ed1a6.png"></p><p>ITelemetryProcessor で <code>if (telemetry is DependencyTelemetry dependency &amp;&amp; dependency.Target == &quot;&quot;)</code> とします。<br><br>※ Application Insights 側に送信されると target が Invoke となっているように見えますが、ローカルでは null なので null でフィルタリングします。<br><br>下記のように Dependency ログのうち “Invoke” を target とするログは記録されません。</p><p><img src="/jpazpaas/2025/07/16/Azure-functions-dotnet-isolated-application-insights-filtering-dependency-log/image-4fa9d2fc-ebd6-485a-a5a7-695e1206dfa0.png" alt="image-4fa9d2fc-ebd6-485a-a5a7-695e1206dfa0.png"></p><h3 id="4-特定の-type-のみを送信しない場合"><a href="#4-特定の-type-のみを送信しない場合" class="headerlink" title="4. 特定の type のみを送信しない場合"></a>4. 特定の type のみを送信しない場合</h3><p>ITelemetryProcessor で <code>if (telemetry is DependencyTelemetry dependency &amp;&amp; dependency.Type == &quot;Http&quot;)</code> とします。<br><br>下記のように Dependency ログのうち “Http” を type とするログは記録されません。</p><p><img src="/jpazpaas/2025/07/16/Azure-functions-dotnet-isolated-application-insights-filtering-dependency-log/image-cf83a03d-2f19-4554-8a16-07b46ea00205.png" alt="image-cf83a03d-2f19-4554-8a16-07b46ea00205.png"></p><p>ITelemetryProcessor で <code>if (telemetry is DependencyTelemetry dependency &amp;&amp; dependency.Type == &quot;InProc&quot;)</code> とします。<br><br>下記のように Dependency ログのうち “InProc” を type とするログは記録されません。</p><p><img src="/jpazpaas/2025/07/16/Azure-functions-dotnet-isolated-application-insights-filtering-dependency-log/image-97cd9549-160a-4740-88ce-94550c3a9c8e.png" alt="image-97cd9549-160a-4740-88ce-94550c3a9c8e.png"></p><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>上記の通り、ITelemetryProcessor を用いてフィルタリングを追加することで、特定の target や type のみを Application Insights に送信しないことを実現可能ですが、本番や運用環境でお試しいただく前に、検証環境でお客様想定通りとなるかを確認してご利用いただくようにお願いいたします。<br>また、Application Insights にログを送信しないと、問題発生時のトラブルシューティングが難しくなる場合もございますので、どのログをフィルタリングするかは要検討いただく必要がございます。</p><h2 id="参考リンク"><a href="#参考リンク" class="headerlink" title="参考リンク"></a>参考リンク</h2><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/api-filtering-sampling?tabs=dotnetcore,javascriptwebsdkloaderscript">Application Insights SDK におけるフィルター処理および前処理</a></li></ul><br><br><p>2025 年 07 月 16 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;hr&gt;
&lt;p&gt;お世話になっております。App Service サポート担当の山村です。いつも Azure Functions（関数アプリ）をご利用いただき誠にありがとうございます。&lt;/p&gt;
&lt;p&gt;Azure Functions を使用してサーバーレスアプリケーションを開発・運用</summary>
      
    
    
    
    
    <category term="Function App" scheme="https://komayama.github.io/jpazpaas/tags/Function-App/"/>
    
  </entry>
  
  <entry>
    <title>Blob Storageにおいて操作ログからユーザーを特定したい</title>
    <link href="https://komayama.github.io/jpazpaas/2023/02/16/How-to-identify-the-user-performed-BLOB-operations-in-Azure-Portal.html"/>
    <id>https://komayama.github.io/jpazpaas/2023/02/16/How-to-identify-the-user-performed-BLOB-operations-in-Azure-Portal.html</id>
    <published>2025-05-11T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:02.870Z</updated>
    
    <content type="html"><![CDATA[<p>Azure Portal での Blob Storage のデータ操作について、誰がどのような操作を行ったかを診断設定ログから特定したいです。可能でしょうか。</p><h1 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答</h1><p>はい。診断設定ログに含まれる RequesterObjectId 又は RequesterUpn などから、<br>どの Microsoft Entra ユーザーなのかを特定することが可能でございます。</p><p>診断設定ログでの確認例  </p><p><img src="/jpazpaas/2023/02/16/How-to-identify-the-user-performed-BLOB-operations-in-Azure-Portal/image-4cd6a29c-d7a0-4703-8b8c-5538ac57c2fc.png" alt="image-4cd6a29c-d7a0-4703-8b8c-5538ac57c2fc.png"></p><p>Azure Portal ではアクセス認証の方式は、以下の 2 種類がございます。</p><ul><li>アクセス キー</li><li>Microsoft Entra ユーザー認証</li></ul><p><img src="/jpazpaas/2023/02/16/How-to-identify-the-user-performed-BLOB-operations-in-Azure-Portal/image-54451daf-addb-4df9-b5ae-74bd5bea9762.png" alt="image-54451daf-addb-4df9-b5ae-74bd5bea9762.png"></p><p>アクセスキーでの認証の場合は Microsoft Entra ユーザーを特定可能な情報を残すことが出来ませんので、監視対象のユーザーには、必ず Microsoft Entra ユーザー認証をさせる必要がございます。</p><p>Azure Portal のストレージ アカウントの [ ブレードメニュー ] -&gt; [ 構成 ] から<br>Azure portal で Microsoft Entra 認可を既定にするを [ 有効 ] にすることで、既定の認証方法設定可能でございます。</p><p><img src="/jpazpaas/2023/02/16/How-to-identify-the-user-performed-BLOB-operations-in-Azure-Portal/image-61525868-6e4f-4777-9332-ea363db40823.png" alt="image-61525868-6e4f-4777-9332-ea363db40823.png"></p><p>Microsoft Entra 認証でストレージ アカウントを利用する Microsoft Entra ユーザーには、別途 BLOB データを操作するための権限が必要となります。</p><ul><li>ストレージ BLOB データ共同作成者など、何らかのデータ アクセス ロール</li><li>少なくとも Azure Resource Manager 閲覧者ロール</li></ul><p>が必要となります。詳細につきましては<br><a href="https://azure.github.io/jpazpaas/2021/01/29/storage-permission-mismatch.html">こちら</a>をご参照ください。</p><p>これらの設定に加え、アクセスキーの使用についての制限を加える必要がございます。</p><h1 id="アクセス-キー利用の制限"><a href="#アクセス-キー利用の制限" class="headerlink" title="アクセス キー利用の制限"></a>アクセス キー利用の制限</h1><p>アクセス キーの利用について制限を設けるには以下 2 パターンの設定方法がございます。</p><h3 id="A-ストレージ-アカウント全体でアクセス-キーによる認証を完全に無効化し、監視対象ユーザーに-BLOB-データを操作する権限を-RBAC-で制御"><a href="#A-ストレージ-アカウント全体でアクセス-キーによる認証を完全に無効化し、監視対象ユーザーに-BLOB-データを操作する権限を-RBAC-で制御" class="headerlink" title="(A). ストレージ アカウント全体でアクセス キーによる認証を完全に無効化し、監視対象ユーザーに BLOB データを操作する権限を RBAC で制御"></a>(A). ストレージ アカウント全体でアクセス キーによる認証を完全に無効化し、監視対象ユーザーに BLOB データを操作する権限を RBAC で制御</h3><h3 id="B-アクセス-キーは有効化し、一部のユーザ以外はアクセス-キーの表示を禁止するように権限を-RBAC-で制御"><a href="#B-アクセス-キーは有効化し、一部のユーザ以外はアクセス-キーの表示を禁止するように権限を-RBAC-で制御" class="headerlink" title="(B). アクセス キーは有効化し、一部のユーザ以外はアクセス キーの表示を禁止するように権限を RBAC で制御"></a>(B). アクセス キーは有効化し、一部のユーザ以外はアクセス キーの表示を禁止するように権限を RBAC で制御</h3><p>それぞれについて記載いたします。</p><h2 id="A-アクセス-キーによる認証を完全に無効化する方法"><a href="#A-アクセス-キーによる認証を完全に無効化する方法" class="headerlink" title="(A). アクセス キーによる認証を完全に無効化する方法"></a>(A). アクセス キーによる認証を完全に無効化する方法</h2><p>アクセス キーによる認証を完全に無効化する方法につきましては、<br>設定変更に関わる権限なども含め、<a href="https://learn.microsoft.com/ja-jp/azure/storage/common/shared-key-authorization-prevent">こちら</a>に記載がございますので、ご参照ください。</p><p>記事内でも解説されておりますが、<br>Microsoft.Storage/storageAccounts/write などのリソース変更権限を監視対象となるユーザーに与えないようにご注意ください。</p><h2 id="B-アクセス-キーは有効化するものの、特権をもつユーザ以外はアクセス-キーを用いたデータ表示を禁止する方法"><a href="#B-アクセス-キーは有効化するものの、特権をもつユーザ以外はアクセス-キーを用いたデータ表示を禁止する方法" class="headerlink" title="(B). アクセス キーは有効化するものの、特権をもつユーザ以外はアクセス キーを用いたデータ表示を禁止する方法"></a>(B). アクセス キーは有効化するものの、特権をもつユーザ以外はアクセス キーを用いたデータ表示を禁止する方法</h2><p>対象となる Microsoft Entra ユーザーに “Microsoft.Storage/storageAccounts/listKeys/action” 権限を付与しなければ、<br>アクセスキーを使用してのデータアクセスはできません。</p><p>“Microsoft.Storage/storageAccounts/listKeys/action” がないロールでもポータルで見かけ上、アクセスキーに切り替えるボタンは押せますが、実際にはアクセスキーを使用する権限がないのでデータ表示まではできません。  </p><p><img src="/jpazpaas/2023/02/16/How-to-identify-the-user-performed-BLOB-operations-in-Azure-Portal/image-553240a7-5c93-46e0-9b65-29b00d33d215.png" alt="image-553240a7-5c93-46e0-9b65-29b00d33d215.png"></p><p>必要なロールとして上述した</p><ul><li>ストレージ BLOB データ閲覧者、ストレージ BLOB データ共同作成者など、何らかのデータ アクセス ロール</li><li>少なくとも Azure Resource Manager 閲覧者ロール</li></ul><p>のロールのみであれば、listKeys / action はできません</p><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>Azure Portal では Microsoft Entra ユーザー認証をさせることで、監視対象ユーザーがどのような操作をしたのか、診断設定ログから判断することが可能です。その際、監視対象ユーザーがアクセスキーを利用できないように設定することも必要となります。</p><p>また、Azure Portalでのデータ操作とはスコープが異なりますが、監視対象のユーザーに、<a href="https://learn.microsoft.com/ja-jp/rest/api/storageservices/get-user-delegation-key">ユーザー委任キー</a>の発行権限がある場合、ユーザー委任キーで署名して発行できる<a href="https://learn.microsoft.com/ja-jp/rest/api/storageservices/create-user-delegation-sas">ユーザー委任SAS</a>を用いて、ユーザー委任キーの発行者以外であってもデータアクセスに利用することができてしまいます。</p><p><img src="/jpazpaas/2023/02/16/How-to-identify-the-user-performed-BLOB-operations-in-Azure-Portal/image-6168ab72-99fe-4853-bfa0-5200bbf88f91.png" alt="image-6168ab72-99fe-4853-bfa0-5200bbf88f91.png"></p><p>Azure Portal外においても厳密な統制を行う場合は、ユーザー委任キー発行に必要な権限Storage/storageAccounts/blobServices/generateUserDelegationKeyを当該ユーザーに与えないようにすることを推奨いたします。</p><h1 id="変更履歴"><a href="#変更履歴" class="headerlink" title="変更履歴"></a>変更履歴</h1><p>2025年5月12日 追記： AzureAD の表示名称が Microsoft Entra に変更されたことに伴い、表示名称および設定画像を修正しました。</p><br><br><hr><br><br><p>2025 年 05 月 12 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Azure Portal での Blob Storage のデータ操作について、誰がどのような操作を行ったかを診断設定ログから特定したいです。可能でしょうか。&lt;/p&gt;
&lt;h1 id=&quot;回答&quot;&gt;&lt;a href=&quot;#回答&quot; class=&quot;headerlink&quot; title=&quot;回</summary>
      
    
    
    
    
    <category term="Storage" scheme="https://komayama.github.io/jpazpaas/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>AI Search の設定やインデックスデータをバックアップしたい</title>
    <link href="https://komayama.github.io/jpazpaas/2024/01/25/backup-search-service.html"/>
    <id>https://komayama.github.io/jpazpaas/2024/01/25/backup-search-service.html</id>
    <published>2025-05-11T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.015Z</updated>
    
    <content type="html"><![CDATA[<p>AI Search では作成後にレベルの変更 (Basic から Standard 等) が一般利用可能な機能ではできない認識です。<br>レベルの変更等に柔軟に対応できるようにするため、AI Search の設定やインデックスデータをバックアップ/リストアする方法はありますでしょうか。<br><br/><br><br/><br>※ 2025 年 4 月時点では、価格レベルを　Basic と Standard 間で下位レベルから上位レベルに切り替えることが、プレビューではございますが可能となっております。</p><blockquote><p>2025-02-01-preview では、Basic レベルと Standard レベル (S1、S2、S3) の間の変更がサポートされます。 現時点では、Basic から S1 に移行するなど、下位レベルから上位レベルにのみ切り替えることができます。 </p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/search/search-capacity-planning#change-your-pricing-tier">価格レベルを変更する</a></p><h1 id="回答"><a href="#回答" class="headerlink" title="回答"></a>回答</h1><p>AI Search の設定とインデックスデータそれぞれのバックアップ/リストア方法をご案内いたします。</p><h2 id="AI-Search-の設定のバックアップ-リストア方法"><a href="#AI-Search-の設定のバックアップ-リストア方法" class="headerlink" title="AI Search の設定のバックアップ/リストア方法"></a>AI Search の設定のバックアップ/リストア方法</h2><p>AI Search の設定については、以下の 2 つでそれぞれ方法が異なります。</p><ol><li>AI Search サービス</li><li>AI Search サービス内のインデックス、スキルセット、データソース、インデクサー等の設定</li></ol><p>1 と 2 の違いとしては、1 の AI Search サービスは設定を Azure Resource Manager (ARM) という管理レイヤーを利用するのに対して、<br>2 のインデックス等は、ARM を介さず AI Search サービスに対して管理リクエストを実行するという点が異なります。<br><br/><br/><br>バックアップ/リストア方法について、以下に記載します。</p><h3 id="1-AI-Search-サービス自体のバックアップ-リストア方法"><a href="#1-AI-Search-サービス自体のバックアップ-リストア方法" class="headerlink" title="1. AI Search サービス自体のバックアップ/リストア方法"></a>1. AI Search サービス自体のバックアップ/リストア方法</h3><p>AI Search サービス自体は ARM で設定を管理できるため、ARM テンプレートとパラメータを保持しておけば、ARM テンプレートとパラメータを利用して同様のリソースを作成できます。<br/></p><p>既存の AI Search サービスリソースにて、ARM テンプレートをエクスポートすることは可能ですが、以下のドキュメントに記載の通り、<br>最初から ARM テンプレート (もしくは Bicep ファイル、terraform) を利用してリソースをデプロイいただけますと幸いです。  </p><blockquote><p>エクスポートが成功するという保証はありません。 <br/><br>エクスポートは、既存のリソースを運用環境で使用できるテンプレートに変換するための信頼性の高い方法ではありません。<br/>手書きの Bicep ファイル、ARM テンプレート、または terraform を使用して、リソースを最初から作成することをお勧めします。</p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/templates/export-template-portal#limitations">制限事項</a></p><p>つまり、ARM テンプレートの構成ファイルが、設定のバックアップとなり、同様のリソースを作成 (リストア) する際に利用できるとご認識いただけますと幸いです。</p><p>以下のドキュメントにチュートリアルがございますので、参考になれば幸いです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/search/search-get-started-arm">クイック スタート: Azure Resource Manager テンプレートを使用して Azure AI Search をデプロイする</a>  </li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/templates/deploy-powershell">ARM テンプレートと Azure PowerShell を使用したリソースのデプロイ</a></li></ul><p>以下では実際に AI Search サービスを ARM テンプレートを利用してデプロイします。</p><h4 id="1-ARM-テンプレートを作成します。"><a href="#1-ARM-テンプレートを作成します。" class="headerlink" title="1. ARM テンプレートを作成します。"></a>1. ARM テンプレートを作成します。</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/search/search-get-started-arm#review-the-template">テンプレートを確認する</a> に記載のサンプル JSON もしくは、<a href="https://learn.microsoft.com/ja-jp/azure/templates/microsoft.search/searchservices?pivots=deployment-language-arm-template">AI Search ARM テンプレート定義</a> を元にファイルを編集いただき <code>azuredeploy.json</code> としてローカルに保存します。<br/><br>今回は <a href="https://learn.microsoft.com/ja-jp/azure/search/search-get-started-arm#review-the-template">テンプレートを確認する</a> に記載のサンプル JSON をそのまま使用します。</p><h4 id="2-1-で作成した-ARM-テンプレートで使用するパラメータファイルを作成します。parameters-json-として保存します。"><a href="#2-1-で作成した-ARM-テンプレートで使用するパラメータファイルを作成します。parameters-json-として保存します。" class="headerlink" title="2. 1 で作成した ARM テンプレートで使用するパラメータファイルを作成します。parameters.json として保存します。"></a>2. 1 で作成した ARM テンプレートで使用するパラメータファイルを作成します。<code>parameters.json</code> として保存します。</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/templates/parameter-files#parameter-file">パラメーター ファイル</a> 参考に、以下のようにします。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;$schema&quot;</span>: <span class="string">&quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contentVersion&quot;</span>: <span class="string">&quot;1.0.0.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;blog-search-sample&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;sku&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;basic&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;replicaCount&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;partitionCount&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;hostingMode&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;default&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;location&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;japaneast&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="3-PowerShell-でリソースグループを作成し、テンプレートをデプロイします。"><a href="#3-PowerShell-でリソースグループを作成し、テンプレートをデプロイします。" class="headerlink" title="3. PowerShell でリソースグループを作成し、テンプレートをデプロイします。"></a>3. PowerShell でリソースグループを作成し、テンプレートをデプロイします。</h4><ul><li><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/templates/deploy-powershell">ARM テンプレートと Azure PowerShell を使用したリソースのデプロイ</a> の手順が参考になれば幸いです。</p></li><li><p>リソースグループを作成します。</p></li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$rgName</span> = <span class="string">&quot;Blogsample&quot;</span></span><br><span class="line"><span class="variable">$location</span> = <span class="string">&quot;Japan East&quot;</span></span><br><span class="line"><span class="built_in">New-AzResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$rgName</span> <span class="literal">-Location</span> <span class="variable">$location</span></span><br></pre></td></tr></table></figure><ul><li>デプロイ名を設定します。</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$today</span>=<span class="built_in">Get-Date</span> <span class="literal">-Format</span> <span class="string">&quot;MM-dd-yyyy&quot;</span></span><br><span class="line"><span class="variable">$deploymentName</span>=<span class="string">&quot;ExampleDeployment&quot;</span>+<span class="string">&quot;<span class="variable">$today</span>&quot;</span></span><br></pre></td></tr></table></figure><ul><li>テンプレートを指定してデプロイします。</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-AzResourceGroupDeployment</span> `</span><br><span class="line">  <span class="literal">-Name</span> <span class="variable">$deploymentName</span> `</span><br><span class="line">  <span class="literal">-ResourceGroupName</span> <span class="variable">$rgName</span> `</span><br><span class="line">  <span class="literal">-TemplateFile</span> &lt;path\to\azuredeploy.json&gt; `</span><br><span class="line">  <span class="literal">-TemplateParameterFile</span> &lt;path\to\parameters.json&gt;</span><br></pre></td></tr></table></figure><p>以上の手順で AI Search サービスを ARM テンプレートから作成することができました。</p><h3 id="2-AI-Search-サービス内のインデックス等設定のバックアップ-リストア方法"><a href="#2-AI-Search-サービス内のインデックス等設定のバックアップ-リストア方法" class="headerlink" title="2. AI Search サービス内のインデックス等設定のバックアップ/リストア方法"></a>2. AI Search サービス内のインデックス等設定のバックアップ/リストア方法</h3><p>インデックス等も、AI Search サービスを ARM テンプレートで管理するのと同様に、REST API の要求本文を保持しておくか、SDK でリソース作成のコードを記述し、リストア用に保持しておく形になります。</p><p>例えばインデックスの場合、以下のクイックスタートを参考に、REST API の実行環境を整え、インデックスを作成します。<br>クイックスタートの手順 <a href="https://learn.microsoft.com/ja-jp/azure/search/search-get-started-rest#index-definition">インデックスの定義</a> で作成した要求本文があれば、今後インデックスを再作成やリストアする場合にそのままご利用可能となります。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/search/search-get-started-rest">クイック スタート: REST API を使用して Azure AI Search インデックスを作成する</a></li></ul><p>他にもインデクサー、データソース、スキルセットなどの作成/更新も REST API で提供されておりますので、<br>同様にご利用いただけますと幸いです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/rest/api/searchservice/create-index">インデックスの作成 (Azure AI Search REST API)</a></li><li><a href="https://learn.microsoft.com/ja-jp/rest/api/searchservice/create-indexer">インデクサーの作成 (Azure AI Search REST API)</a></li><li><a href="https://learn.microsoft.com/ja-jp/rest/api/searchservice/create-data-source">データ ソースの作成 (Azure AI Search REST API)</a></li><li><a href="https://learn.microsoft.com/ja-jp/rest/api/searchservice/create-skillset">スキルセットの作成 (Azure AI Search REST API)</a></li></ul><p>お客様によっては、プレビューの REST API をご利用の場合もあると存じます。その場合は <a href="https://learn.microsoft.com/ja-jp/rest/api/searchservice/index-preview">Search Service REST API のプレビュー</a> より、プレビューの API 仕様をご確認いただけますと幸いです。<br>また、<a href="https://learn.microsoft.com/ja-jp/rest/api/searchservice/search-service-api-versions">検索 REST API の API バージョン</a> もご確認いただき、どの API バージョンを利用するか検討いただけますと幸いです。<br/><br/></p><p>また、Azure Portal のインポートウィザードから自動的に各リソースを作成いただく場合もあると存じます。<br>その場合は、以下の手順で REST API 経由でリソースを管理するようにしていただければ、今後同様のリソースをすぐに作成することができます。<br>※以下はインデックスでの例ですが、インデクサー、データソース等も同様に実施いただけますと幸いです。<br>※ただし、データソースの場合、接続文字列等の Blob Storage や SQL Database 等にアクセスするシークレット情報は、Azure Portal から取得すると削除されている場合がございます。接続文字列等が正しいか念のためご確認いただけますと幸いです。</p><h4 id="1-Azure-Portal-で既存のインデックス定義の-JSON-を取得します。"><a href="#1-Azure-Portal-で既存のインデックス定義の-JSON-を取得します。" class="headerlink" title="1. Azure Portal で既存のインデックス定義の JSON を取得します。"></a>1. Azure Portal で既存のインデックス定義の JSON を取得します。</h4><p><img src="/jpazpaas/2024/01/25/backup-search-service/image-a7b64ac5-a0a1-4971-b83a-7da52970b429.png" alt="image-a7b64ac5-a0a1-4971-b83a-7da52970b429.png"></p><h4 id="2-JSON-内の以下の不要なプロパティを削除します。"><a href="#2-JSON-内の以下の不要なプロパティを削除します。" class="headerlink" title="2. JSON 内の以下の不要なプロパティを削除します。"></a>2. JSON 内の以下の不要なプロパティを削除します。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;@odata.context&quot;: &quot;https://&lt;search service name&gt;.search.windows.net/$metadata#indexes/$entity&quot;,</span><br><span class="line">&quot;@odata.etag&quot;: &quot;\&quot;0x8DC10B88B43FA8D\&quot;&quot;,</span><br></pre></td></tr></table></figure><h4 id="3-インデックスの作成-Azure-AI-Search-REST-API-または-インデックスの更新-Azure-AI-Search-REST-API-を元に-Postman-でリクエストを設定します。要求本文に-2-で作成した-JSON-を設定します。"><a href="#3-インデックスの作成-Azure-AI-Search-REST-API-または-インデックスの更新-Azure-AI-Search-REST-API-を元に-Postman-でリクエストを設定します。要求本文に-2-で作成した-JSON-を設定します。" class="headerlink" title="3. インデックスの作成 (Azure AI Search REST API) または インデックスの更新 (Azure AI Search REST API)を元に Postman でリクエストを設定します。要求本文に 2 で作成した JSON を設定します。"></a>3. <a href="https://learn.microsoft.com/ja-jp/rest/api/searchservice/create-index">インデックスの作成 (Azure AI Search REST API)</a> または <a href="https://learn.microsoft.com/ja-jp/rest/api/searchservice/update-index">インデックスの更新 (Azure AI Search REST API)</a>を元に Postman でリクエストを設定します。要求本文に 2 で作成した JSON を設定します。</h4><p><img src="/jpazpaas/2024/01/25/backup-search-service/image-516b7473-4fbf-4dad-9a90-765105bfc8b1.png" alt="image-516b7473-4fbf-4dad-9a90-765105bfc8b1.png"></p><h4 id="4-API-を実行し、エラーがなければ正常に作成、更新できた形になります。これで仮にインデックスが削除されても再度この要求を実施すれば同じインデックスが作成されます。"><a href="#4-API-を実行し、エラーがなければ正常に作成、更新できた形になります。これで仮にインデックスが削除されても再度この要求を実施すれば同じインデックスが作成されます。" class="headerlink" title="4. API を実行し、エラーがなければ正常に作成、更新できた形になります。これで仮にインデックスが削除されても再度この要求を実施すれば同じインデックスが作成されます。"></a>4. API を実行し、エラーがなければ正常に作成、更新できた形になります。これで仮にインデックスが削除されても再度この要求を実施すれば同じインデックスが作成されます。</h4><h2 id="インデックスデータのバックアップ-リストア方法"><a href="#インデックスデータのバックアップ-リストア方法" class="headerlink" title="インデックスデータのバックアップ/リストア方法"></a>インデックスデータのバックアップ/リストア方法</h2><p>恐れ入りますが、AI Search の機能としてインデックスデータのバックアップ/リストアする方法はございません。<br>以下のドキュメントにも記載がございます。</p><blockquote><p>インデックス管理のネイティブ サポートはありません。</p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/search/search-faq-frequently-asked-questions#--------------------------">インデックスの移動、バックアップ、復元はできますか?</a></p><p>AI Search の機能としてインデックスデータのバックアップ/リストアする方法がないのは、そもそも Blob Storage や SQL Database 等に保持されたデータを元に AI Search のインデックスデータが作成されるため、仮にインデックスデータを復元する必要がある場合は、AI Search のインデックス、インデクサー、データソース、スキルセットを再構成すれば Blob Storage や SQL Database 等からインデックスデータを再構成できるためです。<br/><br><br/><br>したがって、基本的には Blob Storage や SQL Database 等に保持されたデータがあれば、AI Search のインデックス、インデクサー、データソース、スキルセットを再構成することで、インデックスデータが復元できるため、インデックスデータを個別にバックアップいただく必要はないと認識いただけますと幸いです。<br/><br><br/><br>もちろん、お客様の状況によってはインデックスデータをバックアップする必要があると存じます。<br>その場合は、以下の FAQ に記載のサンプルコードを試していただければと存じます。<br><strong>※あくまでサンプルコードでございますので、お客様にてコードの内容を確認し動作検証いただいた上でご利用いただけますと幸いです。</strong>  </p><blockquote><p>ただし、検索サービス間でインデックスを移動する場合は、この <a href="https://github.com/Azure-Samples/azure-search-dotnet-utilities">Azure AI Search .NET サンプル リポジトリ</a>にある index-backup-restore サンプル コードを試すことができます。  </p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/search/search-faq-frequently-asked-questions#--------------------------">インデックスの移動、バックアップ、復元はできますか?</a></p><h3 id="サンプルコードの実行手順"><a href="#サンプルコードの実行手順" class="headerlink" title="サンプルコードの実行手順"></a>サンプルコードの実行手順</h3><p><a href="https://github.com/Azure-Samples/azure-search-dotnet-utilities/tree/main/index-backup-restore#run-the-sample">Run the sample</a> に詳細の記載がありますが、簡単に手順を記載いたします。<br>また、<strong>サンプルコードには、10万以上のレコードはバックアップできないなど、重要な記載がございますので、必ず <a href="https://github.com/Azure-Samples/azure-search-dotnet-utilities/blob/main/index-backup-restore/README.md#important---please-read">IMPORTANT - PLEASE READ</a> を事前にご確認いただけますと幸いです。</strong></p><h4 id="1-GitHub-からサンプルコードを開いて解凍し、index-backup-restore-v11-にあるプロジェクトを-Visual-Studio-で開きます。"><a href="#1-GitHub-からサンプルコードを開いて解凍し、index-backup-restore-v11-にあるプロジェクトを-Visual-Studio-で開きます。" class="headerlink" title="1. GitHub からサンプルコードを開いて解凍し、index-backup-restore/v11 にあるプロジェクトを Visual Studio で開きます。"></a>1. GitHub からサンプルコードを開いて解凍し、<code>index-backup-restore/v11</code> にあるプロジェクトを Visual Studio で開きます。</h4><h4 id="2-プロジェクト内のファイル-appsettings-json-を編集します。"><a href="#2-プロジェクト内のファイル-appsettings-json-を編集します。" class="headerlink" title="2. プロジェクト内のファイル appsettings.json を編集します。"></a>2. プロジェクト内のファイル <code>appsettings.json</code> を編集します。</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;SourceSearchServiceName&quot;</span>: <span class="string">&quot;&lt;バックアップする Search サービス名&gt;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;SourceAdminKey&quot;</span>: <span class="string">&quot;&lt;バックアップする Search サービスの API キー&gt;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;SourceIndexName&quot;</span>: <span class="string">&quot;&lt;バックアップするインデックス名&gt;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;TargetSearchServiceName&quot;</span>: <span class="string">&quot;&lt;リストアする Search サービス名&gt;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;TargetAdminKey&quot;</span>: <span class="string">&quot;&lt;リストアする Search サービスの API キー&gt;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;TargetIndexName&quot;</span>: <span class="string">&quot;&lt;リストアするインデックス名&gt;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;BackupDirectory&quot;</span>: <span class="string">&quot;&lt;バックアップ処理で生成されるファイルを保存するディレクトリ&gt;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-プロジェクトをビルドして、実行します。"><a href="#3-プロジェクトをビルドして、実行します。" class="headerlink" title="3. プロジェクトをビルドして、実行します。"></a>3. プロジェクトをビルドして、実行します。</h4><p>実行時に以下のようなエラーが発生する場合があります。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Search request failed: &#123;&quot;error&quot;:&#123;&quot;code&quot;:&quot;FeatureNotSupportedInApiVersion&quot;,&quot;message&quot;:&quot;This index was created with a newer version of the Azure Search API and uses features exclusive to that version. Please use the latest API version (2023-10-01-Preview) to manage this index.&quot;</span><br></pre></td></tr></table></figure><p>これは <a href="https://github.com/Azure-Samples/azure-search-dotnet-utilities/blob/main/index-backup-restore/v11/AzureSearchBackupRestoreIndex/AzureSearchHelper.cs#L25">AzureSearchBackupRestoreIndex/AzureSearchHelper.cs</a> で設定されている、AI Search サービスの REST API バージョンの値が古いことによるもので、<br>以下のようにエラーメッセージに含まれる REST API のバージョン (例: 2023-10-01-Preview) に修正することで解消する可能性があります。</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ApiVersionString = <span class="string">&quot;api-version=2023-10-01-Preview&quot;</span>;</span><br></pre></td></tr></table></figure><h4 id="4-完了するとバックアップ元とリストア先のインデックスのインデックス内のドキュメント数が以下のように表示されます。バックアップ元のインデックスのドキュメント数-36-と同数のドキュメントがリストアされたことが確認できます。"><a href="#4-完了するとバックアップ元とリストア先のインデックスのインデックス内のドキュメント数が以下のように表示されます。バックアップ元のインデックスのドキュメント数-36-と同数のドキュメントがリストアされたことが確認できます。" class="headerlink" title="4. 完了するとバックアップ元とリストア先のインデックスのインデックス内のドキュメント数が以下のように表示されます。バックアップ元のインデックスのドキュメント数 36 と同数のドキュメントがリストアされたことが確認できます。"></a>4. 完了するとバックアップ元とリストア先のインデックスのインデックス内のドキュメント数が以下のように表示されます。バックアップ元のインデックスのドキュメント数 36 と同数のドキュメントがリストアされたことが確認できます。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SAFEGUARD CHECK: Source and target index counts should match</span><br><span class="line"> Source index contains 36 docs</span><br><span class="line"> Target index contains 36 docs</span><br></pre></td></tr></table></figure><h1 id="変更履歴"><a href="#変更履歴" class="headerlink" title="変更履歴"></a>変更履歴</h1><ul><li>2025 年 5 月 12 日 追記： 2025 年 4 月時点で、価格レベルを　Basic と Standard 間で下位レベルから上位レベルに切り替えることが、プレビューで可能となった旨追記しています。</li></ul><hr><br><br><p>2025 年 05 月 12 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;AI Search では作成後にレベルの変更 (Basic から Standard 等) が一般利用可能な機能ではできない認識です。&lt;br&gt;レベルの変更等に柔軟に対応できるようにするため、AI Search の設定やインデックスデータをバックアップ/リストアする方法はありま</summary>
      
    
    
    
    
    <category term="AI Search" scheme="https://komayama.github.io/jpazpaas/tags/AI-Search/"/>
    
  </entry>
  
  <entry>
    <title>Azure App Service の計画メンテナンス通知の改善</title>
    <link href="https://komayama.github.io/jpazpaas/2025/05/07/Azure-App-Service-Notifications-Improvements.html"/>
    <id>https://komayama.github.io/jpazpaas/2025/05/07/Azure-App-Service-Notifications-Improvements.html</id>
    <published>2025-05-06T15:00:00.000Z</published>
    <updated>2026-02-24T04:33:03.136Z</updated>
    
    <content type="html"><![CDATA[<p>本記事は 2025 年 4 月 29 日に公開されました <a href="https://azure.github.io/AppService/2025/04/29/Azure-App-Service-Notifications-Improvements.html">Routine Planned Maintenance Notifications Improvements for App Service</a> の日本語訳です。</p><p>2025年4月現在、App Serviceの定期メンテナンス通知に関して大幅な改善を発表できることを嬉しく思います。</p><h1 id="最近の改善点"><a href="#最近の改善点" class="headerlink" title="最近の改善点"></a>最近の改善点</h1><p>App Serviceのお客様体験を向上させるため、メンテナンス通知システムに重要な改善を行いました。この更新は、2022年3月に発表された内容 <a href="https://azure.github.io/AppService/2022/02/01/App-Service-Planned-Notification-Feature.html">Routine Planned Maintenance Notifications for Azure App Service - Azure App Service</a> (日本語訳 <a href="https://azure.github.io/jpazpaas/2023/02/16/Routine-Planned-Maintenance-Notifications-for-Azure-App-Service.html">Azure App Service の計画メンテナンスの事前通知 - Japan PaaS Support Team Blog</a>)をさらに拡張したものです。</p><hr><h1 id="影響を受けたリソース-ブレード"><a href="#影響を受けたリソース-ブレード" class="headerlink" title="影響を受けたリソース ブレード"></a>影響を受けたリソース ブレード</h1><p>主な改善点の1つとして、Azure Service Healthに「影響を受けたリソース」ブレードが導入されました。この新機能により、お客様は影響を受けるApp Serviceプランリソースを正確に確認することができるようになりました。<br>[影響を受けたリソース] ブレードでは、メンテナンスの開始時と終了時の正確なステータス タイムスタンプを提供することで、メンテナンスの進行状況を明確かつ詳細に表示できます。このセルフサービス機能により、お客様はリソースのステータスを個別に追跡できます。</p><p>Azureポータルから確認するには、<strong>ホーム</strong> &gt; <strong>モニター</strong> &gt; <strong>サービス正常性</strong> &gt; <strong>計画メンテナンス</strong> &gt; <strong>問題名を選択</strong> &gt; <strong>影響を受けたリソース</strong> &gt; <strong>詳細情報</strong>　へとアクセスします。</p><p><img src="/jpazpaas/2025/05/07/Azure-App-Service-Notifications-Improvements/MoreInfo1-90c0f7d3-9911-4011-b995-7e20b7b0d69d.png" alt="MoreInfo1-90c0f7d3-9911-4011-b995-7e20b7b0d69d.png"></p><p>ここでは、App Serviceプラン内でアップグレードが行われているリソースとその現在の状態（保留中、開始済み、完了済み）をタイムスタンプ付きで確認できます。</p><p><img src="/jpazpaas/2025/05/07/Azure-App-Service-Notifications-Improvements/MoreInfo2-2c062b64-1a99-4471-b985-2aec9ac20cee.png" alt="MoreInfo2-2c062b64-1a99-4471-b985-2aec9ac20cee.png"></p><h1 id="自動化されたリリースノート"><a href="#自動化されたリリースノート" class="headerlink" title="自動化されたリリースノート"></a>自動化されたリリースノート</h1><p>また、自動化されたリリースノートも実装されました。お客様は、メンテナンス通知内で、最も重要な情報のみを提供する App Service リリース ノートへの自動リンクを受け取るようになりました。これにより、基本的なリリースノートに対する高い需要に対応し、お客様が重要なアップデートにアクセスできるようにします。<a href="https://github.com/Azure/AppService/releases">App Service リリース ノート</a></p><h1 id="ビジネスアワーにおけるのアップグレード停止"><a href="#ビジネスアワーにおけるのアップグレード停止" class="headerlink" title="ビジネスアワーにおけるのアップグレード停止"></a>ビジネスアワーにおけるのアップグレード停止</h1><p>もう 1 つの重要な機能強化は、、ビジネスアワーにおけるの App Service プラン リソースのアップグレードの一時停止です。メンテナンスオペレーションは、午前9時から午後5時までの標準営業時間外に開始するように最適化されています。特定のリージョンで午前 9 時までにリソースがまだアップグレード中である場合、アップグレードは安全な停止ポイントに達するまで続行され、次の重要なステップの前で一時停止し、営業時間が終了するまで待機します。このアプローチにより、ピーク時の顧客のワークロードの中断が最小限に抑えられ、より予測可能なメンテナンス スケジュールが提供されます。</p><br><br><p>2025 年 05 月 07 日時点の内容となります。<br><br>本記事の内容は予告なく変更される場合がございますので予めご了承ください。</p><br><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本記事は 2025 年 4 月 29 日に公開されました &lt;a href=&quot;https://azure.github.io/AppService/2025/04/29/Azure-App-Service-Notifications-Improvements.html&quot;&gt;Ro</summary>
      
    
    
    
    
    <category term="Function App" scheme="https://komayama.github.io/jpazpaas/tags/Function-App/"/>
    
    <category term="App Service" scheme="https://komayama.github.io/jpazpaas/tags/App-Service/"/>
    
    <category term="Web Apps" scheme="https://komayama.github.io/jpazpaas/tags/Web-Apps/"/>
    
    <category term="App Service Environment" scheme="https://komayama.github.io/jpazpaas/tags/App-Service-Environment/"/>
    
  </entry>
  
</feed>
